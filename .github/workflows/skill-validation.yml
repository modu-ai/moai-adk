name: MoAI-ADK Skill Validation

on:
  push:
    branches: [ main, develop, release-* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  skill-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for required tools
      id: check-tools
      run: |
        if [ -f ".claude/tools/skill-validator.py" ]; then
          echo "tools_exist=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Skill validation tools found"
        else
          echo "tools_exist=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è Skill validation tools not found - skipping validation"
        fi

    - name: Set up Python
      if: steps.check-tools.outputs.tools_exist == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Run skill validation
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python .claude/tools/skill-validator.py --skills-dir .claude/skills --format json --output validation-report.json

    - name: Generate compliance report
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python .claude/tools/skill-validator.py --skills-dir .claude/skills --output compliance-report.md

    - name: Upload validation artifacts
      uses: actions/upload-artifact@v4
      if: always() && steps.check-tools.outputs.tools_exist == 'true'
      with:
        name: validation-reports
        path: |
          validation-report.json
          compliance-report.md
        retention-days: 30

    - name: Comment PR with validation results
      if: github.event_name == 'pull_request' && steps.check-tools.outputs.tools_exist == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');

          try {
            const report = fs.readFileSync('compliance-report.md', 'utf8');
            const maxLength = 6000; // GitHub comment limit

            if (report.length > maxLength) {
              const truncatedReport = report.substring(0, maxLength - 200) + '\n\n... (truncated)';

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üîç Skill Validation Results\n\n${truncatedReport}\n\n[üìä View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## üîç Skill Validation Results\n\n${report}`
              });
            }
          } catch (error) {
            console.log('Could not read validation report:', error);
          }

    - name: Skip notice
      if: steps.check-tools.outputs.tools_exist != 'true'
      run: echo "‚è≠Ô∏è Skill validation skipped - tools not available"

  quality-gates:
    runs-on: ubuntu-latest
    needs: skill-validation

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for required tools
      id: check-tools
      run: |
        if [ -f ".claude/tools/quality-gate-checker.py" ]; then
          echo "tools_exist=true" >> $GITHUB_OUTPUT
        else
          echo "tools_exist=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è Quality gate tools not found - skipping"
        fi

    - name: Set up Python
      if: steps.check-tools.outputs.tools_exist == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Download validation artifacts
      if: steps.check-tools.outputs.tools_exist == 'true'
      uses: actions/download-artifact@v4
      with:
        name: validation-reports

    - name: Check compliance thresholds
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python .claude/tools/quality-gate-checker.py --report validation-report.json

    - name: Performance monitoring
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python .claude/tools/performance-monitor.py --skills-dir .claude/skills --output metrics.json

  nightly-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for required tools
      id: check-tools
      run: |
        if [ -f ".claude/tools/comprehensive-audit.py" ]; then
          echo "tools_exist=true" >> $GITHUB_OUTPUT
        else
          echo "tools_exist=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è Audit tools not found - skipping"
        fi

    - name: Set up Python
      if: steps.check-tools.outputs.tools_exist == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml requests

    - name: Run comprehensive audit
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python .claude/tools/comprehensive-audit.py --skills-dir .claude/skills --output audit-$(date +%Y-%m-%d).json

    - name: Generate trend analysis
      if: steps.check-tools.outputs.tools_exist == 'true'
      run: |
        python .claude/tools/trend-analyzer.py --current audit-$(date +%Y-%m-%d).json --baseline baseline.json --output trend-report.md

    - name: Create issue for critical issues
      if: failure() && steps.check-tools.outputs.tools_exist == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `üö® Skill Validation Audit Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The nightly skill validation audit has failed. Please review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.\n\nThis issue will be automatically closed when the audit passes.`,
            labels: ['bug', 'skill-validation', 'automated']
          });
