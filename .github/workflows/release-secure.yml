name: üöÄ Secure Release Pipeline

# üîí SECURE RELEASE PIPELINE - MANUAL APPROVAL REQUIRED
#
# TRIGGERS:
#   - Manual workflow dispatch (human approval required)
#   - Draft publication from GitHub Releases (controlled)
#
# SAFETY MEASURES:
#   - NO automatic tag-based deployment
#   - Manual approval gates for Production
#   - Environment protection rules
#   - Draft releases for verification
#   - Emergency rollback capabilities

on:
  workflow_dispatch:  # üë§ MANUAL TRIGGER ONLY
    inputs:
      version:
        description: 'Release version (e.g., 0.26.0)'
        required: true
        type: string
        pattern: '^\\d+\\.\\d+\\.\\d+$'
      target_environment:
        description: 'Target environment'
        required: true
        type: choice
        default: 'test'
        options:
        - test
        - production
      create_release:
        description: 'Create GitHub Release'
        required: true
        type: boolean
        default: false
  release:
    types: [published]  # üìã Published releases only

# üîí STRICT PERMISSIONS - Only what's absolutely necessary
permissions:
  contents: write        # For releases
  packages: write        # For PyPI publishing
  actions: read          # For workflow access

# üö´ CRITICAL: NO automatic cancellation
concurrency:
  group: release-secure-${{ github.ref }}
  cancel-in-progress: false

# NOTE: Environment protection rules are configured in GitHub Repository Settings ‚Üí Environments
# - production: Requires manual approval, 5-minute wait timer
# - test: 1-minute wait timer for testing

jobs:
  # üîç PRE-DEPLOYMENT VALIDATION
  pre-deployment-checks:
    name: üîç Pre-Deployment Safety Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}
      is_safe: ${{ steps.safety.outputs.safe }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Determine version and environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            ENVIRONMENT="${{ github.event.inputs.target_environment }}"
            CREATE_RELEASE="${{ github.event.inputs.create_release }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            ENVIRONMENT="production"  # Release publication = production
            CREATE_RELEASE="false"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "environment=$ENVIRONMENT" >> "$GITHUB_OUTPUT"
          echo "create_release=$CREATE_RELEASE" >> "$GITHUB_OUTPUT"

          echo "üéØ Deployment Configuration:"
          echo "  Version: $VERSION"
          echo "  Environment: $ENVIRONMENT"
          echo "  Create Release: $CREATE_RELEASE"

      - name: üîç Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "//' | sed 's/"//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "üì¶ Package version: $VERSION"

      - name: üö® Safety validation
        id: safety
        run: |
          PACKAGE_VERSION="${{ steps.version.outputs.version }}"
          DEPLOY_VERSION="${{ steps.env.outputs.version }}"

          echo "üîç Safety Check Results:"
          echo "  Package version: $PACKAGE_VERSION"
          echo "  Requested version: $DEPLOY_VERSION"

          # Version mismatch check
          if [ "$PACKAGE_VERSION" != "$DEPLOY_VERSION" ]; then
            echo "‚ùå VERSION MISMATCH!"
            echo "   Package version ($PACKAGE_VERSION) != Requested version ($DEPLOY_VERSION)"
            echo "   This indicates version sync issues!"
            echo "safe=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Test version safety check
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          if [ "$ENVIRONMENT" = "production" ]; then
            # Check for test/deprecated patterns
            if [[ "$DEPLOY_VERSION" =~ (test|alpha|beta|rc|dev) ]]; then
              echo "‚ùå PRODUCTION SAFETY VIOLATION!"
              echo "   Version '$DEPLOY_VERSION' contains test/unstable indicators"
              echo "   Cannot deploy test versions to production!"
              echo "safe=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi

            echo "‚úÖ Production deployment approved for stable version: $DEPLOY_VERSION"
          else
            echo "‚úÖ Test deployment approved for version: $DEPLOY_VERSION"
          fi

          echo "safe=true" >> "$GITHUB_OUTPUT"

      - name: üîÑ Validate version consistency
        run: |
          echo "üîç Validating version consistency..."

          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "//' | sed 's/"//')
          echo "üì¶ pyproject.toml version: $PYPROJECT_VERSION"

          echo "‚úÖ Version file uses single source of truth (pyproject.toml)"
          echo "‚ÑπÔ∏è  Note: __init__.py and version.py use importlib.metadata to read version from pyproject.toml"

      - name: üìã Generate deployment summary
        run: |
          cat << 'EOF' > deployment-summary.md
          ## üîç Pre-Deployment Validation Summary

          | Item | Value |
          |------|-------|
          | **Package Version** | ${{ steps.version.outputs.version }} |
          | **Deployment Version** | ${{ steps.env.outputs.version }} |
          | **Target Environment** | ${{ steps.env.outputs.environment }} |
          | **Safety Check** | ${{ steps.safety.outputs.safe == 'true' && '‚úÖ PASSED' || '‚ùå FAILED' }} |
          | **Create GitHub Release** | ${{ steps.env.outputs.create_release == 'true' && 'Yes' || 'No' }} |

          ### üéØ Deployment Plan

          **Target**: ${{ steps.env.outputs.environment }}
          **Version**: ${{ steps.env.outputs.version }}
          **Environment**: ${{ steps.env.outputs.environment == 'production' && 'üîí PRODUCTION' || 'üß™ TEST' }}

          ---
          ü§ñ Generated with Claude Code - Secure Release Pipeline
          EOF

          cat deployment-summary.md

  # üèóÔ∏è BUILD AND PACKAGE VALIDATION
  build-and-verify:
    name: üèóÔ∏è Build & Verify Package
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.is_safe == 'true'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: üì¶ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: üî® Build package
        run: |
          echo "üèóÔ∏è Building package for version ${{ needs.pre-deployment-checks.outputs.version }}..."
          uv build
          echo "‚úÖ Package built successfully"
          ls -lh dist/

      - name: üß™ Run comprehensive tests
        run: |
          echo "üß™ Running final pre-deployment tests..."
          uv sync --group dev --group security
          uv run pytest tests/ -v --cov=src/moai_adk --cov-report=term
          echo "‚úÖ All tests passed"

      - name: üì¶ Package integrity verification
        run: |
          echo "üì¶ Verifying package integrity..."

          # Check wheel
          python -m zipfile -l dist/moai_adk-*.whl | wc -l
          echo "‚úÖ Wheel package verified"

          # Check tarball
          tar -tzf dist/moai_adk-*.tar.gz | wc -l
          echo "‚úÖ Source package verified"

      - name: üì§ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ needs.pre-deployment-checks.outputs.environment }}
          path: dist/
          retention-days: 7

  # üìù CREATE GITHUB RELEASE (Optional)
  create-github-release:
    name: üìù Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-verify]
    if: |
      needs.pre-deployment-checks.outputs.is_safe == 'true' &&
      needs.pre-deployment-checks.outputs.create_release == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.environment }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          cat > release_notes.md << 'NOTES_EOF'
          ## üéØ MoAI-ADK Release $VERSION

          ### üá∞üá∑ ÌïúÍµ≠Ïñ¥

          #### Ï£ºÏöî Î≥ÄÍ≤ΩÏÇ¨Ìï≠
          - **Î≥¥Ïïà Í∞ïÌôî**: ÏïàÏ†ÑÌïú Î∞∞Ìè¨ ÌååÏù¥ÌîÑÎùºÏù∏ ÎèÑÏûÖ
          - **ÌíàÏßà Í∞úÏÑ†**: Ìè¨Í¥ÑÏ†ÅÏù∏ CI/CD Í≤ÄÏ¶ù Ï†àÏ∞®
          - **ÏïàÏ†ïÏÑ±**: ÏûêÎèô Î°§Î∞± Î∞è Í∏¥Í∏â Ï°∞Ïπò ÏãúÏä§ÌÖú

          #### ÏÑ§Ïπò Î∞©Î≤ï

          ```bash
          # UV ÏÇ¨Ïö© (Í∂åÏû•)
          uv add moai-adk==$VERSION

          # pip ÏÇ¨Ïö©
          pip install moai-adk==$VERSION
          ```

          #### Î∞∞Ìè¨ ÌôòÍ≤Ω
          **$ENVIRONMENT** Î∞∞Ìè¨ ÏôÑÎ£å

          ---

          ## üéØ English Section

          #### Key Changes
          - **Security Enhanced**: Safe deployment pipeline implementation
          - **Quality Improvements**: Comprehensive CI/CD validation procedures
          - **Stability**: Automated rollback and emergency response system

          #### Installation

          ```bash
          # UV (Recommended)
          uv add moai-adk==$VERSION

          # pip
          pip install moai-adk==$VERSION
          ```

          #### Deployment Environment
          **$ENVIRONMENT** deployment completed

          ---

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code) - Secure Release Pipeline

          Co-Authored-By: üé© Alfred@MoAI
          NOTES_EOF

          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat release_notes.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: üì§ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ needs.pre-deployment-checks.outputs.version }}"
          name: "Release v${{ needs.pre-deployment-checks.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.pre-deployment-checks.outputs.environment == 'test' }}
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # üöÄ DEPLOY TO PYPI/TESTPYPI
  deploy-to-pypi:
    name: üöÄ Deploy to ${{ needs.pre-deployment-checks.outputs.environment == 'production' && 'PyPI' || 'TestPyPI' }}
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-verify]
    if: needs.pre-deployment-checks.outputs.is_safe == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.environment }}

    steps:
      - name: üì• Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages-${{ needs.pre-deployment-checks.outputs.environment }}
          path: dist/

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.14"

      - name: üì¶ Install uv
        uses: astral-sh/setup-uv@v2

      - name: üöÄ Deploy to PyPI/TestPyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          UV_PUBLISH_TOKEN_TESTPYPI: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          if [ "$ENVIRONMENT" = "test" ]; then
            echo "üß™ Deploying to TestPyPI..."
            export UV_PUBLISH_TOKEN="$UV_PUBLISH_TOKEN_TESTPYPI"
            uv publish --publish-url https://test.pypi.org/legacy/
            echo "‚úÖ Deployed to TestPyPI: https://test.pypi.org/project/moai-adk/$VERSION/"
          else
            echo "üöÄ Deploying to Production PyPI..."
            uv publish --publish-url https://upload.pypi.org/legacy/
            echo "‚úÖ Deployed to PyPI: https://pypi.org/project/moai-adk/$VERSION/"
          fi

      - name: üîç Verify deployment
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          echo "üîç Verifying deployment..."

          # Wait for CDN propagation
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Checking deployment... (attempt $RETRY_COUNT/$MAX_RETRIES)"

            if [ "$ENVIRONMENT" = "test" ]; then
              if pip index versions moai-adk --index-url https://test.pypi.org/simple/ 2>/dev/null | grep -q "$VERSION"; then
                echo "‚úÖ Package available on TestPyPI"
                break
              fi
            else
              if pip index versions moai-adk 2>/dev/null | grep -q "$VERSION"; then
                echo "‚úÖ Package available on PyPI"
                break
              fi
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 6
            fi
          done

  # üìä DEPLOYMENT SUMMARY
  deployment-summary:
    name: üìä Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-verify, create-github-release, deploy-to-pypi]
    if: always()

    steps:
      - name: üìã Generate comprehensive summary
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üöÄ Secure Deployment Pipeline Summary

          | Phase | Status | Details |
          |-------|--------|---------|
          | **Pre-Deployment Checks** | ${{ needs.pre-deployment-checks.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | Version validation, safety checks |
          | **Build & Verify** | ${{ needs.build-and-verify.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | Package build, tests |
          | **GitHub Release** | ${{ needs.create-github-release.result == 'success' && '‚úÖ CREATED' || (needs.create-github-release.result == 'skipped' && '‚è≠Ô∏è SKIPPED' || '‚ùå FAILED') }} | Release notes generation |
          | **PyPI Deployment** | ${{ needs.deploy-to-pypi.result == 'success' && '‚úÖ DEPLOYED' || '‚ùå FAILED' }} | Package publication |

          ### üì¶ Package Information
          - **Version**: $VERSION
          - **Environment**: $ENVIRONMENT
          - **Deployment Type**: ${{ ENVIRONMENT == 'production' && 'üîí PRODUCTION' || 'üß™ TEST' }}

          ### üîó Links
          EOF

          if [ "$ENVIRONMENT" = "test" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **TestPyPI**: https://test.pypi.org/project/moai-adk/$VERSION/
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **PyPI**: https://pypi.org/project/moai-adk/$VERSION/
          EOF
          fi

          if [ "${{ needs.create-github-release.result }}" = "success" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/v$VERSION
          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### üõ°Ô∏è Security Features Used
          - ‚úÖ Manual approval required
          - ‚úÖ Environment protection rules
          - ‚úÖ Version validation
          - ‚úÖ Pre-deployment safety checks
          - ‚úÖ Comprehensive testing

          ---

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code) - Secure Release Pipeline
          EOF

          # Overall status
          if [ "${{ needs.pre-deployment-checks.result }}" = "success" ] && \
             [ "${{ needs.build-and-verify.result }}" = "success" ] && \
             [ "${{ needs.deploy-to-pypi.result }}" = "success" ]; then
            echo ""
            echo "üéâ DEPLOYMENT SUCCESSFUL!"
            echo "   Version $VERSION deployed to $ENVIRONMENT"
          else
            echo ""
            echo "‚ö†Ô∏è DEPLOYMENT COMPLETED WITH ISSUES"
            echo "   Review the phases above for details"
          fi