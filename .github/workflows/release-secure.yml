name: ðŸš€ Secure Release Pipeline

# ðŸ”’ SECURE RELEASE PIPELINE - MANUAL APPROVAL REQUIRED
#
# TRIGGERS:
#   - Manual workflow dispatch (human approval required)
#   - Draft publication from GitHub Releases (controlled)
#
# SAFETY MEASURES:
#   - NO automatic tag-based deployment
#   - Manual approval gates for Production
#   - Environment protection rules
#   - Draft releases for verification
#   - Emergency rollback capabilities

on:
  workflow_dispatch:  # ðŸ‘¤ MANUAL TRIGGER ONLY
    inputs:
      version:
        description: 'Release version (e.g., 0.26.0)'
        required: true
        type: string
        pattern: '^\\d+\\.\\d+\\.\\d+$'
      target_environment:
        description: 'Target environment'
        required: true
        type: choice
        default: 'test'
        options:
        - test
        - production
      create_release:
        description: 'Create GitHub Release'
        required: true
        type: boolean
        default: false
  release:
    types: [published]  # ðŸ“‹ Draft release publication only
    if: github.event.release.draft == false

# ðŸ”’ STRICT PERMISSIONS - Only what's absolutely necessary
permissions:
  contents: write        # For releases
  packages: write        # For PyPI publishing
  actions: read          # For workflow access

# ðŸš« CRITICAL: NO automatic cancellation
concurrency:
  group: release-secure-${{ github.ref }}
  cancel-in-progress: false

environments:
  production:
    # ðŸ”’ PRODUCTION ENVIRONMENT PROTECTION
    url: https://pypi.org/project/moai-adk/
    protection_rules:
      - type: wait_timer
        minutes: 5  # â° 5-minute delay for manual review
      - type: reviewers
        reviewers: ['modu-ai']  # ðŸ‘¥ Required approval from maintainers
  test:
    url: https://test.pypi.org/project/moai-adk/
    protection_rules:
      - type: wait_timer
        minutes: 1  # â° 1-minute delay for test environment

jobs:
  # ðŸ” PRE-DEPLOYMENT VALIDATION
  pre-deployment-checks:
    name: ðŸ” Pre-Deployment Safety Checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      environment: ${{ steps.env.outputs.environment }}
      is_safe: ${{ steps.safety.outputs.safe }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Determine version and environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            ENVIRONMENT="${{ github.event.inputs.target_environment }}"
            CREATE_RELEASE="${{ github.event.inputs.create_release }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix
            ENVIRONMENT="production"  # Release publication = production
            CREATE_RELEASE="false"
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "environment=$ENVIRONMENT" >> "$GITHUB_OUTPUT"
          echo "create_release=$CREATE_RELEASE" >> "$GITHUB_OUTPUT"

          echo "ðŸŽ¯ Deployment Configuration:"
          echo "  Version: $VERSION"
          echo "  Environment: $ENVIRONMENT"
          echo "  Create Release: $CREATE_RELEASE"

      - name: ðŸ” Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "//' | sed 's/"//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Package version: $VERSION"

      - name: ðŸš¨ Safety validation
        id: safety
        run: |
          PACKAGE_VERSION="${{ steps.version.outputs.version }}"
          DEPLOY_VERSION="${{ steps.env.outputs.version }}"

          echo "ðŸ” Safety Check Results:"
          echo "  Package version: $PACKAGE_VERSION"
          echo "  Requested version: $DEPLOY_VERSION"

          # Version mismatch check
          if [ "$PACKAGE_VERSION" != "$DEPLOY_VERSION" ]; then
            echo "âŒ VERSION MISMATCH!"
            echo "   Package version ($PACKAGE_VERSION) != Requested version ($DEPLOY_VERSION)"
            echo "   This indicates version sync issues!"
            echo "safe=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Test version safety check
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          if [ "$ENVIRONMENT" = "production" ]; then
            # Check for test/deprecated patterns
            if [[ "$DEPLOY_VERSION" =~ (test|alpha|beta|rc|dev) ]]; then
              echo "âŒ PRODUCTION SAFETY VIOLATION!"
              echo "   Version '$DEPLOY_VERSION' contains test/unstable indicators"
              echo "   Cannot deploy test versions to production!"
              echo "safe=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi

            echo "âœ… Production deployment approved for stable version: $DEPLOY_VERSION"
          else
            echo "âœ… Test deployment approved for version: $DEPLOY_VERSION"
          fi

          echo "safe=true" >> "$GITHUB_OUTPUT"

      - name: ðŸ“‹ Generate deployment summary
        run: |
          cat << 'EOF' > deployment-summary.md
          ## ðŸ” Pre-Deployment Validation Summary

          | Item | Value |
          |------|-------|
          | **Package Version** | ${{ steps.version.outputs.version }} |
          | **Deployment Version** | ${{ steps.env.outputs.version }} |
          | **Target Environment** | ${{ steps.env.outputs.environment }} |
          | **Safety Check** | ${{ steps.safety.outputs.safe == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }} |
          | **Create GitHub Release** | ${{ steps.env.outputs.create_release == 'true' && 'Yes' || 'No' }} |

          ### ðŸŽ¯ Deployment Plan

          **Target**: ${{ steps.env.outputs.environment }}
          **Version**: ${{ steps.env.outputs.version }}
          **Environment**: ${{ steps.env.outputs.environment == 'production' && 'ðŸ”’ PRODUCTION' || 'ðŸ§ª TEST' }}

          ---
          ðŸ¤– Generated with Claude Code - Secure Release Pipeline
          EOF

          cat deployment-summary.md

  # ðŸ—ï¸ BUILD AND PACKAGE VALIDATION
  build-and-verify:
    name: ðŸ—ï¸ Build & Verify Package
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.is_safe == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ”¨ Build package
        run: |
          echo "ðŸ—ï¸ Building package for version ${{ needs.pre-deployment-checks.outputs.version }}..."
          uv build
          echo "âœ… Package built successfully"
          ls -lh dist/

      - name: ðŸ§ª Run comprehensive tests
        run: |
          echo "ðŸ§ª Running final pre-deployment tests..."
          uv sync --group dev --group security
          uv run pytest tests/ -v --cov=src/moai_adk --cov-report=term
          echo "âœ… All tests passed"

      - name: ðŸ“¦ Package integrity verification
        run: |
          echo "ðŸ“¦ Verifying package integrity..."

          # Check wheel
          python -m zipfile -l dist/moai_adk-*.whl | wc -l
          echo "âœ… Wheel package verified"

          # Check tarball
          tar -tzf dist/moai_adk-*.tar.gz | wc -l
          echo "âœ… Source package verified"

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ needs.pre-deployment-checks.outputs.environment }}
          path: dist/
          retention-days: 7

  # ðŸ“ CREATE GITHUB RELEASE (Optional)
  create-github-release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-verify]
    if: |
      needs.pre-deployment-checks.outputs.is_safe == 'true' &&
      needs.pre-deployment-checks.outputs.create_release == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.environment }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          cat > release_notes.md << 'NOTES_EOF'
          ## ðŸŽ¯ MoAI-ADK Release $VERSION

          ### ðŸ‡°ðŸ‡· í•œêµ­ì–´

          #### ì£¼ìš” ë³€ê²½ì‚¬í•­
          - **ë³´ì•ˆ ê°•í™”**: ì•ˆì „í•œ ë°°í¬ íŒŒì´í”„ë¼ì¸ ë„ìž…
          - **í’ˆì§ˆ ê°œì„ **: í¬ê´„ì ì¸ CI/CD ê²€ì¦ ì ˆì°¨
          - **ì•ˆì •ì„±**: ìžë™ ë¡¤ë°± ë° ê¸´ê¸‰ ì¡°ì¹˜ ì‹œìŠ¤í…œ

          #### ì„¤ì¹˜ ë°©ë²•

          ```bash
          # UV ì‚¬ìš© (ê¶Œìž¥)
          uv add moai-adk==$VERSION

          # pip ì‚¬ìš©
          pip install moai-adk==$VERSION
          ```

          #### ë°°í¬ í™˜ê²½
          **$ENVIRONMENT** ë°°í¬ ì™„ë£Œ

          ---

          ## ðŸŽ¯ English Section

          #### Key Changes
          - **Security Enhanced**: Safe deployment pipeline implementation
          - **Quality Improvements**: Comprehensive CI/CD validation procedures
          - **Stability**: Automated rollback and emergency response system

          #### Installation

          ```bash
          # UV (Recommended)
          uv add moai-adk==$VERSION

          # pip
          pip install moai-adk==$VERSION
          ```

          #### Deployment Environment
          **$ENVIRONMENT** deployment completed

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code) - Secure Release Pipeline

          Co-Authored-By: ðŸŽ© Alfred@MoAI
          NOTES_EOF

          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat release_notes.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¤ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ needs.pre-deployment-checks.outputs.version }}"
          name: "Release v${{ needs.pre-deployment-checks.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.pre-deployment-checks.outputs.environment == 'test' }}
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸš€ DEPLOY TO PYPI/TESTPYPI
  deploy-to-pypi:
    name: ðŸš€ Deploy to ${{ needs.pre-deployment-checks.outputs.environment == 'production' && 'PyPI' || 'TestPyPI' }}
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-verify]
    if: needs.pre-deployment-checks.outputs.is_safe == 'true'
    environment: ${{ needs.pre-deployment-checks.outputs.environment }}

    steps:
      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages-${{ needs.pre-deployment-checks.outputs.environment }}
          path: dist/

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2

      - name: ðŸš€ Deploy to PyPI/TestPyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          UV_PUBLISH_TOKEN_TESTPYPI: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          if [ "$ENVIRONMENT" = "test" ]; then
            echo "ðŸ§ª Deploying to TestPyPI..."
            export UV_PUBLISH_TOKEN="$UV_PUBLISH_TOKEN_TESTPYPI"
            uv publish --publish-url https://test.pypi.org/legacy/
            echo "âœ… Deployed to TestPyPI: https://test.pypi.org/project/moai-adk/$VERSION/"
          else
            echo "ðŸš€ Deploying to Production PyPI..."
            uv publish --publish-url https://upload.pypi.org/legacy/
            echo "âœ… Deployed to PyPI: https://pypi.org/project/moai-adk/$VERSION/"
          fi

      - name: ðŸ” Verify deployment
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          echo "ðŸ” Verifying deployment..."

          # Wait for CDN propagation
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Checking deployment... (attempt $RETRY_COUNT/$MAX_RETRIES)"

            if [ "$ENVIRONMENT" = "test" ]; then
              if pip index versions moai-adk --index-url https://test.pypi.org/simple/ 2>/dev/null | grep -q "$VERSION"; then
                echo "âœ… Package available on TestPyPI"
                break
              fi
            else
              if pip index versions moai-adk 2>/dev/null | grep -q "$VERSION"; then
                echo "âœ… Package available on PyPI"
                break
              fi
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 6
            fi
          done

  # ðŸ“Š DEPLOYMENT SUMMARY
  deployment-summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, build-and-verify, create-github-release, deploy-to-pypi]
    if: always()

    steps:
      - name: ðŸ“‹ Generate comprehensive summary
        run: |
          VERSION="${{ needs.pre-deployment-checks.outputs.version }}"
          ENVIRONMENT="${{ needs.pre-deployment-checks.outputs.environment }}"

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Secure Deployment Pipeline Summary

          | Phase | Status | Details |
          |-------|--------|---------|
          | **Pre-Deployment Checks** | ${{ needs.pre-deployment-checks.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Version validation, safety checks |
          | **Build & Verify** | ${{ needs.build-and-verify.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Package build, tests |
          | **GitHub Release** | ${{ needs.create-github-release.result == 'success' && 'âœ… CREATED' || (needs.create-github-release.result == 'skipped' && 'â­ï¸ SKIPPED' || 'âŒ FAILED') }} | Release notes generation |
          | **PyPI Deployment** | ${{ needs.deploy-to-pypi.result == 'success' && 'âœ… DEPLOYED' || 'âŒ FAILED' }} | Package publication |

          ### ðŸ“¦ Package Information
          - **Version**: $VERSION
          - **Environment**: $ENVIRONMENT
          - **Deployment Type**: ${{ ENVIRONMENT == 'production' && 'ðŸ”’ PRODUCTION' || 'ðŸ§ª TEST' }}

          ### ðŸ”— Links
          EOF

          if [ "$ENVIRONMENT" = "test" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **TestPyPI**: https://test.pypi.org/project/moai-adk/$VERSION/
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **PyPI**: https://pypi.org/project/moai-adk/$VERSION/
          EOF
          fi

          if [ "${{ needs.create-github-release.result }}" = "success" ]; then
            cat >> $GITHUB_STEP_SUMMARY << EOF
          - **GitHub Release**: https://github.com/${{ github.repository }}/releases/tag/v$VERSION
          EOF
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### ðŸ›¡ï¸ Security Features Used
          - âœ… Manual approval required
          - âœ… Environment protection rules
          - âœ… Version validation
          - âœ… Pre-deployment safety checks
          - âœ… Comprehensive testing

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code) - Secure Release Pipeline
          EOF

          # Overall status
          if [ "${{ needs.pre-deployment-checks.result }}" = "success" ] && \
             [ "${{ needs.build-and-verify.result }}" = "success" ] && \
             [ "${{ needs.deploy-to-pypi.result }}" = "success" ]; then
            echo ""
            echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
            echo "   Version $VERSION deployed to $ENVIRONMENT"
          else
            echo ""
            echo "âš ï¸ DEPLOYMENT COMPLETED WITH ISSUES"
            echo "   Review the phases above for details"
          fi