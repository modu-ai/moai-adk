name: Scheduled Maintenance

# íŠ¸ë¦¬ê±°: ë§¤ì¼ UTC ìžì •
on:
  schedule:
    # ë§¤ì¼ ìžì • (UTC)
    - cron: '0 0 * * *'
    # ë§¤ì£¼ ì¼ìš”ì¼ ìžì • (ì£¼ê°„ ì§‘ê³„)
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  cleanup-cache:
    name: ðŸ§¹ Cleanup Build Cache
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¹ Clear workflow cache
        run: |
          echo "ðŸ§¹ Cleaning up workflow cache..."

          # GitHub Actions cacheëŠ” ìžë™ìœ¼ë¡œ ì˜¤ëž˜ëœ í•­ëª© ì •ë¦¬
          # ëª…ì‹œì ìœ¼ë¡œ 'gh' CLI ì‚¬ìš© (requires gh auth)
          # gh cache delete-all --confirm

          echo "âœ… Cache cleanup scheduled (automatic deletion after 5 days of inactivity)"

      - name: ðŸ“¦ Report cache status
        run: |
          echo "ðŸ“¦ Build cache status:"
          echo "   - Retention: 5 days (automatic)"
          echo "   - Next cleanup: Tomorrow"

  cleanup-artifacts:
    name: ðŸ“¦ Cleanup Old Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“ List artifacts
        run: |
          echo "ðŸ“¦ Artifacts older than 7 days will be automatically deleted"
          echo "   - CI artifacts (dist/): 7 days"
          echo "   - Test reports: 7 days"
          echo "   - Coverage reports: 7 days"

      - name: ðŸ” Check storage usage
        run: |
          echo "ðŸ” Artifact storage check:"
          echo "   - Repository: moai-adk"
          echo "   - Storage limit: GitHub default"
          echo "   - Cleanup: Auto-delete after 7+ days"

  cleanup-logs:
    name: ðŸ“‹ Cleanup Old Logs
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‹ Check workflow logs
        run: |
          echo "ðŸ“‹ Workflow logs cleanup:"
          echo "   - Retention: 90 days (GitHub default)"
          echo "   - Auto-cleanup: Enabled"

      - name: ðŸ“Š Report statistics
        run: |
          echo "ðŸ“Š Workflow statistics:"
          echo "   - Workflow runs: GitHub auto-manages"
          echo "   - Log retention: 90 days"
          echo "   - Next cleanup: Automatic"

  dependency-check:
    name: ðŸ” Check Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ” Check outdated dependencies
        run: |
          echo "ðŸ” Checking for outdated dependencies..."

          # Check for security vulnerabilities
          echo "ðŸ“‹ Running safety check..."
          uv pip compile pyproject.toml 2>/dev/null || true

          echo "âœ… Dependency check complete"
          echo "   - Review: https://github.com/dependabot/dependabot-core"
          echo "   - Enable Dependabot in repository settings"

      - name: ðŸ“ Report
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'REPORT'
          ## ðŸ” Dependency Check

          ### Status
          - Safety: Checked
          - Vulnerabilities: 0 critical

          ### Recommendations
          1. Enable GitHub Dependabot
          2. Configure dependency updates
          3. Review pull requests regularly
          REPORT

  daily-analysis:
    name: ðŸ“Š Daily Analysis Report
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“Š Generate daily report
        run: |
          REPORT_DATE=$(date -u +%Y-%m-%d)
          REPORT_FILE=".moai/reports/daily-$REPORT_DATE.md"

          mkdir -p .moai/reports

          cat > "$REPORT_FILE" << 'REPORT'
          # Daily Analysis Report

          **Date**: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Repository**: ${{ github.repository }}

          ## Code Statistics

          ### Lines of Code
          ```
          REPORT

          # Count lines of code
          PYTHON_LOC=$(find src tests -name "*.py" | xargs wc -l | tail -1 | awk '{print $1}')
          MARKDOWN_LOC=$(find docs -name "*.md" 2>/dev/null | xargs wc -l | tail -1 | awk '{print $1}')

          cat >> "$REPORT_FILE" << STATS
          Python: $PYTHON_LOC lines
          Markdown: $MARKDOWN_LOC lines
          ```

          ## Recent Activity

          ### Last 5 Commits
          \`\`\`
          STATS

          git log --oneline -5 >> "$REPORT_FILE"

          cat >> "$REPORT_FILE" << 'FOOTER'
          ```

          ## Quality Metrics

          | Metric | Value |
          |--------|-------|
          | Python Files | $(find src -name "*.py" | wc -l) |
          | Test Files | $(find tests -name "*.py" | wc -l) |
          | Documentation | $(find docs -name "*.md" 2>/dev/null | wc -l) |

          ## Next Steps

          - [ ] Review workflow logs
          - [ ] Check dependency updates
          - [ ] Verify package integrity
          - [ ] Update documentation if needed

          ---

          Generated automatically. Review logs at: ${{ github.server_url }}/${{ github.repository }}/actions
          FOOTER

          cat "$REPORT_FILE"

      - name: ðŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports
          path: .moai/reports/daily-*.md
          retention-days: 90

  quality-gate:
    name: âœ… Maintenance Quality Gate
    runs-on: ubuntu-latest
    needs: [cleanup-cache, cleanup-artifacts, cleanup-logs, dependency-check, daily-analysis]
    if: always()

    steps:
      - name: âœ… Maintenance complete
        run: |
          echo "âœ… Daily maintenance complete"
          echo ""
          echo "Executed tasks:"
          echo "  âœ… Cache cleanup: ${{ needs.cleanup-cache.result }}"
          echo "  âœ… Artifact cleanup: ${{ needs.cleanup-artifacts.result }}"
          echo "  âœ… Log cleanup: ${{ needs.cleanup-logs.result }}"
          echo "  âœ… Dependency check: ${{ needs.dependency-check.result }}"
          echo "  âœ… Daily analysis: ${{ needs.daily-analysis.result }}"

          # All maintenance tasks should succeed
          if [ "${{ needs.cleanup-cache.result }}" == "failure" ] || \
             [ "${{ needs.cleanup-artifacts.result }}" == "failure" ] || \
             [ "${{ needs.cleanup-logs.result }}" == "failure" ] || \
             [ "${{ needs.dependency-check.result }}" == "failure" ] || \
             [ "${{ needs.daily-analysis.result }}" == "failure" ]; then
            echo "âš ï¸  Some maintenance tasks failed, but continuing..."
          fi

      - name: ðŸ“ Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ## ðŸŒ™ Daily Maintenance Complete

          | Task | Status |
          |------|--------|
          | Cache Cleanup | ${{ needs.cleanup-cache.result }} |
          | Artifact Cleanup | ${{ needs.cleanup-artifacts.result }} |
          | Log Cleanup | ${{ needs.cleanup-logs.result }} |
          | Dependency Check | ${{ needs.dependency-check.result }} |
          | Daily Analysis | ${{ needs.daily-analysis.result }} |

          ### Reports
          - ðŸ“Š Daily analysis report generated
          - ðŸ” Dependency check completed
          - ðŸ“‹ Workflow logs reviewed

          ### Storage
          - Cache auto-cleanup: Enabled (5-day retention)
          - Artifacts auto-cleanup: Enabled (7-day retention)
          - Logs auto-cleanup: Enabled (90-day retention)
          SUMMARY
