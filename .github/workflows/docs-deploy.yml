name: Deploy Documentation to Vercel (Nextra)

# GitFlow Strategy:
# - main branch â†’ Production (adk.mo.ai.kr)
# - develop branch â†’ Preview deployment
# Next.js/Nextra optimized pipeline with quality gates
on:
  push:
    branches:
      - main
      - develop
    paths:
      - "docs/**"
      - ".github/workflows/docs-deploy.yml"

env:
  NODE_VERSION: "18.17"
  CACHE_NAME_PREFIX: "nextra-docs"

concurrency:
  group: docs-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Phase 1: Code Quality & Type Checking
  quality-check:
    name: ğŸ” Code Quality & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./docs

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ” TypeScript type checking
        run: npx tsc --noEmit
        continue-on-error: false

      - name: ğŸ¨ ESLint verification
        run: npm run lint -- --max-warnings 0
        continue-on-error: true

  # Phase 2: Build & Validation
  build-and-validate:
    name: ğŸ—ï¸ Build & Validate
    runs-on: ubuntu-latest
    needs: quality-check
    defaults:
      run:
        working-directory: ./docs

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build Nextra documentation
        run: |
          echo "ğŸš€ Building MoAI-ADK Documentation with Nextra..."
          npm run build

      - name: ğŸ“Š Build Statistics
        run: |
          echo "ğŸ“ˆ Build Output Analysis:"
          echo ""
          echo "Next.js Build Directory:"
          du -sh .next || echo "âš ï¸ .next directory not found"
          echo ""

          if [ -d ".next/static" ]; then
            echo "âœ… Static files generated:"
            find .next/static -type f | wc -l | xargs echo "   Files:"
            du -sh .next/static | awk '{print "   Size: " $1}'
          fi

      - name: ğŸŒ Validate multilingual structure
        run: |
          echo "ğŸŒ Multilingual Pages Validation:"
          echo ""

          locales=("ko" "en" "ja" "zh")
          for locale in "${locales[@]}"; do
            if [ -d "pages/$locale" ]; then
              count=$(find pages/$locale -type f \( -name "*.md" -o -name "*.mdx" \) | wc -l)
              echo "  âœ… $locale: $count files"
            else
              echo "  âš ï¸ $locale: directory not found"
            fi
          done

      - name: âœ… Verify build output
        run: |
          echo "ğŸ” Build Quality Verification:"
          echo ""

          # Check if .next directory exists
          if [ -d ".next" ]; then
            echo "  âœ… .next directory created"
          else
            echo "  âŒ .next directory missing"
            exit 1
          fi

          # Check for next.config.cjs
          if [ -f "next.config.cjs" ]; then
            echo "  âœ… next.config.cjs present"
          else
            echo "  âŒ next.config.cjs missing"
            exit 1
          fi

          # Check for theme config
          if [ -f "theme.config.tsx" ]; then
            echo "  âœ… theme.config.tsx present"
          else
            echo "  âŒ theme.config.tsx missing"
            exit 1
          fi

          # Check for pages directory
          if [ -d "pages" ]; then
            file_count=$(find pages -type f \( -name "*.md" -o -name "*.mdx" \) | wc -l)
            echo "  âœ… pages directory: $file_count markdown files"
          else
            echo "  âŒ pages directory missing"
            exit 1
          fi

      - name: ğŸ“¦ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: nextra-build-${{ github.sha }}
          path: docs/.next
          retention-days: 7

  # Phase 3: Deploy to Vercel
  deploy:
    name: ğŸš€ Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build-and-validate
    defaults:
      run:
        working-directory: ./docs

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: docs/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ğŸ—ï¸ Build documentation (cached)
        run: npm run build

      - name: ğŸš€ Deploy to Vercel (Production)
        id: deploy-prod
        if: github.ref == 'refs/heads/main'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./docs
          vercel-args: '--prod'
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: ğŸ” Deploy to Vercel (Preview)
        id: deploy-preview
        if: github.ref == 'refs/heads/develop'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./docs
          scope: ${{ secrets.VERCEL_ORG_ID }}

      - name: ğŸ“ Production Deployment Summary
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "âœ… Production Deployment Successful!"
          echo ""
          echo "ğŸ“Š Deployment Details:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: main (production)"
          echo "  â€¢ Commit SHA: ${{ github.sha }}"
          echo "  â€¢ Commit Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "ğŸŒ Production URLs:"
          echo "  ğŸ‡°ğŸ‡· Korean (Default): https://adk.mo.ai.kr"
          echo "  ğŸ‡ºğŸ‡¸ English: https://adk.mo.ai.kr/en"
          echo "  ğŸ‡¯ğŸ‡µ Japanese: https://adk.mo.ai.kr/ja"
          echo "  ğŸ‡¨ğŸ‡³ Chinese: https://adk.mo.ai.kr/zh"
          echo ""
          echo "â±ï¸ Deployment completed at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

      - name: ğŸ“ Preview Deployment Summary
        if: github.ref == 'refs/heads/develop' && success()
        run: |
          echo "âœ… Preview Deployment Successful!"
          echo ""
          echo "ğŸ“Š Deployment Details:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: develop (preview)"
          echo "  â€¢ Commit SHA: ${{ github.sha }}"
          echo "  â€¢ Commit Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "ğŸŒ Preview URLs:"
          PREVIEW_URL="${{ steps.deploy-preview.outputs.preview-url }}"
          echo "  ğŸ‡°ğŸ‡· Korean (Default): $PREVIEW_URL"
          echo "  ğŸ‡ºğŸ‡¸ English: $PREVIEW_URL/en"
          echo "  ğŸ‡¯ğŸ‡µ Japanese: $PREVIEW_URL/ja"
          echo "  ğŸ‡¨ğŸ‡³ Chinese: $PREVIEW_URL/zh"
          echo ""
          echo "â±ï¸ Deployment completed at: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

  # Phase 4: Notification on Failure
  failure-notification:
    name: âŒ Deployment Failed
    runs-on: ubuntu-latest
    if: failure()
    needs: [quality-check, build-and-validate, deploy]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“‹ Generate failure report
        run: |
          echo "âŒ Documentation Deployment Failed!"
          echo ""
          echo "ğŸ” Debug Information:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Commit SHA: ${{ github.sha }}"
          echo "  â€¢ Triggered by: ${{ github.event_name }}"
          echo ""
          echo "ğŸ“Œ Check the workflow run:"
          echo "  https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸš¨ Next Steps:"
          echo "  1. Review the logs above"
          echo "  2. Check Node.js version compatibility"
          echo "  3. Verify environment variables are set"
          echo "  4. Ensure all markdown files are valid"