name: Deploy Documentation to Vercel

# GitFlow Strategy:
# - main branch â†’ Production (adk.mo.ai.kr)
# - develop branch â†’ Preview deployment
on:
  push:
    branches:
      - main
      - develop
    paths:
      - "docs/**"
      - ".github/workflows/docs-deploy.yml"

jobs:
  deploy:
    name: ğŸ“š Deploy Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "docs/pyproject.toml"

      - name: ğŸ—ï¸ Build documentation
        run: |
          cd docs
          echo "ğŸš€ Building MoAI-ADK Documentation..."
          uv sync
          uv run mkdocs build

          # Build stats
          echo "ğŸ“Š Build Statistics:"
          echo "HTML files: $(find site -name "*.html" | wc -l)"
          echo "Total size: $(du -sh site | cut -f1)"

          # Verify multilingual structure
          echo ""
          echo "ğŸŒ Multilingual Structure:"
          for lang in "" en ja zh; do
            if [ -n "$lang" ]; then
              count=$(find site/$lang -name "*.html" 2>/dev/null | wc -l)
              echo "  $lang: $count HTML files"
            else
              count=$(find site -maxdepth 1 -name "*.html" | wc -l)
              echo "  Korean (default): $count HTML files"
            fi
          done

      - name: ğŸ” Verify build quality
        run: |
          cd docs

          # Check critical files exist
          critical_files=("site/index.html" "site/sitemap.xml")
          for file in "${critical_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done

          # Check file sizes (should be reasonable)
          index_size=$(stat -f%z "site/index.html" 2>/dev/null || stat -c%s "site/index.html" 2>/dev/null || echo 0)
          if [ "$index_size" -gt 1000 ]; then
            echo "âœ… Index.html size: $index_size bytes"
          else
            echo "âŒ Index.html too small: $index_size bytes"
            exit 1
          fi

          # Check for CSS/JS assets
          if [ -d "site/assets" ]; then
            asset_count=$(find site/assets -type f | wc -l)
            echo "âœ… Assets directory: $asset_count files"
          else
            echo "âŒ Assets directory missing"
            exit 1
          fi

      - name: ğŸš€ Deploy to Vercel (Production)
        id: deploy-prod
        if: github.ref == 'refs/heads/main'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./docs
          vercel-args: '--prod'

      - name: ğŸ” Deploy to Vercel (Preview)
        id: deploy-preview
        if: github.ref == 'refs/heads/develop'
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: ./docs

      - name: ğŸ”— Production Deployment Complete
        if: github.ref == 'refs/heads/main' && success()
        run: |
          echo "ğŸ‰ Production deployment complete!"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: main (production)"
          echo "  â€¢ Commit: ${{ github.sha }}"
          echo "  â€¢ Production URL: https://adk.mo.ai.kr"
          echo ""
          echo "ğŸŒ Multilingual URLs:"
          echo "  ğŸ‡°ğŸ‡· Korean: https://adk.mo.ai.kr/"
          echo "  ğŸ‡ºğŸ‡¸ English: https://adk.mo.ai.kr/en/"
          echo "  ğŸ‡¯ğŸ‡µ Japanese: https://adk.mo.ai.kr/ja/"
          echo "  ğŸ‡¨ğŸ‡³ Chinese: https://adk.mo.ai.kr/zh/"

      - name: ğŸ”— Preview Deployment Complete
        if: github.ref == 'refs/heads/develop' && success()
        run: |
          echo "ğŸ” Preview deployment complete!"
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: develop (preview)"
          echo "  â€¢ Commit: ${{ github.sha }}"
          echo "  â€¢ Preview URL: ${{ steps.deploy-preview.outputs.preview-url }}"
          echo ""
          echo "ğŸŒ Multilingual Preview URLs:"
          echo "  ğŸ‡°ğŸ‡· Korean: ${{ steps.deploy-preview.outputs.preview-url }}/"
          echo "  ğŸ‡ºğŸ‡¸ English: ${{ steps.deploy-preview.outputs.preview-url }}/en/"
          echo "  ğŸ‡¯ğŸ‡µ Japanese: ${{ steps.deploy-preview.outputs.preview-url }}/ja/"
          echo "  ğŸ‡¨ğŸ‡³ Chinese: ${{ steps.deploy-preview.outputs.preview-url }}/zh/"

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "âŒ Documentation deployment failed!"
          echo ""
          echo "ğŸ” Debug information:"
          echo "  â€¢ Repository: ${{ github.repository }}"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Commit: ${{ github.sha }}"
          echo ""
          echo "Check the logs above for details."