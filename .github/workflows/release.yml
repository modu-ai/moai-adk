name: Release & Deploy to PyPI

# íŠ¸ë¦¬ê±°: ë²„ì „ íƒœê·¸ê°€ í‘¸ì‹œë˜ì—ˆì„ ë•Œ (release eventì˜ ì‹ ë¢°ì„± ë¬¸ì œ í•´ê²°)
# ì§€ì›í•˜ëŠ” íƒœê·¸ íŒ¨í„´:
#   - v1.2.3           â†’ PyPI ë°°í¬ (í”„ë¡œë•ì…˜)
#   - v1.2.3-test      â†’ TestPyPI ë°°í¬ (í…ŒìŠ¤íŠ¸)
on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-test"

jobs:
  deploy:
    name: ğŸ“¦ Deploy to PyPI
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ğŸ”¨ Build package
        run: |
          echo "ğŸ—ï¸  Building package..."
          uv build
          echo "âœ… Package built successfully"
          ls -lh dist/

      - name: ğŸš€ Publish to PyPI or TestPyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          UV_PUBLISH_TOKEN_TESTPYPI: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"

          # ë°°í¬ ëŒ€ìƒ ê²°ì • (-test suffix í™•ì¸)
          if [[ "$TAG" == *"-test" ]]; then
              # TestPyPI ë°°í¬
              echo "ğŸ§ª Publishing to TestPyPI (test mode)..."

              if [ -z "$UV_PUBLISH_TOKEN_TESTPYPI" ]; then
                  echo "âš ï¸  TestPyPI token not configured in secrets"
                  echo "â†’ Configure TESTPYPI_API_TOKEN in GitHub Actions secrets"
                  echo "â†’ Skipping TestPyPI deployment"
                  exit 0
              fi

              export UV_PUBLISH_TOKEN="$UV_PUBLISH_TOKEN_TESTPYPI"
              uv publish --publish-url https://test.pypi.org/legacy/
              echo "âœ… Package published to TestPyPI successfully"
              echo "â†’ Test installation: pip install --index-url https://test.pypi.org/simple/ moai-adk==${VERSION%-test}"
          else
              # ì‹¤ì œ PyPI ë°°í¬
              echo "ğŸ“¤ Publishing to PyPI (production)..."

              if [ -z "$UV_PUBLISH_TOKEN" ]; then
                  echo "âŒ PyPI token not configured in secrets"
                  echo "â†’ Configure PYPI_API_TOKEN in GitHub Actions secrets"
                  exit 1
              fi

              uv publish --publish-url https://upload.pypi.org/legacy/
              echo "âœ… Package published to PyPI successfully"
          fi

      - name: ğŸ” Verify PyPI or TestPyPI deployment
        run: |
          # íƒœê·¸ì—ì„œ ë²„ì „ ì¶”ì¶œ
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          VERSION="${VERSION%-test}"  # Remove -test suffix for version check

          # ë°°í¬ ëŒ€ìƒ ê²°ì •
          if [[ "$TAG" == *"-test" ]]; then
              echo "ğŸ§ª Verifying TestPyPI deployment (moai-adk==$VERSION)..."
              PYPI_URL="https://test.pypi.org/simple/"
              PYPI_NAME="TestPyPI"
          else
              echo "ğŸ“¦ Verifying PyPI deployment (moai-adk==$VERSION)..."
              PYPI_URL="https://pypi.org/simple/"
              PYPI_NAME="PyPI"
          fi

          # Wait for PyPI/TestPyPI CDN propagation (max 50 seconds)
          MAX_RETRIES=10
          RETRY_COUNT=0
          PACKAGE_FOUND=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Checking $PYPI_NAME... (attempt $RETRY_COUNT/$MAX_RETRIES)"

            if [[ "$TAG" == *"-test" ]]; then
              # TestPyPI verification
              if pip index versions moai-adk --index-url "$PYPI_URL" 2>/dev/null | grep -q "$VERSION"; then
                echo "âœ… Package available on TestPyPI: moai-adk==$VERSION"
                PACKAGE_FOUND=true
                break
              fi
            else
              # PyPI verification
              if pip index versions moai-adk 2>/dev/null | grep -q "$VERSION"; then
                echo "âœ… Package available on PyPI: moai-adk==$VERSION"
                PACKAGE_FOUND=true
                break
              fi
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 5
            fi
          done

          if [ "$PACKAGE_FOUND" = "false" ]; then
            echo "âš ï¸  Package not found on $PYPI_NAME after 50 seconds"
            if [[ "$TAG" == *"-test" ]]; then
              echo "â†’ Manual check: https://test.pypi.org/project/moai-adk/$VERSION/"
            else
              echo "â†’ Manual check: https://pypi.org/project/moai-adk/$VERSION/"
            fi
            echo "â†’ This may be due to CDN propagation delay. Check again in a few minutes."
          fi

          # Test installation in temporary environment
          echo ""
          echo "ğŸ“¦ Testing installation..."

          TEMP_VENV="/tmp/moai-adk-verify-$VERSION"
          python -m venv "$TEMP_VENV"
          source "$TEMP_VENV/bin/activate"

          # Install package without cache
          pip install moai-adk==$VERSION --no-cache-dir 2>&1 | tail -5

          # Verify installation
          if moai-adk --version 2>/dev/null | grep -q "$VERSION"; then
            echo "âœ… Installation verification passed"
            echo "   Installed version: $(moai-adk --version)"
          else
            echo "âŒ Installation verification failed"
            INSTALLED=$(moai-adk --version 2>/dev/null || echo "unknown")
            echo "   Expected: $VERSION"
            echo "   Got: $INSTALLED"
            deactivate
            rm -rf "$TEMP_VENV"
            exit 1
          fi

          # Cleanup
          deactivate
          rm -rf "$TEMP_VENV"
          echo "âœ… Cleanup complete"

      - name: âœ¨ Deployment complete
        run: |
          echo "ğŸ‰ Release deployment complete!"
          echo ""
          echo "ğŸ“¦ Package: moai-adk"
          echo "ğŸ·ï¸  Release: ${{ github.ref }}"
          echo "ğŸ”— PyPI: https://pypi.org/project/moai-adk/${{ github.ref_name }}/"
