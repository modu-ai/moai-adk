name: âš ï¸ DEPRECATED - Use Secure Release Pipeline

# âš ï¸ DEPRECATED WORKFLOW
# This workflow is DISABLED for security reasons.
#
# ðŸ”’ USE INSTEAD: .github/workflows/release-secure.yml
#
# REASON FOR DEPRECATION:
# - Automatic tag-based deployment caused Production accidents
# - No manual approval gates
# - No safety validation checks
#
# ðŸš¨ MIGRATION GUIDE:
# 1. Use: "Secure Release Pipeline" workflow
# 2. Manual trigger only
# 3. Environment protection enabled
# 4. Safety validation included

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-test"

jobs:
  blocked:
    name: ðŸš¨ WORKFLOW DISABLED
    runs-on: ubuntu-latest
    steps:
      - name: ðŸš¨ Deployment Blocked
        run: |
          echo "ðŸš¨ THIS WORKFLOW IS DISABLED FOR SECURITY REASONS"
          echo ""
          echo "âŒ Automatic tag-based deployment has caused production accidents"
          echo ""
          echo "âœ… Please use the new Secure Release Pipeline:"
          echo "   ðŸ“ .github/workflows/release-secure.yml"
          echo ""
          echo "ðŸ”’ New security features:"
          echo "   â€¢ Manual approval required"
          echo "   â€¢ Environment protection"
          echo "   â€¢ Safety validation"
          echo "   â€¢ Emergency rollback"
          echo ""
          echo "ðŸš¨ TO DEPLOY:"
          echo "   1. Go to Actions tab"
          echo "   2. Select 'ðŸš€ Secure Release Pipeline'"
          echo "   3. Click 'Run workflow'"
          echo "   4. Fill in deployment details"
          echo "   5. Wait for approval (if production)"
          echo ""
          echo "ðŸ“ž Contact: @Goos for assistance"

# ê¶Œí•œ ì„¤ì •: Release ìƒì„±, Package ë°°í¬
permissions:
  contents: write
  packages: write

concurrency:
  group: release-${{ github.ref }}
  # ReleaseëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ (ì¤‘ìš”)
  cancel-in-progress: false

jobs:
  create-release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_body: ${{ steps.release_notes.outputs.body }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ëª¨ë“  ì»¤ë°‹ ížˆìŠ¤í† ë¦¬ í•„ìš”

      - name: ðŸ” Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          VERSION="${VERSION%-test}"  # Remove -test suffix
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: ðŸŒ Generate bilingual release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"

          # Git logì—ì„œ ì´ì „ íƒœê·¸ ì°¾ê¸°
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            # ì´ì „ íƒœê·¸ê°€ ì—†ìœ¼ë©´ ì „ì²´ ì»¤ë°‹ ì´ë ¥ ì‚¬ìš©
            COMMITS=$(git log --oneline --pretty=format:"- %h %s" | head -20)
          else
            # ì´ì „ íƒœê·¸ ì´í›„ ì»¤ë°‹ë§Œ ì¶”ì¶œ
            COMMITS=$(git log $PREV_TAG..$TAG --oneline --pretty=format:"- %h %s")
          fi

          # ë¹Œë§êµ¬ì–¼ release notes ìƒì„±
          # ê¸°ë³¸ í¬ë§·: í•œê¸€ â†’ --- â†’ ì˜ë¬¸
          cat > release_notes.md << 'NOTES_EOF'
          ## ðŸŽ¯ í•œê¸€ ì„¹ì…˜

          ### ìƒˆë¡œìš´ ê¸°ëŠ¥
          - MergeAnalyzer: Claude Code headless ê¸°ë°˜ ì§€ëŠ¥í˜• ë³‘í•© ë¶„ì„
          - ë°°í¬ ì •ì±… ë¬¸ì„œí™”: Git íŒŒì¼ ë¶„ë¥˜ ë° ë°°í¬ ê·œì¹™ ëª…í™•í™”
          - ì•ˆì „ ë©”ì»¤ë‹ˆì¦˜: ì‚­ì œ ì „ ìžë™ ë°±ì—… ë° ì‚¬ì „ ê²€ì¦

          ### ë²„ê·¸ ìˆ˜ì •
          - CI/CD íŒŒì´í”„ë¼ì¸ ìµœì í™”: 11ê°œ ì›Œí¬í”Œë¡œìš° â†’ 5ê°œ ì›Œí¬í”Œë¡œìš°ë¡œ í†µí•©
          - ì½”ë“œ í’ˆì§ˆ ê²Œì´íŠ¸: ìžë™ ê²€ì¦ í”„ë¡œì„¸ìŠ¤ ê°œì„ 

          ### ê°œì„ ì‚¬í•­
          - íŒ¨í‚¤ì§€ ì´ˆê¸°í™”: í…œí”Œë¦¿ ê¸°ë°˜ í”„ë¡œì íŠ¸ êµ¬ì¡° ìžë™ ìƒì„±
          - ë¡œì»¬ ê°œë°œ íŒŒì¼: Git ì¶”ì  í™œì„±í™” (ë°°í¬ ì œì™¸)
          - ë¬¸ì„œí™”: ë°°í¬ ì •ì±…, ì•ˆì „ ë©”ì»¤ë‹ˆì¦˜ ì™„ì „ížˆ ë¬¸ì„œí™”

          ### ì£¼ì˜ì‚¬í•­
          - `.moai/yoda/` ë° `.moai/release/`: ë¡œì»¬ ì „ìš© (ë°°í¬ë˜ì§€ ì•ŠìŒ)
          - PYPI_API_TOKEN í•„ìˆ˜: GitHub Actions secret ì„¤ì • í•„ìš”

          ---

          ## ðŸŽ¯ English Section

          ### New Features
          - MergeAnalyzer: Intelligent merge analysis using Claude Code headless mode
          - Deployment Policy Documentation: Clear Git file classification and deployment rules
          - Safety Mechanisms: Automatic backup before deletion and pre-validation

          ### Bug Fixes
          - CI/CD Pipeline Optimization: Consolidate 11 workflows â†’ 5 workflows
          - Code Quality Gates: Improved automatic validation process

          ### Improvements
          - Package Initialization: Auto-generate project structure from templates
          - Local Development Files: Enable Git tracking (excluded from deployment)
          - Documentation: Complete documentation of deployment policies and safety mechanisms

          ### Notes
          - `.moai/yoda/` and `.moai/release/`: Local-only (not deployed)
          - PYPI_API_TOKEN required: Configure in GitHub Actions secrets

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: ðŸŽ© Alfred@MoAI
          NOTES_EOF

          # Outputë¥¼ GitHub Actionsì— ì „ë‹¬
          {
            echo 'body<<EOF'
            cat release_notes.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: ðŸ“¤ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Release v${{ steps.version.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.tag, '-test') }}
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    name: ðŸ“¦ Publish to PyPI
    needs: create-release
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ”¨ Build package
        run: |
          echo "ðŸ—ï¸  Building package for version ${{ needs.create-release.outputs.version }}..."
          uv build
          echo "âœ… Package built successfully"
          ls -lh dist/

      - name: ðŸš€ Publish to PyPI or TestPyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
          UV_PUBLISH_TOKEN_TESTPYPI: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${{ needs.create-release.outputs.version }}"

          # ë°°í¬ ëŒ€ìƒ ê²°ì • (-test suffix í™•ì¸)
          if [[ "$TAG" == *"-test" ]]; then
              # TestPyPI ë°°í¬
              echo "ðŸ§ª Publishing to TestPyPI (test mode)..."

              if [ -z "$UV_PUBLISH_TOKEN_TESTPYPI" ]; then
                  echo "âš ï¸  TestPyPI token not configured in secrets"
                  echo "â†’ Configure TESTPYPI_API_TOKEN in GitHub Actions secrets"
                  echo "â†’ Skipping TestPyPI deployment"
                  exit 0
              fi

              export UV_PUBLISH_TOKEN="$UV_PUBLISH_TOKEN_TESTPYPI"
              uv publish --publish-url https://test.pypi.org/legacy/
              echo "âœ… Package published to TestPyPI successfully"
          else
              # ì‹¤ì œ PyPI ë°°í¬
              echo "ðŸ“¤ Publishing to PyPI (production)..."

              if [ -z "$UV_PUBLISH_TOKEN" ]; then
                  echo "âŒ PyPI token not configured in secrets"
                  echo "â†’ Configure PYPI_API_TOKEN in GitHub Actions secrets"
                  exit 1
              fi

              uv publish --publish-url https://upload.pypi.org/legacy/
              echo "âœ… Package published to PyPI successfully"
          fi

      - name: ðŸ” Verify PyPI or TestPyPI deployment
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${{ needs.create-release.outputs.version }}"

          # ë°°í¬ ëŒ€ìƒ ê²°ì •
          if [[ "$TAG" == *"-test" ]]; then
              echo "ðŸ§ª Verifying TestPyPI deployment (moai-adk==$VERSION)..."
              PYPI_URL="https://test.pypi.org/simple/"
              PYPI_NAME="TestPyPI"
          else
              echo "ðŸ“¦ Verifying PyPI deployment (moai-adk==$VERSION)..."
              PYPI_URL="https://pypi.org/simple/"
              PYPI_NAME="PyPI"
          fi

          # Wait for PyPI/TestPyPI CDN propagation (max 50 seconds)
          MAX_RETRIES=10
          RETRY_COUNT=0
          PACKAGE_FOUND=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Checking $PYPI_NAME... (attempt $RETRY_COUNT/$MAX_RETRIES)"

            if [[ "$TAG" == *"-test" ]]; then
              # TestPyPI verification
              if pip index versions moai-adk --index-url "$PYPI_URL" 2>/dev/null | grep -q "$VERSION"; then
                echo "âœ… Package available on TestPyPI: moai-adk==$VERSION"
                PACKAGE_FOUND=true
                break
              fi
            else
              # PyPI verification
              if pip index versions moai-adk 2>/dev/null | grep -q "$VERSION"; then
                echo "âœ… Package available on PyPI: moai-adk==$VERSION"
                PACKAGE_FOUND=true
                break
              fi
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 5
            fi
          done

          if [ "$PACKAGE_FOUND" = "false" ]; then
            echo "âš ï¸  Package not found on $PYPI_NAME after 50 seconds"
            if [[ "$TAG" == *"-test" ]]; then
              echo "â†’ Manual check: https://test.pypi.org/project/moai-adk/$VERSION/"
            else
              echo "â†’ Manual check: https://pypi.org/project/moai-adk/$VERSION/"
            fi
            echo "â†’ This may be due to CDN propagation delay. Check again in a few minutes."
          fi

  notify:
    name: ðŸ“¢ Post Deployment Summary
    needs: [create-release, publish-pypi]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ“‹ Generate summary
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          TAG="${{ github.ref_name }}"

          if [[ "$TAG" == *"-test" ]]; then
            PYPI_TYPE="TestPyPI"
            PYPI_URL="https://test.pypi.org/project/moai-adk/$VERSION/"
          else
            PYPI_TYPE="PyPI"
            PYPI_URL="https://pypi.org/project/moai-adk/$VERSION/"
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ## ðŸš€ Release Deployment Complete

          | Item | Value |
          |------|-------|
          | **Version** | ${{ needs.create-release.outputs.version }} |
          | **Release** | [$TAG](https://github.com/${{ github.repository }}/releases/tag/$TAG) |
          | **$PYPI_TYPE** | [$PYPI_URL]($PYPI_URL) |

          ### ì„¤ì¹˜ ë°©ë²•

          **uv ì‚¬ìš©** (ê¶Œìž¥):
          ```bash
          uv add moai-adk==$VERSION
          ```

          **pip ì‚¬ìš©**:
          ```bash
          pip install moai-adk==$VERSION
          ```

          ### GitHub Release

          ðŸ“ í•œê¸€ ì„¤ëª…ê³¼ ì˜ë¬¸ ì„¤ëª…ì€ [Release íŽ˜ì´ì§€](https://github.com/${{ github.repository }}/releases/tag/$TAG)ì—ì„œ í™•ì¸í•˜ì„¸ìš”.

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          SUMMARY

      - name: âœ… Deployment status
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"

          if [ "${{ needs.publish-pypi.result }}" == "success" ]; then
            echo "âœ… Version $VERSION successfully deployed to PyPI"
          else
            echo "âš ï¸  Version $VERSION deployment completed with warnings"
            echo "â†’ Check workflow logs for details"
          fi
