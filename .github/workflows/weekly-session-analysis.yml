name: Weekly Session Analysis

on:
  schedule:
    # Îß§Ï£º ÏõîÏöîÏùº 09:00 UTC (KST +9 = 18:00)
    - cron: '0 9 * * 1'

  # ÏàòÎèô Ïã§Ìñâ ÏòµÏÖò
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze Claude Code Sessions
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Run session analysis
        run: |
          mkdir -p .moai/reports
          python3 .moai/scripts/session_analyzer.py \
            --days 7 \
            --output ".moai/reports/weekly-$(date +%Y-%m-%d).md" \
            --verbose

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet HEAD .moai/reports/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            üìä Weekly session meta-analysis report

            Generated by automated weekly analysis.

            ü§ñ Generated with Claude Code
          title: '[AUTO] Weekly Session Analysis - $(date +%Y-%m-%d)'
          body: |
            ## Weekly Session Meta-Analysis Report

            This automated report analyzes Claude Code session logs from the past 7 days.

            ### What to Review

            - **Tool Usage Patterns**: Most frequently used tools
            - **Error Patterns**: Common failures and issues
            - **Permission Requests**: Which permissions are requested most
            - **Hook Failures**: Any hook execution problems

            ### Action Items

            Review the suggestions in the report and consider:

            1. **Permission Adjustments** (`.claude/settings.json`)
               - Move frequently requested permissions from `ask` to `allow`
               - Or restrict dangerous operations to `deny`

            2. **CLAUDE.md Updates**
               - Add workarounds for common errors
               - Clarify ambiguous rules
               - Update context management guidelines

            3. **Hook Debugging** (`.claude/hooks/`)
               - Fix any failing hooks
               - Improve timeout configurations
               - Add better error handling

            ### Generated Files

            Report location: `.moai/reports/weekly-*.md`

            ---

            ‚ÑπÔ∏è This PR is auto-generated. Review and merge manually.
          branch: auto/weekly-session-analysis-$(date +%Y-%m-%d)
          delete-branch: true
          labels: |
            automation
            analysis
            meta-analysis

      - name: Summary
        if: always()
        run: |
          echo "‚úÖ Session analysis complete"
          echo "üìÑ Report: .moai/reports/weekly-$(date +%Y-%m-%d).md"
          if [ -f ".moai/reports/weekly-$(date +%Y-%m-%d).md" ]; then
            echo ""
            echo "Preview:"
            head -n 30 ".moai/reports/weekly-$(date +%Y-%m-%d).md"
          fi
