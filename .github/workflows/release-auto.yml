name: ðŸš€ Automated Release Pipeline

# íƒœê·¸ ê¸°ë°˜ ìžë™ ë¦´ë¦¬ì¦ˆ íŒŒì´í”„ë¼ì¸
# Usage: git tag -a v0.31.0 -m "Release v0.31.0" && git push origin v0.31.0
on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # v0.31.0 í˜•íƒœ
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.30.1)'
        required: true
        type: string

permissions:
  contents: write
  packages: write
  actions: read
  pull-requests: write

concurrency:
  group: release-auto-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 1ï¸âƒ£ TAG ê²€ì¦
  tag-validation:
    name: ðŸ·ï¸ Tag Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is_valid: ${{ steps.validate.outputs.is_valid }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Extract version from tag
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v$VERSION"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"  # Remove 'v' prefix
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Tag: $TAG â†’ Version: $VERSION"

      - name: âœ… Validate version format and sync
        id: validate
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "//' | sed 's/"//')

          echo "ðŸ” Tag version: $VERSION"
          echo "ðŸ” pyproject.toml: $PYPROJECT_VERSION"

          # Version format check
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "   Must be: MAJOR.MINOR.PATCH"
            echo "is_valid=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          # Version match check
          if [ "$VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "âŒ VERSION MISMATCH!"
            echo "   Tag: $VERSION"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo "   Tag version must match pyproject.toml"
            echo "is_valid=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          echo "âœ… Tag validation passed"
          echo "is_valid=true" >> "$GITHUB_OUTPUT"

  # 2ï¸âƒ£ ë²„ì „ íŒŒì¼ ë™ê¸°í™” ë° Changelog ìƒì„±
  version-and-changelog:
    name: ðŸ“ Version & Changelog Update
    runs-on: ubuntu-latest
    needs: tag-validation
    if: needs.tag-validation.outputs.is_valid == 'true'
    outputs:
      version: ${{ needs.tag-validation.outputs.version }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ”§ Setup Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gitpython pyyaml

      - name: ðŸ” Verify version consistency
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"
          echo "ðŸ” Verifying version consistency..."
          echo "ðŸ“¦ Tag version: $VERSION"

          # Verify pyproject.toml (single source of truth)
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "//' | sed 's/"//')
          echo "ðŸ“¦ pyproject.toml version: $PYPROJECT_VERSION"

          if [ "$VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "âŒ Version mismatch between tag and pyproject.toml!"
            exit 1
          fi

          echo "âœ… Version consistency verified"
          echo "â„¹ï¸  Note: __init__.py and version.py use importlib.metadata to read version from pyproject.toml"
          echo "â„¹ï¸  No file modifications needed - dynamic version management is already in place"

      - name: ðŸ“‹ Generate Changelog
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          echo "ðŸ“ Generating Changelog for $VERSION"
          echo "Previous tag: $PREVIOUS_TAG"

          # Get commits since last tag
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --format="- %h %s" --reverse)
          else
            COMMITS=$(git log $PREVIOUS_TAG...HEAD --format="- %h %s" --reverse)
          fi

          # Create changelog entry
          cat > CHANGELOG.entry.md << 'EOF'
          ## [VERSION_PLACEHOLDER] - RELEASE_DATE_PLACEHOLDER

          ### ðŸ‡°ðŸ‡· í•œêµ­ì–´

          #### ì£¼ìš” ë³€ê²½ì‚¬í•­
          VERSION_COMMITS_KO

          #### ì„¤ì¹˜ ë°©ë²•
          ```bash
          # UV ì‚¬ìš© (ê¶Œìž¥)
          uv add moai-adk==VERSION_PLACEHOLDER

          # pip ì‚¬ìš©
          pip install moai-adk==VERSION_PLACEHOLDER
          ```

          ---

          ## [VERSION_PLACEHOLDER] - RELEASE_DATE_PLACEHOLDER

          ### ðŸ‡ºðŸ‡¸ English

          #### Key Changes
          VERSION_COMMITS_EN

          #### Installation
          ```bash
          # UV (Recommended)
          uv add moai-adk==VERSION_PLACEHOLDER

          # pip
          pip install moai-adk==VERSION_PLACEHOLDER
          ```

          ---

          ðŸ¤– Generated by [Claude Code](https://claude.com/claude-code)
          EOF

          # Replace placeholders
          RELEASE_DATE=$(date +"%Y-%m-%d")
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" CHANGELOG.entry.md
          sed -i "s/RELEASE_DATE_PLACEHOLDER/$RELEASE_DATE/g" CHANGELOG.entry.md

          # Simple commit list (will be enhanced by AI)
          # Use Python for safe string replacement (handles special characters)
          # Save commits to file for Python script
          echo "$COMMITS" | head -10 > commits.txt

          python3 << 'PYTHON_SCRIPT'
# Read commits from file
with open('commits.txt', 'r', encoding='utf-8') as f:
    commits = f.read()

# Format commits
commits_list = [line.strip() for line in commits.split('\n') if line.strip()]
commits_text = '\n'.join(commits_list)

# Read template
with open('CHANGELOG.entry.md', 'r', encoding='utf-8') as f:
    content = f.read()

# Replace placeholders safely
content = content.replace('VERSION_COMMITS_KO', commits_text)
content = content.replace('VERSION_COMMITS_EN', commits_text)

# Write back
with open('CHANGELOG.entry.md', 'w', encoding='utf-8') as f:
    f.write(content)

print("âœ… Commits inserted successfully")
PYTHON_SCRIPT

          rm -f commits.txt
          echo "âœ… Changelog entry generated"
          cat CHANGELOG.entry.md

      - name: ðŸ“ Update CHANGELOG.md
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"

          # Prepend new entry to CHANGELOG.md
          {
            cat CHANGELOG.entry.md
            echo ""
            cat CHANGELOG.md
          } > CHANGELOG.md.new
          mv CHANGELOG.md.new CHANGELOG.md

          echo "âœ… CHANGELOG.md updated"
          git add CHANGELOG.md
          rm -f CHANGELOG.entry.md

      - name: ðŸ“¤ Create version/changelog commit
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "â„¹ï¸ No version/changelog changes to commit"
          else
            git commit -m "chore: Auto-update version and changelog for v$VERSION"
            echo "âœ… Commit created"
          fi

      - name: ðŸ”™ Push changes (optional)
        run: |
          # Only push if there are changes
          if [ -n "$(git log --oneline @{u}..)" ]; then
            git push origin main || echo "âš ï¸ No changes to push"
          fi

  # 3ï¸âƒ£ Pre-deployment ê²€ì¦ (ê¸°ì¡´ release-secure.yml ìž¬ì‚¬ìš©)
  pre-deployment-checks:
    name: ðŸ” Pre-Deployment Safety Checks
    runs-on: ubuntu-latest
    needs: [tag-validation, version-and-changelog]
    outputs:
      version: ${{ needs.tag-validation.outputs.version }}
      is_safe: ${{ steps.safety.outputs.safe }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Safety validation
        id: safety
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"
          PYPROJECT_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "//' | sed 's/"//')

          echo "ðŸ” Safety Check Results:"
          echo "  Package version: $PYPROJECT_VERSION"
          echo "  Tag version: $VERSION"

          if [ "$PYPROJECT_VERSION" != "$VERSION" ]; then
            echo "âŒ VERSION MISMATCH!"
            exit 1
          fi

          # Check for test/unstable patterns
          if [[ "$VERSION" =~ (test|alpha|beta|rc|dev) ]]; then
            echo "âš ï¸ Development version: $VERSION (allowed for TestPyPI only)"
          fi

          echo "âœ… Safety checks passed"
          echo "safe=true" >> "$GITHUB_OUTPUT"

  # 4ï¸âƒ£ ë¹Œë“œ ë° ê²€ì¦
  build-and-verify:
    name: ðŸ—ï¸ Build & Verify Package
    runs-on: ubuntu-latest
    needs: [tag-validation, pre-deployment-checks]
    if: needs.pre-deployment-checks.outputs.is_safe == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: ðŸ”¨ Build package
        run: |
          echo "ðŸ—ï¸ Building package for version ${{ needs.tag-validation.outputs.version }}..."
          uv build
          echo "âœ… Package built successfully"
          ls -lh dist/

      - name: ðŸ§ª Run comprehensive tests
        run: |
          echo "ðŸ§ª Running final pre-deployment tests..."
          uv sync --group dev --group security
          uv run pytest tests/ -v --cov=src/moai_adk --cov-report=term
          echo "âœ… All tests passed"

      - name: ðŸ“¦ Package integrity verification
        run: |
          echo "ðŸ“¦ Verifying package integrity..."

          # Check wheel
          python -m zipfile -l dist/moai_adk-*.whl | wc -l
          echo "âœ… Wheel package verified"

          # Check tarball
          tar -tzf dist/moai_adk-*.tar.gz | wc -l
          echo "âœ… Source package verified"

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-packages
          path: dist/
          retention-days: 7

  # 5ï¸âƒ£ GitHub Release ìƒì„±
  create-github-release:
    name: ðŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [tag-validation, build-and-verify]
    if: needs.build-and-verify.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“‹ Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"

          cat > release_notes.md << 'NOTES_EOF'
          ## ðŸŽ¯ MoAI-ADK Release VERSION_PLACEHOLDER

          ### ðŸ‡°ðŸ‡· í•œêµ­ì–´

          #### ì£¼ìš” ë³€ê²½ì‚¬í•­
          ìžë™ ë°°í¬ íŒŒì´í”„ë¼ì¸ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
          ë³€ê²½ì‚¬í•­ì€ CHANGELOG.mdë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

          #### ì„¤ì¹˜ ë°©ë²•
          ```bash
          # UV ì‚¬ìš© (ê¶Œìž¥)
          uv add moai-adk==VERSION_PLACEHOLDER

          # pip ì‚¬ìš©
          pip install moai-adk==VERSION_PLACEHOLDER
          ```

          ---

          ## ðŸŽ¯ English Section

          #### Key Changes
          Automated deployment pipeline is now active.
          See CHANGELOG.md for detailed changes.

          #### Installation
          ```bash
          # UV (Recommended)
          uv add moai-adk==VERSION_PLACEHOLDER

          # pip
          pip install moai-adk==VERSION_PLACEHOLDER
          ```

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code) - Automated Release Pipeline

          Co-Authored-By: ðŸŽ© Alfred@MoAI
          NOTES_EOF

          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" release_notes.md

          echo "body<<EOF" >> "$GITHUB_OUTPUT"
          cat release_notes.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¤ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: dist/

      - name: ðŸ“¤ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ needs.tag-validation.outputs.version }}"
          name: "Release v${{ needs.tag-validation.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 6ï¸âƒ£ TestPyPI ë°°í¬
  deploy-to-testpypi:
    name: ðŸ§ª Deploy to TestPyPI
    runs-on: ubuntu-latest
    needs: [tag-validation, create-github-release]
    if: needs.create-github-release.result == 'success'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ðŸ“¦ Install uv
        uses: astral-sh/setup-uv@v2

      - name: ðŸ“¤ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-packages
          path: dist/

      - name: ðŸš€ Deploy to TestPyPI
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"
          echo "ðŸ§ª Deploying to TestPyPI..."
          uv publish --publish-url https://test.pypi.org/legacy/
          echo "âœ… Deployed to TestPyPI: https://test.pypi.org/project/moai-adk/$VERSION/"

      - name: ðŸ” Verify TestPyPI deployment
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"
          echo "ðŸ” Verifying deployment..."

          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Checking deployment... (attempt $RETRY_COUNT/$MAX_RETRIES)"

            if pip index versions moai-adk --index-url https://test.pypi.org/simple/ 2>/dev/null | grep -q "$VERSION"; then
              echo "âœ… Package available on TestPyPI"
              break
            fi

            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 6
            fi
          done

  # 7ï¸âƒ£ ìµœì¢… ìš”ì•½
  release-summary:
    name: ðŸ“Š Release Summary
    runs-on: ubuntu-latest
    needs: [tag-validation, deploy-to-testpypi]
    if: always()

    steps:
      - name: ðŸ“‹ Generate comprehensive summary
        run: |
          VERSION="${{ needs.tag-validation.outputs.version }}"

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Automated Release Pipeline Summary

          | Phase | Status | Details |
          |-------|--------|---------|
          | **Tag Validation** | ${{ needs.tag-validation.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Version format & sync check |
          | **Version/Changelog** | ${{ needs.version-and-changelog.result == 'success' && 'âœ… UPDATED' || 'â­ï¸ SKIPPED' }} | Files synchronized |
          | **Pre-Deployment Checks** | ${{ needs.pre-deployment-checks.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Safety validation |
          | **Build & Verify** | ${{ needs.build-and-verify.result == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }} | Package build & tests |
          | **GitHub Release** | ${{ needs.create-github-release.result == 'success' && 'âœ… CREATED' || 'â­ï¸ SKIPPED' }} | Release notes |
          | **TestPyPI Deploy** | ${{ needs.deploy-to-testpypi.result == 'success' && 'âœ… DEPLOYED' || 'âŒ FAILED' }} | Test package registry |

          ### ðŸ“¦ Package Information
          - **Version**: EOF
          echo "v$VERSION" >> $GITHUB_STEP_SUMMARY

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          - **Status**: TestPyPI Deployment Complete

          ### ðŸ”— Links
          - **TestPyPI Package**: https://test.pypi.org/project/moai-adk/EOF
          echo "v$VERSION/" >> $GITHUB_STEP_SUMMARY

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          - **GitHub Release**: https://github.com/EOF
          echo "${{ github.repository }}/releases/tag/v$VERSION" >> $GITHUB_STEP_SUMMARY

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### âœ… Next Steps

          1. **Verify TestPyPI Package**:
             ```bash
             pip install -i https://test.pypi.org/simple/ moai-adk==$VERSION
             ```

          2. **Deploy to Production PyPI** (Manual Approval Required):
             1. Go to GitHub Actions
             2. Run "Secure Release Pipeline" workflow manually
             3. Set environment to "production"
             4. Approve after 5-minute delay

          ### ðŸ›¡ï¸ Security Features
          - âœ… Tag format validation
          - âœ… Version synchronization check
          - âœ… Comprehensive testing
          - âœ… TestPyPI staging deployment
          - âœ… Manual approval gate for production

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code) - Automated Release Pipeline
          EOF

          # Overall status
          if [ "${{ needs.tag-validation.result }}" = "success" ] && \
             [ "${{ needs.deploy-to-testpypi.result }}" = "success" ]; then
            echo ""
            echo "ðŸŽ‰ RELEASE PIPELINE SUCCESSFUL!"
            echo "   Version $VERSION ready for production deployment"
          else
            echo ""
            echo "âš ï¸ PIPELINE COMPLETED WITH ISSUES"
            echo "   Review the phases above for details"
          fi
