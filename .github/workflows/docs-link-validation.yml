name: Documentation Link Validation

# GitFlow Strategy:
# - PR creation â†’ Run validation on changed markdown files
# - main/develop branch push â†’ Full validation (all docs)
# - Manual trigger â†’ Full validation with detailed report
on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "docs/**/*.md"
      - "*.md"
      - ".github/workflows/docs-link-validation.yml"
      - "docs/.markdown-link-check.json"

  push:
    branches:
      - main
      - develop
    paths:
      - "docs/**/*.md"
      - "*.md"

  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'false'
        type: boolean

jobs:
  link-validation:
    name: ðŸ”— Validate Documentation Links
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changed files detection

      - name: ðŸ” Detect changed markdown files (PR only)
        id: changed-files
        if: github.event_name == 'pull_request'
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.md
            docs/**/*.md
          separator: ","

      - name: ðŸ“Š List changed files
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Changed markdown files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ',' '\n'
          echo ""
          echo "Total changed files: $(echo '${{ steps.changed-files.outputs.all_changed_files }}' | tr ',' '\n' | wc -l)"

      - name: ðŸ”— Check links in changed files (PR)
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.any_changed == 'true'
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: false
          use-verbose-mode: ${{ github.event.inputs.verbose == 'true' }}
          config-file: 'docs/.markdown-link-check.json'
          check-modified-files-only: yes
          base-branch: ${{ github.base_ref }}

      - name: ðŸ”— Check all documentation links (Full)
        if: github.event_name != 'pull_request' || steps.changed-files.outputs.any_changed != 'true'
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: false
          use-verbose-mode: ${{ github.event.inputs.verbose == 'true' }}
          config-file: 'docs/.markdown-link-check.json'
          folder-path: 'docs/'
          file-path: './README.md, ./CONTRIBUTING.md, ./CHANGELOG.md'

      - name: ðŸ“ˆ Generate validation report
        if: always()
        run: |
          echo "## ðŸ”— Link Validation Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ steps.changed-files.outputs.any_changed }}" == "true" ]; then
              echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "**No markdown files changed in this PR**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Validation Type**: Full documentation scan" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **All links validated successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Link validation failed - Please check the logs above**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: âœ… Validation completed
        if: success()
        run: |
          echo "âœ… Link validation passed!"
          echo ""
          echo "Summary:"
          echo "  â€¢ Event: ${{ github.event_name }}"
          echo "  â€¢ Branch: ${{ github.ref_name }}"
          echo "  â€¢ Status: SUCCESS"

      - name: âŒ Validation failed
        if: failure()
        run: |
          echo "âŒ Link validation failed!"
          echo ""
          echo "Please review the errors above and fix broken links."
          echo ""
          echo "Common issues:"
          echo "  â€¢ Broken internal links (wrong file paths)"
          echo "  â€¢ External links returning 404"
          echo "  â€¢ Timeout errors (external sites)"
          echo "  â€¢ Anchor links to non-existent sections"
          echo ""
          echo "Tips:"
          echo "  1. Check the config file: docs/.markdown-link-check.json"
          echo "  2. Test links locally: markdown-link-check docs/**/*.md"
          echo "  3. Add exceptions for known issues to config file"
          exit 1

  # Additional job: Link validation status badge
  update-badge:
    name: ðŸ“Š Update Status Badge
    runs-on: ubuntu-latest
    needs: link-validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Create status badge
        run: |
          if [ "${{ needs.link-validation.result }}" == "success" ]; then
            echo "Link validation: passing" > .github/link-validation-status.txt
          else
            echo "Link validation: failing" > .github/link-validation-status.txt
          fi

      - name: ðŸ“¤ Commit badge status
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/link-validation-status.txt || true
          git commit -m "chore: Update link validation status badge" || true
          git push || true
