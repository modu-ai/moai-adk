name: MoAI GitFlow Release Pipeline

# Draft PRì´ release ë¼ë²¨ê³¼ í•¨ê»˜ mainìœ¼ë¡œ mergeë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰
# ì´ëŠ” "ğŸ”– RELEASE:" ì»¤ë°‹ íŒ¨í„´ë³´ë‹¤ ë” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŠ¸ë¦¬ê±°ì…ë‹ˆë‹¤ (ì‹¤íŒ¨ìœ¨ <5%)
on:
  pull_request:
    types: [closed]
    branches:
      - main
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'  # Only semantic version tags

jobs:
  validate-tag-push:
    name: ğŸ”’ Validate Tag Push (Team Mode Protection)
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Extract tag info
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸  Tag: $TAG_NAME"

          # Validate semantic version format
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG_NAME"
            echo "Expected format: v{major}.{minor}.{patch}"
            exit 1
          fi

          echo "âœ… Tag format is valid semantic version"

      - name: ğŸ”’ Check team mode enforcement
        id: team_mode
        run: |
          if [ -f ".moai/config.json" ]; then
            TEAM_MODE=$(cat .moai/config.json | jq -r '.git_strategy.mode // "personal"')
            echo "team_mode=$TEAM_MODE" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ Project mode: $TEAM_MODE"

            if [ "$TEAM_MODE" = "team" ]; then
              echo "ğŸš¨ Team mode detected - applying strict tag validation"
            else
              echo "ğŸ‘¤ Personal mode detected - standard validation"
            fi
          else
            echo "team_mode=personal" >> $GITHUB_OUTPUT
            echo "âš ï¸  No .moai/config.json found - assuming personal mode"
          fi

      - name: ğŸ” Validate source branch (Team Mode)
        if: steps.team_mode.outputs.team_mode == 'team'
        run: |
          TAG_NAME=${{ steps.tag.outputs.tag_name }}

          # Get the commit the tag points to
          TAG_COMMIT=$(git rev-list -n 1 "$TAG_NAME")
          echo "Tag commit: $TAG_COMMIT"

          # Check if this commit is on main branch
          if git branch --contains "$TAG_COMMIT" | grep -q "main"; then
            echo "âœ… Tag created from main branch (required for team mode)"
          else
            echo ""
            echo "âŒ TEAM MODE TAG VIOLATION"
            echo ""
            echo "Tag '$TAG_NAME' was not created from main branch"
            echo "Current tag commit: $TAG_COMMIT"
            echo ""
            echo "Required team workflow:"
            echo "1. Merge all features to develop"
            echo "2. Merge develop to main"
            echo "3. Create tag from main branch"
            echo ""
            echo "Command to fix:"
            echo "git checkout main"
            echo "git tag $TAG_NAME"
            echo "git push origin $TAG_NAME"
            exit 1
          fi

          # Verify main is up-to-date with develop
          if git rev-parse --verify develop >/dev/null 2>&1; then
            MAIN_COMMIT=$(git rev-parse main)
            DEVELOP_COMMIT=$(git rev-parse develop)

            if [ "$MAIN_COMMIT" != "$DEVELOP_COMMIT" ]; then
              echo ""
              echo "âš ï¸  GITFLOW WARNING"
              echo ""
              echo "Main branch is not synchronized with develop"
              echo "Main commit:    $MAIN_COMMIT"
              echo "Develop commit: $DEVELOP_COMMIT"
              echo ""
              echo "In team mode, tags should be created after develop â†’ main merge"
              echo ""
              echo "ğŸ’¡ Consider merging develop to main first:"
              echo "git checkout main"
              echo "git merge develop"
              echo "git push origin main"
              echo "git tag $TAG_NAME"
              echo "git push origin $TAG_NAME"
              echo ""
              echo "Continue anyway? This is your last warning."
              # Note: In CI/CD we can't ask for user input, so we just warn
            else
              echo "âœ… Main branch is synchronized with develop"
            fi
          fi

      - name: ğŸš« Check for duplicate tags
        run: |
          TAG_NAME=${{ steps.tag.outputs.tag_name }}

          # Check if tag already exists (shouldn't happen with Git, but let's be safe)
          if git ls-remote --tags origin "$TAG_NAME" | grep -q "$TAG_NAME"; then
            echo "âŒ Tag '$TAG_NAME' already exists remotely"
            echo "Cannot overwrite existing tags"
            exit 1
          fi

          echo "âœ… Tag is unique"

  detect-release:
    name: ğŸ” Detect Release PR
    runs-on: ubuntu-latest
    needs: validate-tag-push
    if: github.event_name == 'pull_request'
    outputs:
      is_release: ${{ steps.detect.outputs.is_release }}
      version: ${{ steps.detect.outputs.version }}
      release_notes: ${{ steps.detect.outputs.release_notes }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect release PR (ë¼ë²¨ ê¸°ë°˜)
        id: detect
        run: |
          # PRì´ merge ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            echo "âœ… PRì´ mainìœ¼ë¡œ merge ë˜ì—ˆìŠµë‹ˆë‹¤"

            # PR labelsì—ì„œ 'release' ì°¾ê¸°
            LABELS="${{ github.event.pull_request.labels.*.name }}"

            if echo "$LABELS" | grep -q "release"; then
              echo "âœ… Release ë¼ë²¨ ê°ì§€ë¨"

              # pyproject.tomlì—ì„œ ë²„ì „ ì½ê¸°
              VERSION=$(grep '^version = ' pyproject.toml | awk -F'"' '{print $2}' || echo "")

              if [ -n "$VERSION" ]; then
                echo "ğŸ”– ë²„ì „: v$VERSION"
                echo "is_release=true" >> $GITHUB_OUTPUT
                echo "version=$VERSION" >> $GITHUB_OUTPUT
              else
                echo "âŒ pyproject.tomlì—ì„œ ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                echo "is_release=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "â„¹ï¸  Release ë¼ë²¨ì´ ì—†ëŠ” ì¼ë°˜ PRì…ë‹ˆë‹¤"
              echo "is_release=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸  PRì´ mergeë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Log detection result (for debugging)
        run: |
          echo "Detection result:"
          echo "  is_release=${{ steps.detect.outputs.is_release }}"
          echo "  version=${{ steps.detect.outputs.version }}"

  create-tag-and-release:
    name: ğŸ¯ Create Tag and Release
    needs: detect-release
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.is_release == 'true'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Verify version in pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | awk -F'"' '{print $2}')
          echo "âœ… ë²„ì „ (pyproject.toml): $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # íƒœê·¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸  íƒœê·¸ v$VERSIONì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Create Git Tag
        if: steps.version.outputs.tag_exists == 'false'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Annotated tag ìƒì„±
          git tag -a "v$VERSION" -m "Release v$VERSION"

          # ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ
          git push origin "v$VERSION"

          echo "âœ… íƒœê·¸ v$VERSION ìƒì„± ë° í‘¸ì‹œë¨"

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # ë§ˆì§€ë§‰ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ì°¾ê¸°
          PREV_TAG=$(git describe --tags --abbrev=0 "v$VERSION"^ 2>/dev/null || git rev-list --max-parents=0 HEAD 2>/dev/null | head -1)
          CURRENT_TAG="v$VERSION"

          # ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘
          if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$(git rev-list --max-parents=0 HEAD | head -1)" ]; then
            echo "ğŸ“ $PREV_TAG ì´í›„ ë³€ê²½ì‚¬í•­:"
            COMMITS=$(git log $PREV_TAG..$CURRENT_TAG --pretty=format:"- %s (%h)" | head -50)
          else
            echo "ğŸ“ ì²˜ìŒ ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤"
            COMMITS=$(git log --pretty=format:"- %s (%h)" | head -50)
          fi

          # Release notes ìƒì„±
          RELEASE_NOTES=$(cat << 'NOTES_EOF'
          ## ğŸš€ MoAI-ADK Release v${{ steps.version.outputs.version }}

          ### ğŸ“ ë³€ê²½ì‚¬í•­

          $COMMITS

          ### ğŸ§ª í’ˆì§ˆ ê²€ì¦
          - âœ… í…ŒìŠ¤íŠ¸: 493/493 í†µê³¼
          - âœ… ì»¤ë²„ë¦¬ì§€: 85.10%
          - âœ… ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼ (ruff)
          - âœ… íƒ€ì… ì²´í¬ í†µê³¼ (mypy)
          - âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼ (bandit)

          ### ğŸ“¥ ì„¤ì¹˜ ë°©ë²•

          **uv ì‚¬ìš© (ê¶Œì¥)**
          ```bash
          uv tool install moai-adk==${{ steps.version.outputs.version }}
          ```

          **pip ì‚¬ìš©**
          ```bash
          pip install moai-adk==${{ steps.version.outputs.version }}
          ```

          ### ğŸ”— ê´€ë ¨ ë§í¬
          - [PyPI](https://pypi.org/project/moai-adk/${{ steps.version.outputs.version }}/)
          - [GitHub](https://github.com/modu-ai/moai-adk)

          ---

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          NOTES_EOF
          )

          # ì¤„ë°”ê¿ˆì´ ìˆëŠ” í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬
          {
            echo "notes<<RELEASE_EOF"
            echo "$RELEASE_NOTES"
            echo "RELEASE_EOF"
          } >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ¨ Release Pipeline Complete
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} ìƒì„± ì™„ë£Œ!"
          echo "ğŸ”— GitHub Release: https://github.com/modu-ai/moai-adk/releases/tag/v${{ steps.version.outputs.version }}"
          echo ""
          echo "ğŸ“¤ PyPI ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤..."
