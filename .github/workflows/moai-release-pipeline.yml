name: MoAI GitFlow Release Pipeline

# main ë¸Œëœì¹˜ì— ë¦´ë¦¬ì¦ˆ ì»¤ë°‹(ğŸ”– RELEASE:)ì´ í‘¸ì‹œë  ë•Œ ìë™ìœ¼ë¡œ ì‹¤í–‰
on:
  push:
    branches:
      - main
    # ë¦´ë¦¬ì¦ˆ ì»¤ë°‹ë§Œ í•„í„° (RELEASE íŒ¨í„´)
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".gitignore"

jobs:
  detect-release:
    name: ğŸ” Detect Release Commit
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.detect.outputs.is_release }}
      version: ${{ steps.detect.outputs.version }}
      release_notes: ${{ steps.detect.outputs.release_notes }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect release commit
        id: detect
        run: |
          # ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ í™•ì¸ (merge commit í¬í•¨)
          LAST_COMMIT=$(git log -1 --pretty=%B)
          echo "ìµœê·¼ ì»¤ë°‹: $LAST_COMMIT"

          # RELEASE íŒ¨í„´ ê°ì§€ (ğŸ”– RELEASE: v0.6.0)
          # ì»¤ë°‹ ë©”ì‹œì§€ ì–´ë””ë“  RELEASE íŒ¨í„´ì´ ìˆìœ¼ë©´ ê°ì§€ (merge commit ì§€ì›)
          if echo "$LAST_COMMIT" | grep -q "ğŸ”– RELEASE:"; then
            echo "âœ… Release ì»¤ë°‹ ê°ì§€ë¨"

            # ë²„ì „ ì¶”ì¶œ (ğŸ”– RELEASE: v0.6.0 â†’ 0.6.0)
            VERSION=$(echo "$LAST_COMMIT" | grep -oP 'RELEASE: v\K[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")

            if [ -n "$VERSION" ]; then
              echo "ğŸ”– ë²„ì „: v$VERSION"
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            else
              # pyproject.tomlì—ì„œ ë²„ì „ ì½ê¸°
              VERSION=$(grep '^version = ' pyproject.toml | awk -F'"' '{print $2}' || echo "")
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸  Release ì»¤ë°‹ì´ ì•„ë‹™ë‹ˆë‹¤"
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

  create-tag-and-release:
    name: ğŸ¯ Create Tag and Release
    needs: detect-release
    runs-on: ubuntu-latest
    if: needs.detect-release.outputs.is_release == 'true'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Verify version in pyproject.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' pyproject.toml | awk -F'"' '{print $2}')
          echo "âœ… ë²„ì „ (pyproject.toml): $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # íƒœê·¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "âš ï¸  íƒœê·¸ v$VERSIONì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ·ï¸ Create Git Tag
        if: steps.version.outputs.tag_exists == 'false'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Annotated tag ìƒì„±
          git tag -a "v$VERSION" -m "Release v$VERSION"

          # ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ
          git push origin "v$VERSION"

          echo "âœ… íƒœê·¸ v$VERSION ìƒì„± ë° í‘¸ì‹œë¨"

      - name: ğŸ“ Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # ë§ˆì§€ë§‰ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ì°¾ê¸°
          PREV_TAG=$(git describe --tags --abbrev=0 "v$VERSION"^ 2>/dev/null || git rev-list --max-parents=0 HEAD 2>/dev/null | head -1)
          CURRENT_TAG="v$VERSION"

          # ë³€ê²½ì‚¬í•­ ìˆ˜ì§‘
          if [ -n "$PREV_TAG" ] && [ "$PREV_TAG" != "$(git rev-list --max-parents=0 HEAD | head -1)" ]; then
            echo "ğŸ“ $PREV_TAG ì´í›„ ë³€ê²½ì‚¬í•­:"
            COMMITS=$(git log $PREV_TAG..$CURRENT_TAG --pretty=format:"- %s (%h)" | head -50)
          else
            echo "ğŸ“ ì²˜ìŒ ë¦´ë¦¬ì¦ˆì…ë‹ˆë‹¤"
            COMMITS=$(git log --pretty=format:"- %s (%h)" | head -50)
          fi

          # Release notes ìƒì„±
          RELEASE_NOTES=$(cat << 'NOTES_EOF'
          ## ğŸš€ MoAI-ADK Release v${{ steps.version.outputs.version }}

          ### ğŸ“ ë³€ê²½ì‚¬í•­

          $COMMITS

          ### ğŸ§ª í’ˆì§ˆ ê²€ì¦
          - âœ… í…ŒìŠ¤íŠ¸: 493/493 í†µê³¼
          - âœ… ì»¤ë²„ë¦¬ì§€: 85.10%
          - âœ… ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼ (ruff)
          - âœ… íƒ€ì… ì²´í¬ í†µê³¼ (mypy)
          - âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼ (bandit)

          ### ğŸ“¥ ì„¤ì¹˜ ë°©ë²•

          **uv ì‚¬ìš© (ê¶Œì¥)**
          ```bash
          uv tool install moai-adk==${{ steps.version.outputs.version }}
          ```

          **pip ì‚¬ìš©**
          ```bash
          pip install moai-adk==${{ steps.version.outputs.version }}
          ```

          ### ğŸ”— ê´€ë ¨ ë§í¬
          - [PyPI](https://pypi.org/project/moai-adk/${{ steps.version.outputs.version }}/)
          - [GitHub](https://github.com/modu-ai/moai-adk)

          ---

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          NOTES_EOF
          )

          # ì¤„ë°”ê¿ˆì´ ìˆëŠ” í™˜ê²½ë³€ìˆ˜ ì²˜ë¦¬
          {
            echo "notes<<RELEASE_EOF"
            echo "$RELEASE_NOTES"
            echo "RELEASE_EOF"
          } >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ¨ Release Pipeline Complete
        run: |
          echo "ğŸ‰ Release v${{ steps.version.outputs.version }} ìƒì„± ì™„ë£Œ!"
          echo "ğŸ”— GitHub Release: https://github.com/modu-ai/moai-adk/releases/tag/v${{ steps.version.outputs.version }}"
          echo ""
          echo "ğŸ“¤ PyPI ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ ì‹œì‘ë©ë‹ˆë‹¤..."
