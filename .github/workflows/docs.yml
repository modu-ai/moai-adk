name: Documentation

# íŠ¸ë¦¬ê±°: docs/ í´ë” ë³€ê²½ ë˜ëŠ” ìˆ˜ë™ íŠ¸ë¦¬ê±°
on:
  push:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: docs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: ğŸ“š Validate Documentation
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check markdown files exist
        run: |
          echo "ğŸ” Validating documentation structure..."
          if [ ! -d "docs" ]; then
            echo "âš ï¸  docs/ folder not found"
            exit 1
          fi

          MARKDOWN_COUNT=$(find docs -name "*.md" | wc -l)
          echo "âœ… Found $MARKDOWN_COUNT markdown files"

      - name: ğŸ”— Validate markdown links
        run: |
          echo "ğŸ”— Checking internal links..."

          # Check for broken relative links
          BROKEN=0
          while IFS= read -r file; do
            # Extract markdown links [text](url)
            if grep -o '\[.*\](.*\.md[^)]*)' "$file" | cut -d'(' -f2 | sed 's/)//' | while read -r link; do
              # Skip external links
              if [[ ! "$link" =~ ^http ]]; then
                # Resolve relative link
                LINKDIR=$(dirname "$file")
                LINKFILE="$LINKDIR/$link"
                if [ ! -f "$LINKFILE" ]; then
                  echo "âš ï¸  Broken link in $file: $link â†’ $LINKFILE"
                  BROKEN=$((BROKEN + 1))
                fi
              fi
            done; do
              [ $BROKEN -gt 0 ] && break
            done
          done < <(find docs -name "*.md")

          if [ $BROKEN -gt 0 ]; then
            echo "âš ï¸  Found broken links (warnings allowed)"
          else
            echo "âœ… All internal links valid"
          fi

      - name: ğŸ“ Check markdown formatting
        run: |
          echo "ğŸ“ Checking markdown formatting..."

          # Check for common markdown issues
          ISSUES=0

          # Check for missing spaces after # in headers
          if grep -r "^#[^ ]" docs/*.md 2>/dev/null; then
            echo "âš ï¸  Found headers without spaces"
            ISSUES=$((ISSUES + 1))
          fi

          # Check for trailing whitespace
          if grep -r "[[:space:]]$" docs/*.md 2>/dev/null; then
            echo "âš ï¸  Found trailing whitespace"
            ISSUES=$((ISSUES + 1))
          fi

          if [ $ISSUES -gt 0 ]; then
            echo "âš ï¸  Found $ISSUES formatting issues (warnings allowed)"
          else
            echo "âœ… Markdown formatting valid"
          fi

  build:
    name: ğŸ—ï¸ Build Documentation
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check for docs build config
        run: |
          echo "ğŸ” Checking documentation build configuration..."

          # Check if docs has package.json (Next.js/Nextra)
          if [ -f "docs/package.json" ]; then
            echo "âœ… Next.js/Nextra configuration found"
            echo "BUILD_TYPE=nextjs" >> $GITHUB_ENV
          # Check if docs has requirements.txt (Sphinx/MkDocs Python)
          elif [ -f "docs/requirements.txt" ]; then
            echo "âœ… Python documentation build found"
            echo "BUILD_TYPE=python" >> $GITHUB_ENV
          else
            echo "âš ï¸  No build configuration found (static docs)"
            echo "BUILD_TYPE=static" >> $GITHUB_ENV
          fi

      - name: ğŸ“¦ Setup Node.js (Next.js)
        if: env.BUILD_TYPE == 'nextjs'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-glob: "docs/package-lock.json"

      - name: ğŸ Setup Python (Python docs)
        if: env.BUILD_TYPE == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: ğŸ—ï¸ Build Next.js docs
        if: env.BUILD_TYPE == 'nextjs'
        run: |
          echo "ğŸ—ï¸  Building Next.js documentation..."
          cd docs
          npm ci
          npm run build
          echo "âœ… Next.js build successful"

      - name: ğŸ—ï¸ Build Python docs
        if: env.BUILD_TYPE == 'python'
        run: |
          echo "ğŸ—ï¸  Building Python documentation..."
          cd docs
          pip install -r requirements.txt
          # Assume Sphinx or MkDocs
          if [ -f "conf.py" ]; then
            make html
          else
            echo "âš ï¸  Unknown Python doc format"
          fi
          echo "âœ… Python docs build attempted"

      - name: ğŸ“¤ Upload build artifacts
        if: env.BUILD_TYPE != 'static'
        uses: actions/upload-artifact@v4
        with:
          name: docs-build
          path: docs/.next
          retention-days: 7

  quality-gate:
    name: âœ… Docs Quality Gate
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always()

    steps:
      - name: ğŸ“Š Check results
        run: |
          echo "ğŸ“Š Documentation Quality Gate:"
          echo ""
          echo "Validation: ${{ needs.validate.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo ""

          if [ "${{ needs.validate.result }}" == "failure" ]; then
            echo "âŒ Validation failed"
            exit 1
          fi

          if [ "${{ needs.build.result }}" == "failure" ]; then
            echo "âŒ Build failed"
            exit 1
          fi

          echo "âœ… All documentation checks passed"

      - name: ğŸ“ Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ## ğŸ“š Documentation Pipeline

          | Check | Result |
          |-------|--------|
          | Validation | ${{ needs.validate.result }} |
          | Build | ${{ needs.build.result }} |

          ### Validated
          - Markdown structure
          - Internal links
          - Formatting standards
          SUMMARY
