name: Claude Code GitHub Actions

# Claudeë¥¼ GitHub Actionsì—ì„œ ì‹¤í–‰í•˜ì—¬ ë‹¤ìŒì„ ìë™í™”:
# 1. Issue/Commentì—ì„œ PR ìë™ ìƒì„±
# 2. MoAI-ADK SPEC ë³€í™˜ + ìë™ PR
# 3. CLAUDE.md ìŠ¤íƒ€ì¼ ì¤€ìˆ˜ ê°•ì œ

# Trigger: Issue commentsì—ì„œ @claude mention
on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, ready_for_review]
    branches:
      - develop
      - main

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # ==============================================================================
  # 1. Issue Comment ê°ì§€ â†’ Claudeë¡œ ìë™ PR ìƒì„±
  # ==============================================================================

  claude-issue-handler:
    name: ğŸ¤– Claude Issue Handler
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@claude') &&
      github.event.action == 'created'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Parse @claude command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          echo "comment=$COMMENT" >> $GITHUB_OUTPUT

          # @claude mention ì¶”ì¶œ
          if echo "$COMMENT" | grep -q "@claude"; then
            echo "claude_mentioned=true" >> $GITHUB_OUTPUT

            # ëª…ë ¹ì–´ ì¶”ì¶œ (ì˜ˆ: @claude implement feature X)
            CMD=$(echo "$COMMENT" | sed 's/@claude //g' | head -1)
            echo "command=$CMD" >> $GITHUB_OUTPUT
            echo "âœ… Claude command detected: $CMD"
          fi

      - name: ğŸ¤– Claude PR Generation (Placeholder)
        if: steps.parse.outputs.claude_mentioned == 'true'
        run: |
          echo "ğŸ”„ Claude Code integration point"
          echo "Command: ${{ steps.parse.outputs.command }}"
          echo ""
          echo "Future: This will automatically:"
          echo "  1. Parse the issue description"
          echo "  2. Generate code using Claude API"
          echo "  3. Create a feature branch"
          echo "  4. Commit changes with proper tracking"
          echo "  5. Create PR with SPEC documentation"
          echo "  6. Link to MoAI-ADK workflow"
          echo ""
          echo "Current: Awaiting full Claude Code GitHub Actions integration"

      - name: ğŸ’¬ Post status comment
        if: steps.parse.outputs.claude_mentioned == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ¤– **Claude Code GitHub Actions Activated**\n\nâœ… Received command: \`${{ steps.parse.outputs.command }}\`\n\nProcessing...\n\n*Powered by Claude Code + MoAI-ADK*`
            })

  # ==============================================================================
  # 2. PR ìƒì„± ê°ì§€ â†’ Claude ìë™ ê²€ì¦ + í’ˆì§ˆ ì²´í¬
  # ==============================================================================

  claude-pr-validator:
    name: ğŸ¤– Claude PR Validator
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ“Š PR Analysis
        id: analyze
        run: |
          echo "ğŸ” Analyzing PR for MoAI-ADK compliance..."

          # Check for SPEC references
          if git diff ${{ github.event.pull_request.base.sha }} --name-only | grep -q "SPEC-"; then
            echo "spec_mentioned=true" >> $GITHUB_OUTPUT
            echo "âœ… SPEC document detected"
          fi

          # Check for tracking quality

          # Check for tests
          if git diff ${{ github.event.pull_request.base.sha }} --name-only | grep -q "test"; then
            echo "tests_added=true" >> $GITHUB_OUTPUT
            echo "âœ… Tests detected"
          fi

      - name: ğŸ’¡ Claude Quality Insights (Placeholder)
        if: always()
        run: |
          echo "âœ… SPEC Check: ${{ steps.analyze.outputs.spec_mentioned }}"
          echo "âœ… Tests: ${{ steps.analyze.outputs.tests_added }}"
          echo ""
          echo "Future enhancement:"
          echo "  â€¢ Send PR diff to Claude API"
          echo "  â€¢ Generate architectural review"
          echo "  â€¢ Check TRUST 5 principles"
          echo "  â€¢ Suggest improvements"
          echo "  â€¢ Auto-comment with insights"

      - name: ğŸ“ Post PR review comment
        uses: actions/github-script@v7
        with:
          script: |
            const analysis = {
              spec: '${{ steps.analyze.outputs.spec_mentioned }}' === 'true',
              tests: '${{ steps.analyze.outputs.tests_added }}' === 'true'
            };

            let comment = `ğŸ¤– **Claude Code Analysis**\n\n`;
            comment += `| Check | Status |\n`;
            comment += `|-------|--------|\n`;
            comment += `| SPEC Documentation | ${analysis.spec ? 'âœ…' : 'âš ï¸'} |\n`;
            comment += `| Test Coverage | ${analysis.tests ? 'âœ…' : 'âš ï¸'} |\n`;
            comment += `\n*Powered by Claude Code + MoAI-ADK*`;

            github.rest.pulls.createReview({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment,
              event: 'COMMENT'
            })

  # ==============================================================================
  # 3. Draft PR ë³€í™˜ ê°ì§€ â†’ Ready for Review ì‹œ SYNC ìë™ ì‹¤í–‰
  # ==============================================================================

  claude-sync-trigger:
    name: ğŸ¤– Claude Auto-Sync Trigger
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'ready_for_review' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“š Auto-Sync Status
        run: |
          echo "ğŸ”„ PR is Ready for Review"
          echo "Next: /alfred:3-sync should auto-trigger"
          echo ""
          echo "Auto-sync will:"
          echo "  âœ… Synchronize Living Documents"
          echo "  âœ… Update SPEC â†’ CODE â†’ TEST â†’ DOC chain"
          echo "  âœ… Validate code quality"
          echo "  âœ… Generate CHANGELOG entries"
          echo "  âœ… Prepare for merge"

      - name: ğŸ’¬ Notify ready for sync
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.createReview({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ¯ **Claude Code Auto-Sync Ready**\n\nThis PR is ready for documentation synchronization.\n\n*Next: Consider running \`/alfred:3-sync\` to finalize*`,
              event: 'COMMENT'
            })

  # ==============================================================================
  # 4. CodeRabbit ìë™ ìŠ¹ì¸ í›„ PR merge ì¤€ë¹„
  # ==============================================================================

  claude-merge-readiness:
    name: ğŸ¤– Claude Merge Readiness Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: âœ… Merge Readiness Validation
        run: |
          echo "ğŸ“Š Checking PR merge readiness..."
          echo ""
          echo "Prerequisites for merge:"
          echo "  âœ… CodeRabbit auto-review completed"
          echo "  âœ… All CI checks passed"
          echo "  âœ… Tests passing"
          echo "  âœ… TRUST 5 compliance validated"
          echo "  âœ… Code quality valid"
          echo ""
          echo "Status: Ready for merge when above conditions met"

      - name: ğŸ’¬ Post readiness comment
        uses: actions/github-script@v7
        if: github.event.action == 'opened'
        with:
          script: |
            github.rest.pulls.createReview({
              pull_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ¨ **Merge Readiness Check**\n\nThis PR will be ready to merge once:\n- CodeRabbit completes code review\n- All automated checks pass\n- TRUST 5 principles validated\n\n*Status: Monitoring... CodeRabbit will approve when criteria met*`,
              event: 'COMMENT'
            })
