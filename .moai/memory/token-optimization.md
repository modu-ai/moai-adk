# Token Optimization Strategy

Alfred의 토큰 사용을 최적화하기 위한 예산 및 전략.

## Token Budget (토큰 예산)

### Phase별 할당

| Phase | 예산 | 용도 |
|-------|------|------|
| **SPEC 생성** | 30K | 사양 작성 및 검증 |
| **TDD 구현** | 180K | RED-GREEN-REFACTOR 사이클 |
| **문서 생성** | 40K | API 문서 + 프로젝트 리포트 |
| **전체** | 250K | 기능 단위 총 예산 |

---

## `/clear` 실행 규칙

**언제 실행하는가**:

1. `/moai:1-plan` 완료 **직후** (필수)
   - 45-50K 토큰 절약
   - 깨끗한 컨텍스트 준비

2. Context > 150K 일 때
   - 오버플로우 방지
   - 다음 phase를 위한 정리

3. 대화 > 50메시지 후
   - 누적된 컨텍스트 초기화

---

## 토큰 사용량 모니터링

**Alfred의 행동**:

1. `/context` 명령으로 현재 토큰 확인
2. Phase 예산 대비 사용량 추적
3. 150K 초과 시 사용자에게 `/clear` 제안
4. 특이사항은 `/moai:9-feedback`으로 보고

---

## 파일 로드 최적화

### Good Practice ✅

- 현재 작업에 필요한 파일만 로드
- 파일 헤더 먼저 로드 (전체 내용 아님)
- 관련 부분만 선택적 로드
- 결과 캐싱

### Bad Practice ❌

- 전체 코드베이스 로드
- node_modules, .git 등 포함
- 이미지/바이너리 파일 로드
- 과거 대화 히스토리 포함

---

## Model Selection (모델 선택)

| 상황 | 선택 | 이유 |
|------|------|------|
| SPEC 생성 | Sonnet 4.5 | 고품질 설계 필요 |
| TDD 구현 | Haiku 4.5 | 빠른 실행, 비용 절약 |
| 보안 검토 | Sonnet 4.5 | 정확한 분석 필요 |
| 단순 수정 | Haiku 4.5 | 최소 비용 |

**비용 절감**: Haiku 70% 저가, 전체 60-70% 절약 가능

---

## Context 전달 전략

### Efficient Context Passing

```
Phase1 결과 → Phase2 context로 전달
   ↓
필요한 정보만 추출
   ↓
다음 에이전트에 공급
   ↓
무관한 정보 제외
```

### 최적 Context 크기

- **최소**: 작업 필수 정보만
- **최대**: 50K 토큰 이내
- **목표**: 20-30K 토큰

---

## 토큰 절약 팁

1. **Phase 분리**: `/clear`로 단계 구분
2. **선택적 로드**: 불필요한 파일 제외
3. **결과 캐싱**: 재사용 가능한 정보 보존
4. **간결한 prompt**: 불필요한 설명 제거
5. **Haiku 활용**: 복잡하지 않은 작업은 Haiku 선택

---

## 성능 목표

- SPEC 생성: 15-20K 토큰
- TDD 구현: 80-100K 토큰 (Phase당)
- 문서 생성: 20-25K 토큰
- **효율성**: 수동 대비 60-70% 절약

Alfred는 이 전략을 자동으로 적용하며, 개선사항은 `/moai:9-feedback`으로 제안한다.
