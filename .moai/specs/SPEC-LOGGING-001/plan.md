
작성일: 2025-11-13
작성자: GoosLab (spec-builder)
상태: In-Progress

---

## 개요


## 마일스톤 (우선순위 기반)

### 우선순위 높음 (Priority 1: Core Implementation)

#### M1-1: 기존 구현 검증
**목표**: 현재 코드가 SPEC 요구사항을 충족하는지 확인

**활동**:
1. `src/moai_adk/utils/logger.py` 코드 리뷰
   - SensitiveDataFilter 클래스 검증
   - setup_logger() 함수 로직 검증
   - 민감정보 패턴 정확성 확인

2. 기존 구현과 SPEC 요구사항 매핑
   - REQ-LOG-001 (로거 초기화): ✅ setup_logger() 함수로 충족
   - REQ-LOG-002 (환경별 로그 레벨): ✅ MOAI_ENV 변수 처리 확인
   - REQ-LOG-003 (민감정보 마스킹): ✅ SensitiveDataFilter로 충족
   - REQ-LOG-004 (로그 파일 자동 생성): ✅ pathlib 사용으로 충족
   - REQ-LOG-005 (구조화된 포맷): ✅ Formatter로 충족

3. 엣지 케이스 확인
   - 핸들러 중복 제거 로직 (handlers.clear())
   - 파일 생성 권한 없음 시 동작
   - 매우 큰 메시지 처리

**예상 산출물**: 검증 체크리스트, 개선 사항 목록

**담당**: tdd-implementer Agent
**완료 기준**: 모든 요구사항 충족 확인 + 문서화

---

#### M1-2: 테스트 커버리지 분석
**목표**: 기존 18개 테스트가 모든 SPEC 요구사항을 커버하는지 확인

**활동**:
1. 테스트 파일 분석 (`tests/unit/test_logger.py`)
   - 18개 테스트 케이스 매핑

2. SPEC AC(수용기준)와 테스트 매칭
   - AC-001 로거 생성: TEST-LOGGING-001-01
   - AC-002 API Key 마스킹: TEST-LOGGING-001-08
   - AC-003 이메일 마스킹: TEST-LOGGING-001-09
   - AC-004 비밀번호 마스킹: TEST-LOGGING-001-10
   - AC-005~006 환경별 레벨: TEST-LOGGING-001-12~14
   - 기타 AC 매핑

3. 누락된 테스트 케이스 식별
   - 다중 민감정보 동시 마스킹 (AC-011): ✅ TEST-LOGGING-001-11
   - 일반 로그 보존 (AC-012): ✅ TEST-LOGGING-001-17
   - 커스텀 레벨 지정 (AC-013): ❓ 확인 필요
   - 커스텀 디렉토리 (AC-014): ✅ TEST-LOGGING-001-03

**예상 산출물**: 테스트 매핑표, 추가 테스트 계획 (필요시)

**담당**: test-engineer Agent
**완료 기준**: 100% 요구사항 테스트 커버리지 확인

---

#### M1-3: 코드 정규화
**목표**: 기존 코드에 SPEC 태그 추가 및 문서 정리

**활동**:
   - `src/moai_adk/utils/logger.py` 상단

2. 함수/클래스 docstring 정리
   - SPEC 요구사항과 일치하도록 문서화
   - 예시 코드 최신화

3. 매직 값 검증
   - 로그 포맷 문자열
   - 민감정보 정규식 패턴
   - 환경변수 키 이름

**예상 산출물**: 정규화된 코드, 통합 테스트 통과 확인

**담당**: tdd-implementer Agent

---

### 우선순위 중간 (Priority 2: Validation & Documentation)

#### M2-1: 통합 테스트 실행
**목표**: 모든 단위 테스트가 통과하고 커버리지 확인

**활동**:
1. 테스트 실행
   ```bash
   pytest tests/unit/test_logger.py -v
   ```

2. 커버리지 측정
   ```bash
   pytest tests/unit/test_logger.py --cov=src/moai_adk/utils/logger --cov-report=term-missing
   ```

3. 목표 커버리지: ≥ 85%
   - 현재 예상: 95% 이상 (광범위한 테스트로 인해)

**예상 산출물**: 테스트 실행 결과, 커버리지 리포트

**담당**: test-engineer Agent
**완료 기준**: 모든 테스트 통과 + 커버리지 ≥ 85%

---

#### M2-2: 안전성 검증
**목표**: 보안 관련 요구사항 충족 확인

**활동**:
1. 민감정보 마스킹 검증
   - API Key 패턴 정확성
   - 이메일 주소 우회 불가능 확인
   - 비밀번호 패턴 완성도 검증

2. 로그 파일 접근 제어
   - 파일 권한 설정 확인 (필요시 추가)
   - 로그 파일 암호화 필요성 평가 (optional)

3. 에러 처리
   - 파일시스템 권한 없음 시 graceful degradation
   - 예외 처리 완전성

**예상 산출물**: 보안 검증 보고서

**담당**: security-expert Agent (필요시 협의)
**완료 기준**: 모든 보안 요구사항 충족 + 로그 레코드 검증

---

### 우선순위 낮음 (Priority 3: Future Enhancement)

#### M3-1: 성능 최적화 계획 (PHASE 2)
**목표**: 로깅 성능 개선안 수립

**활동** (향후 SPEC-LOGGING-002에서):
1. 민감정보 마스킹 성능 최적화
   - 정규식 컴파일 캐싱
   - 패턴 순서 최적화

2. 파일 I/O 최적화
   - 배치 로깅 고려
   - 비동기 파일 쓰기 (선택사항)

**예상 산출물**: 성능 최적화 SPEC

**담당**: performance-engineer Agent
**완료 기준**: PHASE 2에서 별도 처리

---

#### M3-2: 고급 기능 계획 (PHASE 2)
**목표**: 로깅 시스템 확장 로드맵 수립

**향후 추가 기능** (SPEC-LOGGING-002):
- 로그 로테이션 (daily/size-based)
- JSON 구조화된 로깅
- 로그 필터링 및 샘플링
- 컨텍스트 기반 로깅 (correlation ID)
- 분산 로깅 통합 준비

**담당**: spec-builder Agent
**완료 기준**: SPEC-LOGGING-002 생성

---

## 기술적 접근 방식

### 검증 전략
1. **코드 리뷰**: 현재 구현이 SPEC 요구사항과 정확히 매칭되는지 확인
2. **테스트 검증**: 18개 기존 테스트가 모든 AC를 커버하는지 확인

### 리팩토링 포인트 (필요시)
- 민감정보 패턴 최적화 (패턴 컴파일 캐싱)
- 문서화 개선
- 타입 힌팅 강화 (Python 3.10+ features)

### 회귀 테스트
- 기존 18개 테스트 모두 통과
- 추가 테스트 케이스 (AC-013, AC-014 명시적 테스트)

---

## 아키텍처 설계 방향

### 설계 원칙
1. **단순성**: 표준 라이브러리만 사용
2. **확장성**: Handler/Filter 패턴으로 확장 용이
3. **신뢰성**: 예외 처리 우선
4. **성능**: 로깅 오버헤드 최소화

### 컴포넌트 구조
```
setup_logger()
├── 레벨 결정 (MOAI_ENV)
├── Logger 객체 생성
├── 핸들러 제거 (중복 방지)
├── StreamHandler
│   ├── Formatter
│   └── SensitiveDataFilter
└── FileHandler
    ├── Formatter
    └── SensitiveDataFilter
```

### 확장성 고려
- 새로운 민감정보 패턴 추가 용이
- 커스텀 formatter 지원
- 추가 핸들러 통합 가능

---

## 위험요소 및 대응 전략

### 위험 1: 파일 잠금 (Windows)
**가능성**: 중간
**영향**: 파일 쓰기 실패
**대응**: 예외 처리 강화, graceful degradation

**액션 아이템**:
- [ ] FileHandler 예외 처리 검증
- [ ] Windows 환경 테스트 (CI/CD에서)

### 위험 2: 민감정보 패턴 누락
**가능성**: 낮음
**영향**: 보안 침해
**대응**: 정규 패턴 검토 및 테스트 강화

**액션 아이템**:
- [ ] 민감정보 패턴 매칭률 검증 (false negative 방지)
- [ ] 새로운 패턴 추가 프로토콜 수립

### 위험 3: 성능 저하 (매우 큰 메시지)
**가능성**: 낮음
**영향**: 애플리케이션 지연
**대응**: 메시지 크기 제한 또는 비동기 로깅 (Phase 2)

**액션 아이템**:
- [ ] 메시지 크기별 성능 테스트
- [ ] Phase 2에서 비동기 로깅 고려

---

## 문제 해결 플레이북

### 문제: 테스트 실패
**증상**: pytest 실행 시 일부 테스트 실패
**원인**: 환경변수 설정, 파일 권한 문제
**해결**:
1. 환경변수 확인: `echo $MOAI_ENV`
2. 로그 디렉토리 권한 확인: `ls -la .moai/logs`
3. 테스트 격리 확인: tmp_path 사용 검증

### 문제: 민감정보 마스킹 실패
**증상**: 민감정보가 로그에 노출됨
**원인**: 정규식 패턴 불일치, Filter 적용 실패
**해결**:
1. 정규식 테스트: Python REPL에서 패턴 검증
2. Filter 호출 확인: filter() 메소드 호출 확인
3. 핸들러 수 확인: 중복 핸들러 제거 검증

### 문제: 로그 파일 미생성
**증상**: .moai/logs/moai.log가 생성되지 않음
**원인**: 로그 레벨 높음, 디렉토리 권한 부족
**해결**:
1. 로그 레벨 확인: logger.level, handler.level
2. 디렉토리 생성 확인: Path.mkdir() 결과 검증
3. 메시지 레벨 확인: logger.info() 기본 INFO 레벨

---

## 분석 및 결정 로그

### 결정 1: SPEC-LOGGING-001 vs SPEC-LOGGER-MAIN-001
**상황**: 기존에 SPEC-LOGGER-MAIN-001이 존재
**검토**: 해당 SPEC은 설계 문서이고, 새로운 SPEC-LOGGING-001은 구현 명세
**결정**: 별도 SPEC 생성으로 고아 TAG 해결

### 결정 2: 현재 구현 재사용
**상황**: 광범위한 테스트를 보유한 완전한 구현 존재
**검토**: 재구현 vs 정규화 선택지
**결정**: 정규화 (태그 추가, 문서화) 선택
**근거**: 기존 구현이 SPEC 요구사항 완전 충족, 리스크 최소화

---

## 완료 체크리스트

- [ ] M1-1: 기존 구현 검증 완료
- [ ] M1-2: 테스트 커버리지 분석 완료
- [ ] M1-3: 코드 정규화 완료
- [ ] M2-1: 통합 테스트 실행 및 통과
- [ ] M2-2: 안전성 검증 완료
- [ ] M3-1: 성능 최적화 계획 수립 (Phase 2)
- [ ] M3-2: 고급 기능 계획 수립 (Phase 2)

## 담당 에이전트 및 역할

| 역할 | 담당 에이전트 | 책임 |
|------|--------------|------|
| 코드 검증 | tdd-implementer | 현재 구현 검증, 정규화 |
| 테스트 | test-engineer | 커버리지 분석, 추가 테스트 |
| 보안 | security-expert | 민감정보 마스킹 검증 |
| 성능 | performance-engineer | 성능 측정, 최적화 계획 |
| 문서화 | doc-syncer | SPEC/문서 동기화 |

---

## 참고사항

- **기존 구현 파일**: `src/moai_adk/utils/logger.py` (153줄)
- **테스트 파일**: `tests/unit/test_logger.py` (245줄, 18개 테스트)
- **목표**: 고아 TAG 해결 + 시스템 정규화

---

**수정 이력**

| 버전 | 일자 | 변경사항 | 작성자 |
|------|------|---------|--------|
| 1.0 | 2025-11-13 | 초안 작성 | GoosLab |
