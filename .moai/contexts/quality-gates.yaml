# MoAI-ADK Quality Gates
# Single Source of Truth for quality gate configurations
# Version: 1.0.0
# Last Updated: 2026-01-22

---
quality_gates:
  version: "1.0.0"
  description: "Quality gate configurations for TRUST 5 framework"
  framework: "TRUST 5"

# Gate Modes
gate_modes:
  strict_mode:
    name: "Strict Mode"
    description: "Strict quality enforcement for production code"
    use_case: "Production deployment, critical systems"

    trust_score:
      min: 0.85
      description: "Minimum overall TRUST 5 score"

    critical_issues:
      max: 0
      description: "Zero critical vulnerabilities allowed"
      block_on_failure: true

    coverage:
      min: 0.85
      description: "85% minimum test coverage"
      measurement: "pytest with coverage reporting"

    complexity:
      max: 10
      description: "Maximum cyclomatic complexity"
      measurement: "radon or similar tool"

    blocking: true
    warning_allowed: false
    auto_fix: false

    gates:
      - name: "TRUST 5 Score"
        threshold: 0.85
        blocker: true
      - name: "Critical Vulnerabilities"
        threshold: 0
        blocker: true
      - name: "Test Coverage"
        threshold: 0.85
        blocker: true
      - name: "Code Complexity"
        threshold: 10
        blocker: true

  standard_mode:
    name: "Standard Mode"
    description: "Standard quality enforcement for development code"
    use_case: "Development branches, feature implementation"

    trust_score:
      min: 0.75
      description: "Minimum overall TRUST 5 score"

    critical_issues:
      max: 0
      description: "Zero critical vulnerabilities allowed"
      block_on_failure: true

    coverage:
      min: 0.75
      description: "75% minimum test coverage"
      measurement: "pytest with coverage reporting"

    complexity:
      max: 15
      description: "Maximum cyclomatic complexity"
      measurement: "radon or similar tool"

    blocking: false
    warning_allowed: true
    auto_fix: true

    gates:
      - name: "TRUST 5 Score"
        threshold: 0.75
        blocker: false
      - name: "Critical Vulnerabilities"
        threshold: 0
        blocker: true
      - name: "Test Coverage"
        threshold: 0.75
        blocker: false
      - name: "Code Complexity"
        threshold: 15
        blocker: false

  lenient_mode:
    name: "Lenient Mode"
    description: "Lenient quality enforcement for experimental code"
    use_case: "Experimental features, prototypes, research"

    trust_score:
      min: 0.60
      description: "Minimum overall TRUST 5 score"

    critical_issues:
      max: 5
      description: "Up to 5 critical vulnerabilities allowed"
      block_on_failure: false

    coverage:
      min: 0.60
      description: "60% minimum test coverage"
      measurement: "pytest with coverage reporting"

    complexity:
      max: 20
      description: "Maximum cyclomatic complexity"
      measurement: "radon or similar tool"

    blocking: false
    warning_allowed: true
    auto_fix: true

    gates:
      - name: "TRUST 5 Score"
        threshold: 0.60
        blocker: false
      - name: "Critical Vulnerabilities"
        threshold: 5
        blocker: false
      - name: "Test Coverage"
        threshold: 0.60
        blocker: false
      - name: "Code Complexity"
        threshold: 20
        blocker: false

# Gate Definitions
gate_definitions:
  trust5_score:
    name: "TRUST 5 Overall Score"
    description: "Composite score from all five TRUST 5 pillars"
    calculation: "(Tested + Readable + Unified + Secured + Trackable) / 5"
    pillars:
      tested:
        weight: 0.20
        formula: "coverage / target_coverage"
      readable:
        weight: 0.20
        formula: "naming_score + clarity_score"
      unified:
        weight: 0.20
        formula: "formatting_compliance * import_order_compliance"
      secured:
        weight: 0.20
        formula: "1 - (critical_vulnerabilities / total_lines)"
      trackable:
        weight: 0.20
        formula: "commit_message_compliance"
    thresholds:
      excellent: 0.85
      good: 0.75
      acceptable: 0.60

  critical_vulnerabilities:
    name: "Critical Security Vulnerabilities"
    description: "Count of critical OWASP Top 10 vulnerabilities"
    source: "expert-security agent analysis"
    owasp_categories:
      - "A01: Broken Access Control"
      - "A02: Cryptographic Failures"
      - "A03: Injection"
      - "A04: Insecure Design"
      - "A05: Security Misconfiguration"
      - "A06: Vulnerable Components"
      - "A07: Authentication Failures"
      - "A08: Software and Data Integrity Failures"
      - "A09: Security Logging Failures"
      - "A10: Server-Side Request Forgery"
    severity_levels:
      - "critical"
      - "high"
      - "medium"
      - "low"
      - "info"

  test_coverage:
    name: "Test Coverage Percentage"
    description: "Percentage of code covered by tests"
    measurement: "pytest with coverage reporting"
    command: "pytest --cov=src --cov-report=term-missing"
    targets:
      - "specification_tests: Domain behavior validation"
      - "characterization_tests: Legacy behavior preservation"
    thresholds:
      excellent: 0.85
      good: 0.75
      acceptable: 0.60

  code_complexity:
    name: "Cyclomatic Complexity"
    description: "Measure of code complexity"
    measurement: "radon or similar tool"
    command: "radon cc src/ -a"
    thresholds:
      excellent: 10
      good: 15
      acceptable: 20

# Gate Execution
gate_execution:
  pre_commit:
    description: "Run before each commit"
    gates:
      - name: "Test Coverage"
        command: "pytest --cov=src --cov-report=term-missing"
        threshold: "varies by mode"
        block_on_failure: "varies by mode"
      - name: "Code Formatting"
        command: "black src/ && isort src/"
        threshold: "100% compliance"
        auto_fix: true
      - name: "Linting"
        command: "ruff check src/"
        threshold: "0 errors"
        block_on_failure: true
      - name: "Import Order"
        command: "isort --check-only src/"
        threshold: "100% compliance"
        auto_fix: true

  ci_cd:
    description: "Run in CI/CD pipeline"
    gates:
      - name: "TRUST 5 Score"
        command: "Use the manager-quality subagent"
        threshold: "varies by mode"
        block_on_failure: "varies by mode"
      - name: "Test Coverage"
        command: "pytest --cov=src --cov-report=xml"
        threshold: "varies by mode"
        block_on_failure: "varies by mode"
      - name: "Security Scan"
        command: "Use the expert-security subagent"
        threshold: "0 critical vulnerabilities"
        block_on_failure: true
      - name: "Type Checking"
        command: "mypy src/"
        threshold: "0 errors"
        block_on_failure: false

  manual_review:
    description: "Run during manual code review"
    gates:
      - name: "TRUST 5 Score"
        command: "Use the manager-quality subagent"
        threshold: "varies by mode"
        block_on_failure: false
      - name: "Code Review"
        command: "Manual review by team member"
        threshold: "Approval required"
        block_on_failure: true
      - name: "Documentation"
        command: "Check documentation completeness"
        threshold: "100% coverage"
        block_on_failure: false

# Gate Outcomes
gate_outcomes:
  pass:
    description: "All gates passed"
    action: "Proceed to next phase"
    notification: "Success message with details"

  pass_with_warnings:
    description: "Non-blocking gates failed"
    action: "Proceed with warnings"
    notification: "Warning message with details"
    conditions:
      - "Standard mode with non-blocking failures"
      - "Lenient mode with any failures"

  fail:
    description: "Blocking gates failed"
    action: "Block progress, require fixes"
    notification: "Failure message with details"
    conditions:
      - "Strict mode with any failures"
      - "Any mode with critical vulnerabilities"
      - "Any mode with blocking gate failures"

# Integration with Workflow Phases
phase_integration:
  plan_phase:
    quality_mode: "standard_mode"
    gates:
      - "Requirement clarity"
      - "EARS format compliance"
      - "Stakeholder approval"
      - "Technical feasibility"

  run_phase:
    quality_mode: "strict_mode"
    gates:
      - "TRUST 5 score >= 0.85"
      - "Test coverage >= 85%"
      - "0 critical vulnerabilities"
      - "Code complexity <= 10"
      - "Behavior preservation verified"

  sync_phase:
    quality_mode: "standard_mode"
    gates:
      - "Documentation completeness"
      - "API documentation accuracy"
      - "CHANGELOG entry"
      - "Link validation"
      - "README updated"

# Configuration
configuration:
  default_mode: "standard_mode"
  mode_selection:
    production: "strict_mode"
    development: "standard_mode"
    experimental: "lenient_mode"

  override_rules:
    - "Project owner can override mode"
    - "Critical systems always use strict_mode"
    - "Experimental features can use lenient_mode"
    - "Document reason for override"

# Best Practices
best_practices:
  gate_design:
    - "Keep gates simple and measurable"
    - "Use automated tools where possible"
    - "Provide clear failure messages"
    - "Suggest fixes for failures"
    - "Track gate pass rates over time"

  mode_selection:
    - "Start with standard_mode"
    - "Use strict_mode for production code"
    - "Use lenient_mode only for experiments"
    - "Document mode selection rationale"
    - "Review mode effectiveness periodically"

  gate_maintenance:
    - "Review gate thresholds quarterly"
    - "Update gates based on team feedback"
    - "Add new gates as needed"
    - "Remove ineffective gates"
    - "Track gate performance metrics"

# Examples
examples:
  production_deployment:
    mode: "strict_mode"
    gates:
      - "TRUST 5 score >= 0.85"
      - "Test coverage >= 85%"
      - "0 critical vulnerabilities"
      - "Code complexity <= 10"
    outcome: "Pass required for deployment"

  feature_development:
    mode: "standard_mode"
    gates:
      - "TRUST 5 score >= 0.75"
      - "Test coverage >= 75%"
      - "0 critical vulnerabilities"
      - "Code complexity <= 15"
    outcome: "Warnings allowed, proceed with caution"

  experimental_prototype:
    mode: "lenient_mode"
    gates:
      - "TRUST 5 score >= 0.60"
      - "Test coverage >= 60%"
      - "<= 5 critical vulnerabilities"
      - "Code complexity <= 20"
    outcome: "Most failures allowed, experimental context"

# Error Handling
error_handling:
  gate_failure:
    action: "Block progress and provide guidance"
    recovery:
      - "Identify failing gate"
      - "Explain failure reason"
      - "Suggest fixes"
      - "Provide examples"
      - "Offer auto-fix if available"

  timeout:
    action: "Mark as failed and notify"
    recovery:
      - "Log timeout details"
      - "Suggest retry with extended timeout"
      - "Check for resource constraints"

  tool_unavailable:
    action: "Skip gate with warning"
    recovery:
      - "Log missing tool"
      - "Suggest tool installation"
      - "Mark gate as skipped"
