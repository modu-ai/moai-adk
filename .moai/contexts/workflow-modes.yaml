# MoAI-ADK Workflow Modes
# Single Source of Truth for Plan-Run-Sync workflow definitions
# Version: 1.0.0
# Last Updated: 2026-01-22

---
workflows:
  version: "1.0.0"
  description: "Three-phase SPEC-First DDD workflow for quality-driven development"
  methodology: "SPEC-First Domain-Driven Development"

# Mode Definitions
modes:
  plan:
    name: "Plan Phase"
    command: "/moai:1-plan"
    agent: "manager-spec"
    duration: "variable"
    purpose: "Create comprehensive specification document"

    token_budget:
      allocation: 30000
      strategy: "minimal_context"
      post_action: "execute /clear"
      saving: "45-50K tokens for implementation"

    input_requirements:
      - "User request or feature description"
      - "Project context and goals"
      - "Stakeholder requirements"
      - "Constraints and dependencies"

    output_deliverables:
      spec_document:
        path: ".moai/specs/SPEC-XXX/spec.md"
        format: "EARS format requirements"
        sections:
          - "Executive Summary"
          - "Requirements (EARS format)"
          - "Acceptance Criteria"
          - "Technical Approach"
          - "Dependencies"
          - "Risk Assessment"

    required_agent:
      primary: "manager-spec"
      expertise:
        - "Requirements analysis"
        - "EARS format specification"
        - "Stakeholder communication"
        - "Technical feasibility assessment"

    workflow_steps:
      1:
        action: "Analyze user request"
        description: "Understand requirements and constraints"
        tools: ["Read", "Grep", "Glob"]

      2:
        action: "Review existing specs"
        description: "Check for related or conflicting specifications"
        tools: ["Read", "Grep"]

      3:
        action: "Create SPEC document"
        description: "Generate specification using EARS format"
        tools: ["Write", "Edit"]

      4:
        action: "Validate completeness"
        description: "Ensure all required sections are complete"
        tools: ["Read", "Grep"]

      5:
        action: "Execute /clear"
        description: "Clear context to save tokens for implementation"
        tools: ["Bash"]

    success_criteria:
      - "All requirements documented in EARS format"
      - "Acceptance criteria clearly defined"
      - "Technical approach feasible"
      - "Dependencies identified"
      - "Risks assessed"
      - "Stakeholder approval obtained"

  run:
    name: "Run Phase"
    command: "/moai:2-run SPEC-XXX"
    agent: "manager-ddd"
    duration: "variable (iterative)"
    purpose: "Implement specification with behavior preservation"

    token_budget:
      allocation: 180000
      strategy: "selective_file_loading"
      loading: "implementation_relevant_only"
      benefit: "70% larger implementations within budget"

    input_requirements:
      - "Valid SPEC document ID"
      - "Existing codebase structure"
      - "Test suite (if exists)"
      - "TRUST 5 quality standards"

    output_deliverables:
      implementation:
        description: "Working implementation of specification"
        location: "Source code repository"
      tests:
        description: "Comprehensive test coverage"
        coverage_target: 85
        types:
          - "Specification tests (domain behavior)"
          - "Characterization tests (legacy behavior)"
      documentation:
        description: "Code documentation and comments"
        standard: "English language comments"

    required_agent:
      primary: "manager-ddd"
      methodology: "ANALYZE-PRESERVE-IMPROVE"
      expertise:
        - "Domain-driven design"
        - "Behavior preservation"
        - "Test-driven development"
        - "Refactoring with safety"

    ddd_cycle:
      analyze:
        description: "Understand existing behavior and code structure"
        actions:
          - "Read existing code"
          - "Identify dependencies"
          - "Map domain boundaries"
          - "Document current behavior"

      preserve:
        description: "Create characterization tests for existing behavior"
        actions:
          - "Write characterization tests"
          - "Capture current behavior"
          - "Verify test coverage"
          - "Document test outcomes"

      improve:
        description: "Implement changes with behavior preservation"
        actions:
          - "Make small, incremental changes"
          - "Run characterization tests after each change"
          - "Refactor with test validation"
          - "Maintain behavior integrity"

    workflow_steps:
      1:
        action: "Load SPEC document"
        description: "Read and understand specification requirements"
        tools: ["Read"]

      2:
        action: "Analyze codebase"
        description: "Understand existing structure and dependencies"
        tools: ["Read", "Grep", "Glob"]

      3:
        action: "Create characterization tests"
        description: "Preserve existing behavior before changes"
        tools: ["Write", "Edit", "Bash"]

      4:
        action: "Implement specification"
        description: "Make incremental improvements with test validation"
        tools: ["Read", "Write", "Edit", "Bash"]

      5:
        action: "Run quality validation"
        description: "Verify TRUST 5 compliance"
        tools: ["Bash", "Task"]

      6:
        action: "Validate coverage"
        description: "Ensure 85%+ test coverage achieved"
        tools: ["Bash"]

    success_criteria:
      - "All SPEC requirements implemented"
      - "Characterization tests passing"
      - "85%+ code coverage achieved"
      - "TRUST 5 quality gates passed"
      - "No behavior regressions"
      - "Code follows documentation standards"

  sync:
    name: "Sync Phase"
    command: "/moai:3-sync SPEC-XXX"
    agent: "manager-docs"
    duration: "variable"
    purpose: "Generate documentation and prepare for deployment"

    token_budget:
      allocation: 40000
      strategy: "result_caching"
      optimization: "template_reuse"
      reduction: "60% fewer redundant file reads"

    input_requirements:
      - "Completed implementation"
      - "Test results"
      - "SPEC document reference"
      - "API signatures and interfaces"

    output_deliverables:
      documentation:
        api_docs:
          description: "API reference documentation"
          format: "Markdown or Nextra"
        readme:
          description: "User-facing README"
          sections:
            - "Overview"
            - "Installation"
            - "Usage"
            - "API Reference"
            - "Examples"
        changelog:
          description: "CHANGELOG.md entry"
          format: "Keep-a-Changelog"

      pull_request:
        description: "GitHub Pull Request with documentation"
        includes:
          - "Summary of changes"
          - "Link to SPEC document"
          - "Test results"
          - "Documentation updates"

    required_agent:
      primary: "manager-docs"
      expertise:
        - "Technical writing"
        - "API documentation"
        - "Markdown formatting"
        - "Nextra integration"

    workflow_steps:
      1:
        action: "Generate API documentation"
        description: "Create comprehensive API reference"
        tools: ["Read", "Write", "Edit"]

      2:
        action: "Update README"
        description: "Document changes and usage"
        tools: ["Read", "Write", "Edit"]

      3:
        action: "Update CHANGELOG"
        description: "Document version changes"
        tools: ["Read", "Write", "Edit"]

      4:
        action: "Create Pull Request"
        description: "Prepare PR with all documentation"
        tools: ["Bash"]

      5:
        action: "Validate documentation"
        description: "Ensure completeness and accuracy"
        tools: ["Read", "Grep"]

    success_criteria:
      - "API documentation complete"
      - "README updated with usage examples"
      - "CHANGELOG entry added"
      - "Pull request created"
      - "Documentation follows standards"
      - "All links verified"

# Integration Patterns
integration:
  phase_transitions:
    plan_to_run:
      trigger: "SPEC document approved"
      action: "Execute /clear, then /moai:2-run SPEC-XXX"
      handoff:
        - "SPEC document path"
        - "Requirements summary"
        - "Acceptance criteria"
        - "Technical approach notes"

    run_to_sync:
      trigger: "Implementation complete and tests passing"
      action: "Execute /moai:3-sync SPEC-XXX"
      handoff:
        - "SPEC reference"
        - "Implementation summary"
        - "Test results"
        - "API changes"

  context_preservation:
    session_state:
      - "SPEC document ID"
      - "Active phase"
      - "Completed steps"
      - "Key decisions"
      - "Stakeholder feedback"

    cross_phase_references:
      - "Link to SPEC document"
      - "Test coverage reports"
      - "Quality gate results"
      - "Documentation artifacts"

# Best Practices
best_practices:
  plan_phase:
    - "Involve stakeholders early"
    - "Use EARS format for clarity"
    - "Document assumptions"
    - "Identify risks upfront"
    - "Get approval before proceeding"

  run_phase:
    - "Start with characterization tests"
    - "Make small, incremental changes"
    - "Run tests frequently"
    - "Preserve behavior always"
    - "Follow TRUST 5 standards"

  sync_phase:
    - "Document as you code"
    - "Keep API docs current"
    - "Update README consistently"
    - "Maintain CHANGELOG"
    - "Create comprehensive PRs"

# Examples
examples:
  simple_feature:
    description: "Implementing a simple user feature"
    workflow:
      plan:
        - "Create SPEC-001 with user story"
        - "Define acceptance criteria"
        - "Document technical approach"
      run:
        - "Write characterization tests"
        - "Implement feature logic"
        - "Add unit tests"
        - "Verify 85%+ coverage"
      sync:
        - "Generate API docs"
        - "Update README"
        - "Add CHANGELOG entry"
        - "Create PR"

  complex_refactoring:
    description: "Major codebase refactoring"
    workflow:
      plan:
        - "Create SPEC-002 with refactoring scope"
        - "Identify affected modules"
        - "Define migration strategy"
      run:
        - "Characterize existing behavior"
        - "Refactor incrementally"
        - "Maintain test coverage"
        - "Validate behavior preservation"
      sync:
        - "Document architecture changes"
        - "Update migration guide"
        - "Record breaking changes"
        - "Create detailed PR"

# Quality Gates
quality_gates:
  plan_phase:
    - "SPEC document complete"
    - "EARS format validated"
    - "Stakeholder approval obtained"
    - "Technical feasibility confirmed"

  run_phase:
    - "Characterization tests passing"
    - "Specification tests passing"
    - "85%+ coverage achieved"
    - "TRUST 5 score >= 0.85"
    - "No critical vulnerabilities"

  sync_phase:
    - "API documentation complete"
    - "README updated"
    - "CHANGELOG entry added"
    - "All links verified"
    - "PR created and ready"

# Error Handling
error_handling:
  plan_phase:
    spec_incomplete:
      action: "Request missing information from user"
      recovery: "Update SPEC and re-validate"

    requirements_conflict:
      action: "Identify conflicting requirements"
      recovery: "Facilitate stakeholder resolution"

  run_phase:
    test_failure:
      action: "Analyze failure and fix implementation"
      recovery: "Re-run tests until passing"

    coverage_below_target:
      action: "Identify uncovered code paths"
      recovery: "Add tests for uncovered paths"

    behavior_regression:
      action: "Identify breaking change"
      recovery: "Restore behavior and update tests"

  sync_phase:
    documentation_incomplete:
      action: "Identify missing documentation"
      recovery: "Generate missing docs"

    link_verification_failed:
      action: "Fix broken links"
      recovery: "Update links and re-verify"
