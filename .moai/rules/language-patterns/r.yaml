# R Language Patterns
# Common patterns for R 4.4+ development
# Version: 1.0.0
# Last Updated: 2026-01-23

---
language: "r"
version: "4.4+"
description: "Common patterns for modern R development"

# Data Manipulation
data_manipulation:
  tidyverse:
    name: "Tidyverse"
    description: "Data manipulation with dplyr and tidyr"
    example: |
      library(tidyverse)

      # Data transformation pipeline
      result <- data %>%
        filter(year >= 2020) %>%
        mutate(
          growth_rate = (value - lag(value)) / lag(value),
          category = case_when(
            growth_rate > 0.1 ~ "high",
            growth_rate > 0 ~ "moderate",
            TRUE ~ "negative"
          )
        ) %>%
        group_by(region, category) %>%
        summarise(
          count = n(),
          avg_value = mean(value, na.rm = TRUE),
          .groups = "drop"
        ) %>%
        arrange(desc(avg_value))

  data_table:
    name: "data.table"
    description: "High-performance data manipulation"
    example: |
      library(data.table)

      dt <- as.data.table(data)

      # Fast grouping and aggregation
      result <- dt[
        year >= 2020,
        .(count = .N,
          avg_value = mean(value, na.rm = TRUE)),
        by = .(region, category)
      ][order(-avg_value)]

# Visualization
visualization:
  ggplot2:
    name: "ggplot2"
    description: "Grammar of graphics"
    example: |
      library(ggplot2)

      ggplot(data, aes(x = date, y = value, color = category)) +
        geom_line(linewidth = 1) +
        geom_point(size = 2) +
        facet_wrap(~region, scales = "free_y") +
        scale_color_brewer(palette = "Set1") +
        labs(
          title = "Value Trends by Region",
          x = "Date",
          y = "Value",
          color = "Category"
        ) +
        theme_minimal() +
        theme(
          legend.position = "bottom",
          plot.title = element_text(hjust = 0.5)
        )

# Shiny Applications
shiny:
  modules:
    name: "Shiny Modules"
    description: "Reusable UI components"
    example: |
      # Module UI
      filterModuleUI <- function(id) {
        ns <- NS(id)
        tagList(
          selectInput(ns("category"), "Category", choices = NULL),
          dateRangeInput(ns("dates"), "Date Range")
        )
      }

      # Module Server
      filterModuleServer <- function(id, data) {
        moduleServer(id, function(input, output, session) {
          observe({
            choices <- unique(data()$category)
            updateSelectInput(session, "category", choices = choices)
          })

          reactive({
            data() %>%
              filter(
                category == input$category,
                date >= input$dates[1],
                date <= input$dates[2]
              )
          })
        })
      }

      # Usage
      ui <- fluidPage(
        filterModuleUI("filter"),
        plotOutput("plot")
      )

      server <- function(input, output, session) {
        data <- reactive({ load_data() })
        filtered <- filterModuleServer("filter", data)
        output$plot <- renderPlot({ plot_data(filtered()) })
      }

# Statistical Modeling
modeling:
  tidymodels:
    name: "tidymodels"
    description: "Tidy machine learning workflow"
    example: |
      library(tidymodels)

      # Define recipe
      recipe <- recipe(target ~ ., data = train_data) %>%
        step_normalize(all_numeric_predictors()) %>%
        step_dummy(all_nominal_predictors())

      # Define model
      model <- rand_forest(
        trees = tune(),
        mtry = tune()
      ) %>%
        set_engine("ranger") %>%
        set_mode("classification")

      # Create workflow
      workflow <- workflow() %>%
        add_recipe(recipe) %>%
        add_model(model)

      # Tune hyperparameters
      tune_results <- workflow %>%
        tune_grid(
          resamples = vfold_cv(train_data, v = 5),
          grid = 20
        )

      # Finalize and fit
      best_params <- select_best(tune_results, metric = "accuracy")
      final_model <- workflow %>%
        finalize_workflow(best_params) %>%
        fit(train_data)

# Package Development
package:
  structure:
    description: "R package structure"
    example: |
      # DESCRIPTION file
      Package: mypackage
      Title: What the Package Does
      Version: 0.1.0
      Authors@R: person("Name", "Surname", email = "email@example.com",
                        role = c("aut", "cre"))
      Description: A longer description of what the package does.
      License: MIT + file LICENSE
      Encoding: UTF-8
      Roxygen: list(markdown = TRUE)
      RoxygenNote: 7.2.3
      Imports:
          dplyr,
          ggplot2
      Suggests:
          testthat (>= 3.0.0)

  documentation:
    description: "roxygen2 documentation"
    example: |
      #' Calculate summary statistics
      #'
      #' @param data A data frame
      #' @param group_var Column to group by
      #' @param value_var Column to summarize
      #'
      #' @return A tibble with summary statistics
      #' @export
      #'
      #' @examples
      #' summarize_data(mtcars, "cyl", "mpg")
      summarize_data <- function(data, group_var, value_var) {
        data %>%
          group_by(.data[[group_var]]) %>%
          summarise(
            mean = mean(.data[[value_var]], na.rm = TRUE),
            sd = sd(.data[[value_var]], na.rm = TRUE),
            n = n()
          )
      }

# Testing Patterns
testing:
  testthat:
    name: "testthat"
    example: |
      library(testthat)

      test_that("summarize_data calculates correct statistics", {
        data <- tibble(
          group = c("A", "A", "B", "B"),
          value = c(1, 2, 3, 4)
        )

        result <- summarize_data(data, "group", "value")

        expect_equal(nrow(result), 2)
        expect_equal(result$mean[result$group == "A"], 1.5)
        expect_equal(result$mean[result$group == "B"], 3.5)
      })

# Best Practices
best_practices:
  code_style:
    - "Use styler for code formatting"
    - "Use lintr for static analysis"
    - "Use tidyverse style guide"
    - "Use pipe operator %>% or |>"

  data_science:
    - "Use tidymodels for ML workflows"
    - "Use targets for pipeline management"
    - "Document with roxygen2"
    - "Test with testthat"
