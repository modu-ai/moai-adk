# MoAI-ADK Token Budget Management
# Single Source of Truth for token optimization strategies
# Version: 1.0.0
# Last Updated: 2026-01-22

---
system:
  version: "1.0.0"
  description: "Strategic allocation and monitoring of 200K token context window"
  context_window: 200000
  emergency_reserve: 30000

# Budget Breakdown (200K tokens)
budget_breakdown:
  system_instructions:
    allocation: 15000
    percentage: 7.5
    components:
      claude_md: 8000
      command_definitions: 4000
      skill_metadata: 3000
    description: "System prompt and instructions"

  active_conversation:
    allocation: 80000
    percentage: 40
    components:
      recent_messages: 50000
      context_cache: 20000
      active_references: 10000
    description: "Current conversation context"

  reference_context:
    allocation: 50000
    percentage: 25
    components:
      project_structure: 15000
      related_skills: 20000
      tool_definitions: 15000
    description: "Progressive disclosure context"

  emergency_reserve:
    allocation: 55000
    percentage: 27.5
    components:
      session_state_snapshot: 10000
      cross_references: 15000
      error_recovery: 20000
      free_buffer: 10000
    description: "Emergency recovery buffer"

# Monitoring Thresholds
monitoring_thresholds:
  critical:
    threshold: 85
    action: "emergency_compression"
    description: "Trigger emergency compression and execute /clear"
    color: "red"

  warning:
    threshold: 75
    action: "defer_non_critical"
    description: "Defer non-critical context and warn user"
    color: "yellow"

  tracking:
    threshold: 60
    action: "track_growth"
    description: "Track context growth patterns"
    color: "green"

# Phase-Specific Budgets
phase_budgets:
  spec_phase:
    allocation: 30000
    strategy: "load_requirements_only"
    post_action: "execute /clear"
    saving: "45-50K tokens"
    description: "Specification phase requires minimal context"
    context_requirements:
      - "User requirements"
      - "Project structure overview"
      - "Relevant existing specs"
      - "EARS format reference"

  ddd_phase:
    allocation: 180000
    strategy: "selective_file_loading"
    loading: "load_only_implementation_relevant"
    benefit: "70% larger implementations within budget"
    description: "Implementation requires deep context but not full codebase"
    context_requirements:
      - "Full SPEC document"
      - "Target implementation files"
      - "Related dependencies"
      - "Test suite"
      - "TRUST 5 framework"

  docs_phase:
    allocation: 40000
    strategy: "result_caching"
    optimization: "template_reuse"
    reduction: "60% fewer redundant file reads"
    description: "Documentation builds on completed work artifacts"
    context_requirements:
      - "Completed implementation"
      - "Test results"
      - "API signatures"
      - "Documentation templates"
      - "Existing docs"

  total_budget:
    allocation: 250000
    strategy: "phase_separation"
    mechanism: "context_reset_between_phases"
    benefit: "2-3x larger projects within same budget"
    description: "Clean context boundaries prevent token bloat"

# Token Saving Strategies
saving_strategies:
  phase_separation:
    description: "Execute /clear between phases"
    trigger_points:
      - "After /moai:1-plan completion"
      - "When context exceeds 150K tokens"
      - "After 50+ messages"
      - "Before major phase transitions"
      - "During model switches"
    savings: "45-50K tokens per phase"

  selective_loading:
    description: "Load only necessary files"
    principles:
      - "Read files on-demand"
      - "Avoid loading entire directories"
      - "Use specific Glob patterns"
      - "Limit scope to relevant modules"
    savings: "30-40% token reduction"

  context_optimization:
    description: "Target 20-30K tokens per context"
    techniques:
      - "Use TAGs for efficient references"
      - "Avoid repetitive explanations"
      - "Summarize previous decisions"
      - "Progressive disclosure loading"
    target: "20-30K tokens"

  model_selection:
    description: "Choose model based on task complexity"
    models:
      sonnet:
        use_case: "Quality-critical tasks"
        tokens: "Full 200K budget"
      haiku:
        use_case: "Speed and cost optimization"
        cost_reduction: "70% cheaper"
        savings: "60-70% total savings"

# Aggressive /clear Strategy
clear_strategy:
  mandatory_points:
    - "After /moai:1-plan completion"
    - "When context exceeds 150K tokens"
    - "When conversation exceeds 50 messages"
    - "Before major phase transitions"
    - "During model switches (Haiku to Sonnet)"

  optional_points:
    - "After completing a major feature"
    - "When switching between unrelated tasks"
    - "Before starting a new agent session"
    - "After reaching 75% threshold"

  preservation:
    - "Store agent_id for MCP context restoration"
    - "Save session state before clearing"
    - "Maintain critical references via TAGs"
    - "Document decisions before clearing"

# Context Tagging (TAGs)
context_tagging:
  purpose: "Efficient reference mechanism to reduce repetition"
  format: "@TAG-001"
  examples:
    bad:
      - "The user configuration from the previous 20 messages indicates..."
      - "As we discussed in the conversation history about the project..."
    good:
      - "Refer to @CONFIG-001 for user preferences"
      - "See @SPEC-003 for requirements details"
      - "Use @TRUST-5 for quality standards"

  tag_types:
    config:
      prefix: "CONFIG"
      description: "Configuration and settings"
    spec:
      prefix: "SPEC"
      description: "Specification documents"
    trust:
      prefix: "TRUST"
      description: "Quality framework references"
    session:
      prefix: "SESSION"
      description: "Session state information"

# Progressive Summarization
progressive_summarization:
  concept: "Compress context while preserving key information"
  target_ratio: 0.3
  process:
    - "Extract key sentences"
    - "Add pointers to original content"
    - "Store original in session archive"
    - "Maintain recovery capability"
  example:
    original: 50000
    compressed: 15000
    saved: 35000
    method: "Key sentence extraction with reference pointers"

# Session State Persistence
session_state:
  layers:
    l1_context_aware:
      description: "Context-Aware Layer for Claude 4.5+"
      components:
        - "Token budget tracking"
        - "Context window position"
        - "Auto-summarization triggers"
        - "Model-specific optimizations"

    l2_active_context:
      description: "Active Context for current task"
      components:
        - "Current task variables"
        - "Active scope"
        - "Work in progress"

    l3_session_history:
      description: "Session History for recent actions"
      components:
        - "Recent actions"
        - "Key decisions"
        - "Action outcomes"

    l4_project_state:
      description: "Project State for SPEC progress"
      components:
        - "SPEC progress"
        - "Milestones achieved"
        - "Pending tasks"

    l5_user_context:
      description: "User Context for preferences"
      components:
        - "User preferences"
        - "Language setting"
        - "Expertise level"

    l6_system_state:
      description: "System State for tools and environment"
      components:
        - "Available tools"
        - "Permissions"
        - "Environment configuration"

# Multi-Agent Handoff Protocols
handoff_protocols:
  package_contents:
    handoff_id:
      type: "string"
      description: "Unique identifier for handoff transaction"

    from_agent:
      type: "string"
      description: "Agent initiating handoff"

    to_agent:
      type: "string"
      description: "Agent receiving handoff"

    session_context:
      session_id:
        type: "string"
        description: "Current session identifier"
      model:
        type: "string"
        description: "Active model (sonnet/haiku)"
      context_position:
        type: "integer"
        description: "Current token position"
      available_tokens:
        type: "integer"
        description: "Remaining token budget"
      user_language:
        type: "string"
        description: "User's conversation language"

    task_context:
      spec_id:
        type: "string"
        description: "Active SPEC identifier"
      current_phase:
        type: "string"
        description: "Current workflow phase"
      completed_steps:
        type: "array"
        description: "List of completed steps"
      next_step:
        type: "string"
        description: "Next step to execute"

    recovery_info:
      last_checkpoint:
        type: "string"
        description: "Last checkpoint identifier"
      recovery_tokens_reserved:
        type: "integer"
        description: "Tokens reserved for recovery"
      session_fork_available:
        type: "boolean"
        description: "Whether session fork is available"

  handoff_validation:
    checks:
      - "Token budget check (minimum 30K buffer)"
      - "Agent compatibility verification"
      - "Context compression trigger if needed"
      - "Session state preservation"

# Best Practices
best_practices:
  monitoring:
    - "Track token usage continuously"
    - "Alert at 60% threshold"
    - "Warn at 75% threshold"
    - "Compress at 85% threshold"

  loading:
    - "Load files on-demand, not upfront"
    - "Use specific Glob patterns"
    - "Limit scope to relevant modules"
    - "Avoid loading entire directories"

  compression:
    - "Summarize previous decisions"
    - "Use TAGs for efficient references"
    - "Archive old conversation history"
    - "Maintain recovery capability"

  phase_management:
    - "Execute /clear between phases"
    - "Save session state before clearing"
    - "Document key decisions"
    - "Restore context after clearing"

# Examples
examples:
  spec_phase:
    description: "Token-efficient specification phase"
    budget: 30000
    actions:
      - "Load user requirements only"
      - "Read project structure overview"
      - "Review existing specs"
      - "Create new SPEC document"
      - "Execute /clear after completion"
    savings: "45-50K tokens for implementation"

  ddd_phase:
    description: "Token-efficient implementation phase"
    budget: 180000
    actions:
      - "Load full SPEC document"
      - "Load target implementation files only"
      - "Load related dependencies"
      - "Load test suite"
      - "Load TRUST 5 framework"
      - "Avoid loading entire codebase"
    benefit: "70% larger implementations within budget"

  emergency_compression:
    description: "Emergency token recovery"
    trigger: "85% threshold exceeded"
    actions:
      - "Summarize recent conversation (50K -> 15K)"
      - "Archive old messages to session history"
      - "Create TAGs for key references"
      - "Execute /clear if necessary"
    recovery: "35-40K tokens saved"

# Validation Rules
validation:
  budget_compliance:
    - "Phase allocations must not exceed total budget"
    - "Emergency reserve must be maintained"
    - "Context must not exceed 200K tokens"
    - "Phase separation must be enforced"

  loading_efficiency:
    - "Load files on-demand only"
    - "Use specific Glob patterns"
    - "Limit scope to relevant modules"
    - "Avoid redundant file reads"

  monitoring_active:
    - "Track token usage continuously"
    - "Alert at defined thresholds"
    - "Log compression actions"
    - "Report savings achieved"
