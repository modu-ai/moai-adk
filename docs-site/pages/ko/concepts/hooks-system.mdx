---
title: Hooks 시스템 (이벤트 기반 자동화)
description: MoAI-ADK Hooks - Claude Code 이벤트 기반 자동화 및 진시성 시스템
---

# Hooks 시스템: 이벤트 기반 자동화

Hooks는 MoAI-ADK의 **자동화 및 진시성(Real-time Responsiveness)** 계층입니다. Claude Code의 특정 이벤트가 발생할 때 자동으로 실행되어 개발 워크플로우를 향상시킵니다.

## 개요

**목적**: Claude Code 이벤트 감지 → 자동 실행 → 진시 컨텍스트 제공

**핵심 특징**:
- **이벤트 기반**: SessionStart, UserPromptSubmit, PreToolUse 등 8가지 이벤트 지원
- **초고속 응답**: 5초 글로벌 타임아웃으로 무한 대기 방지
- **우아한 성능 저하**: 일부 작업 실패 시에도 기본 기능은 계속 작동
- **진시 컨텍스트**: 사용자 입력 분석 → 필요한 문서 자동 로드 (JIT Retrieval)
- **검증 포인트**: 위험 작업 감지 → 자동 체크포인트 생성

---

## 아키텍처: 3계층 설계

```
┌──────────────────────────────────────────────────────┐
│ 1️⃣ Router (Alfred Hooks)                             │
├──────────────────────────────────────────────────────┤
│ - CLI 인수 파싱 (event_name)                         │
│ - JSON I/O (stdin/stdout)                            │
│ - 이벤트별 핸들러 라우팅                              │
│ - 5초 글로벌 타임아웃 관리                            │
└──────────────────────┬───────────────────────────────┘
                       ▼
┌──────────────────────────────────────────────────────┐
│ 2️⃣ Handlers (handlers/)                             │
├──────────────────────────────────────────────────────┤
│ - session.py: SessionStart, SessionEnd               │
│ - user.py: UserPromptSubmit                          │
│ - tool.py: PreToolUse, PostToolUse                   │
│ - notification.py: Notification, Stop, SubagentStop  │
└──────────────────────┬───────────────────────────────┘
                       ▼
┌──────────────────────────────────────────────────────┐
│ 3️⃣ Core Logic (core/)                               │
├──────────────────────────────────────────────────────┤
│ - project.py: 언어 감지, Git 정보, SPEC 진행률      │
│ - context.py: JIT 문서 로드 (Just-In-Time)           │
│ - checkpoint.py: 이벤트 기반 체크포인트              │
│ - tags.py: TAG 검색/검증, 라이브러리 버전 캐시      │
└──────────────────────────────────────────────────────┘
```

---

## 8가지 이벤트 타입

### 1️⃣ SessionStart

**발생**: Claude Code 세션 시작 시
**목적**: 프로젝트 상태 요약 표시
**출력**: 시스템 메시지 (프로젝트 정보 요약)

**표시되는 정보**:
```
🚀 MoAI-ADK Session Started
   Language: python
   Branch: feature/SPEC-AUTH-001 (a1b2c3d)
   Changes: 3 files modified
   SPEC Progress: 2/5 (40%)
   Checkpoints: 5 available
```

**내부 로직**:
```python
# 중요도별 처리
1. CRITICAL: detect_language(cwd) - 반드시 성공해야 함
2. OPTIONAL: get_git_info(cwd) - 실패 시 스킵
3. OPTIONAL: count_specs(cwd) - 실패 시 스킵
4. OPTIONAL: list_checkpoints(cwd) - 실패 시 스킵

# 우아한 성능 저하 (Graceful Degradation)
- 모든 OPTIONAL 작업은 try-except로 감싸짐
- 일부 실패해도 CRITICAL 정보는 반드시 표시
- 최소 1개 이상의 정보는 항상 표시
```

**활용 예시**: 새 세션을 시작할 때 현재 프로젝트 상태를 한눈에 파악

---

### 2️⃣ UserPromptSubmit

**발생**: 사용자가 프롬프트를 입력했을 때
**목적**: 사용자 입력 분석 → 필요한 문서 자동 로드
**출력**: 컨텍스트 파일 목록 + 로드 메시지

**예시 워크플로우**:
```python
사용자 입력: "tag 검증하고 싶어"
             ▼
Hook 분석 (get_jit_context):
  - "tag" 키워드 감지
  - "검증" 관련 문서 검색
             ▼
자동 로드:
  - .moai/specs/SPEC-*/spec.md
  - .moai/docs/tag-system-guide.md
  - .claude/skills/moai-foundation-tags/SKILL.md
             ▼
사용자: "📎 Loaded 3 context file(s)"
```

**JIT Retrieval 알고리즘**:
```
1. 사용자 프롬프트 분석 (키워드 추출)
2. 키워드별 관련 문서 검색
3. 중복 제거 (같은 파일 중복 로드 방지)
4. 우선순위 정렬 (가장 관련 높은 문서부터)
5. 파일 목록 반환

지원하는 키워드:
- "spec" → .moai/specs/ 문서
- "test" / "test" → tests/ 디렉토리
- "tag" / "추적" → TAG 검증 문서
- "hook" → Hooks 설정 문서
- "config" / "설정" → .moai/config.json 문서
```

**부가 기능: 명령어 로깅**:
```python
# Alfred 명령어 실행 기록 자동 저장
사용자: "/alfred:2-run SPEC-AUTH-001"
        ▼
Hook: .moai/logs/command-invocations.log에 기록
        2024-03-15T10:23:45.123456 | /alfred:2-run SPEC-AUTH-001
```

---

### 3️⃣ SessionEnd

**발생**: Claude Code 세션 종료 시
**목적**: 세션 정리 및 최종 상태 저장
**출력**: 세션 종료 메시지 (향후 확장 가능)

**현재 기능**: 스텁 (향후 구현 예정)
**미래 기능**:
- 세션 통계 저장 (실행 시간, 명령어 수, 생성된 파일 수)
- 미완료 체크포인트 정리
- 브랜치 정보 최종 저장

---

### 4️⃣ PreToolUse

**발생**: 도구(Tool) 사용 직전
**목적**: 위험 작업 감지 → 자동 체크포인트 생성
**출력**: 체크포인트 생성 메시지 또는 작업 차단

**위험 작업 감지**:
```python
위험한 작업 (자동 체크포인트):
  1. git push / git force-push
  2. 데이터베이스 마이그레이션
  3. 파일 대량 삭제 (rm -rf 등)
  4. 프로덕션 환경 배포
  5. 보안 민감 파일 수정 (.env, credentials.json)

자동 체크포인트:
  .moai/checkpoints/checkpoint-20240315-102345.json
  {
    "timestamp": "2024-03-15T10:23:45.123456",
    "tool": "Bash",
    "command": "git push origin main",
    "risk_level": "HIGH",
    "files_involved": ["README.md", "src/auth.py"]
  }
```

**체크포인트 활용**:
```bash
# 나중에 실수로 되돌려야 할 경우
$ moai restore checkpoint-20240315-102345

# 체크포인트 목록 확인
$ moai list checkpoints
```

---

### 5️⃣ PostToolUse

**발생**: 도구 사용 완료 후
**목적**: 실행 결과 검증 및 기록
**출력**: 검증 결과 메시지

**예시**:
```
사용자: pytest tests/ 실행
        ▼
PostToolUse:
  - 테스트 결과 파싱 (성공/실패)
  - 커버리지 메트릭 추출
  - 결과 기록 (.moai/logs/test-runs.log)
  - 85% 미만 커버리지 경고
```

---

### 6️⃣ Notification

**발생**: Claude Code가 사용자에게 알림을 전송할 때
**목적**: 알림 처리 및 필요 시 추가 작업 실행
**출력**: 알림 처리 결과

**예시 알림**:
```
Claude Code: "Do you want to approve this operation?"
             ▼
Hook: 위험도 평가
      - 낮음: 자동 승인
      - 높음: 사용자에게 물어보기
      - 매우 높음: 자동 거부
```

---

### 7️⃣ Stop

**발생**: 사용자가 실행을 중단했을 때 (Ctrl+C, 중지 버튼)
**목적**: 우아한 종료 및 복구 정보 저장
**출력**: 종료 메시지

**현재 기능**: 스텁 (향후 확장)
**미래 기능**:
- 부분 작업 자동 저장
- 복구 체크포인트 생성
- 중단 사유 기록
- 외부 시스템에 중단 알림

---

### 8️⃣ SubagentStop

**발생**: Sub-agent 실행 종료 시
**목적**: Sub-agent 결과 수집 및 검증
**출력**: Sub-agent 실행 결과 요약

**예시**:
```
Sub-agent: tdd-implementer 실행 중...
           ▼
작업 완료:
  - RED 단계: 3개 테스트 작성
  - GREEN 단계: 구현 완료 (모든 테스트 통과)
  - REFACTOR 단계: 코드 정리 (커버리지 85%)
           ▼
SubagentStop Hook:
  - 결과 검증 (모든 테스트 통과?)
  - 품질 메트릭 추출
  - 다음 단계 제안
```

---

## Hook 실행 모델

### JSON I/O 통신

```bash
# Hook 호출 (Claude Code 자동)
$ echo '{"cwd": "/path/to/project", "userPrompt": "..."}' \
  | python alfred_hooks.py UserPromptSubmit

# 출력 (Hook 반환)
{
  "continue": true,
  "systemMessage": "📎 Loaded 3 context file(s)",
  "hookSpecificOutput": {
    "hookEventName": "UserPromptSubmit",
    "additionalContext": "📎 Context: .moai/specs/SPEC-AUTH-001/spec.md\n..."
  }
}
```

### 응답 스키마 (HookResult)

```python
@dataclass
class HookResult:
    # Claude Code 표준 필드
    continue_execution: bool = True  # 실행 계속 여부
    suppress_output: bool = False    # 출력 숨김 여부
    decision: str | None = None      # "approve" 또는 "block"
    reason: str | None = None        # 결정 사유
    permission_decision: str | None = None  # "allow", "deny", "ask"

    # MoAI-ADK 커스텀 필드
    system_message: str | None = None       # 사용자 메시지
    context_files: list[str] = []          # 로드할 파일 목록
    suggestions: list[str] = []            # 제안사항
    exit_code: int = 0                     # 종료 코드
```

### 종료 코드

```python
0: 성공 (Hook 정상 실행)
1: 오류 (타임아웃, JSON 파싱 오류, 핸들러 예외)
```

---

## 우아한 성능 저하 (Graceful Degradation)

Hook은 실패에 견딜 수 있도록 설계되었습니다. 일부 작업이 실패해도 전체 시스템이 중단되지 않습니다.

### SessionStart의 우아한 성능 저하

```python
def handle_session_start(payload):
    # ✅ CRITICAL: 반드시 성공해야 함
    language = detect_language(cwd)  # 예외 처리 없음

    # ⚠️ OPTIONAL: 실패해도 계속 진행
    git_info = {}
    try:
        git_info = get_git_info(cwd)
    except Exception:
        pass  # 무시하고 계속

    # ⚠️ OPTIONAL: 실패해도 계속 진행
    specs = {"completed": 0, "total": 0}
    try:
        specs = count_specs(cwd)
    except Exception:
        pass  # 무시하고 계속

    # 결과: 최소한 언어 정보는 반드시 표시
    # 추가 정보는 성공한 것만 표시
```

### 타임아웃 보호

```python
# 5초 글로벌 타임아웃
signal.signal(signal.SIGALRM, timeout_handler)
signal.alarm(5)

try:
    # Hook 실행 (최대 5초)
    result = handler(data)
except HookTimeoutError:
    # 타임아웃 발생 → 최소한의 유효한 응답 반환
    return {"continue": True, "systemMessage": "⚠️ Hook timeout"}
```

---

## JIT Context Retrieval (진시 컨텍스트 로드)

사용자가 특정 작업을 언급할 때 관련 문서를 자동으로 로드합니다.

### 지원하는 키워드 및 로드 대상

| 키워드 | 로드 파일 | 설명 |
|--------|---------|------|
| "spec" | `.moai/specs/SPEC-*/spec.md` | 모든 SPEC 문서 |
| "tag" / "추적" | `.moai/docs/tag-system.md` | TAG 시스템 가이드 |
| "hook" | `.claude/hooks/` | Hook 설정 파일 |
| "config" | `.moai/config.json` | 프로젝트 설정 |
| "test" | `tests/` | 테스트 파일 |
| "auth" | `src/auth.py`, `tests/test_auth.py` | 인증 관련 파일 |

### JIT 알고리즘

```python
def get_jit_context(user_prompt, cwd):
    """사용자 입력에서 필요한 문서 추천"""

    # 1단계: 키워드 추출
    keywords = extract_keywords(user_prompt)
    # 예: "spec 작성" → ["spec", "작성"]

    # 2단계: 키워드별 파일 검색
    matching_files = []
    for keyword in keywords:
        matching_files.extend(search_files_by_keyword(keyword))

    # 3단계: 중복 제거
    unique_files = remove_duplicates(matching_files)

    # 4단계: 우선순위 정렬
    sorted_files = prioritize_files(unique_files)

    # 5단계: 상위 10개 반환
    return sorted_files[:10]
```

---

## Checkpoint 시스템

위험한 작업 직전에 자동으로 체크포인트를 생성하여 복구 가능하게 만듭니다.

### 위험도 레벨

```python
RISK_LEVEL_HIGH = [
    "git push",
    "git force-push",
    "git reset --hard",
    "rm -rf",  # 파일 대량 삭제
    "DROP TABLE",  # 데이터베이스 삭제
]

RISK_LEVEL_MEDIUM = [
    "git commit",  # 커밋은 되돌릴 수 있지만 주의 필요
    "npm publish",  # 패키지 배포
]

RISK_LEVEL_LOW = [
    "pytest",
    "ruff check",
    "mypy",  # 안전한 도구들
]
```

### 체크포인트 생성 예시

```python
# PreToolUse Hook에서 자동 생성
{
    "id": "cp-20240315-102345",
    "timestamp": "2024-03-15T10:23:45.123456",
    "event": "PreToolUse",
    "tool": "Bash",
    "command": "git push origin main",
    "risk_level": "HIGH",
    "files_involved": ["README.md", "src/auth.py", "tests/test_auth.py"],
    "git_status": {
        "branch": "feature/SPEC-AUTH-001",
        "commit_hash": "a1b2c3d",
        "changed_files": 3
    }
}
```

---

## 최적 사례 (Best Practices)

### ✅ Hook 개발할 때

```python
# 좋은 예: 타임아웃 설정 + 우아한 성능 저하
def my_hook(payload):
    cwd = payload.get("cwd", ".")

    # CRITICAL 작업 (try-except 없음)
    language = detect_language(cwd)

    # OPTIONAL 작업 (try-except 포함)
    try:
        git_info = get_git_info(cwd)
    except Exception:
        git_info = {}  # 기본값으로 계속

    return HookResult(system_message="✅ Ready")

# 나쁜 예: 타임아웃 없이 무한 대기 가능
def bad_hook(payload):
    while True:
        result = expensive_operation()  # 5초 초과 가능
    # ❌ Claude Code가 응답 불가능해짐
```

### ✅ Hook 호출 성능

```python
# 좋은 예: 빠른 응답 (< 1초)
def fast_hook(payload):
    return HookResult(system_message="Quick response")

# 나쁜 예: 느린 응답 (> 5초)
def slow_hook(payload):
    for i in range(100):
        expensive_computation()  # 5초 초과
    # ❌ 타임아웃으로 실패
```

---

## 문제 해결 (Troubleshooting)

### ❓ Hook이 실행되지 않음

**확인할 사항**:
1. Hook 파일이 `.claude/hooks/alfred/`에 있는가?
2. Hook 파일에 실행 권한이 있는가? (`chmod +x`)
3. 파이썬 경로가 올바른가? (`#!/usr/bin/env python3`)

```bash
# 확인
ls -la .claude/hooks/alfred/session_start__show_project_info.py
# 실행 권한 추가
chmod +x .claude/hooks/alfred/session_start__show_project_info.py
```

---

### ❓ "Hook timeout after 5 seconds" 오류

**원인**: Hook이 5초 이상 실행됨

**해결**:
```python
# ❌ 느린 작업 (Git 명령어 대량 실행, 파일 I/O 대량 작업)
def slow_handler(payload):
    for i in range(1000):
        subprocess.run(["git", "log"])  # 너무 많음

# ✅ 개선: 필요한 것만 실행 + 캐싱
cache = {}
def fast_handler(payload):
    if "git_info" in cache:
        return cache["git_info"]
    result = subprocess.run(["git", "log", "-1"], timeout=2)
    cache["git_info"] = result
    return result
```

---

### ❓ JIT Context가 로드되지 않음

**원인**: 키워드가 매칭되지 않음

**확인**:
```python
# 사용자 입력에서 인식되는 키워드 확인
supported_keywords = [
    "spec", "test", "tag", "hook", "config",
    "auth", "추적", "검증", "테스트", "명세"
]

# 사용자 입력 예시
user_input = "tag 검증해줄래?"
# 인식되는 키워드: ["tag", "검증"]
# 로드되는 파일: .moai/docs/tag-system.md, TAG 검증 가이드
```

---

### ❓ 체크포인트 기능이 작동하지 않음

**확인**:
```bash
# 체크포인트 디렉토리 확인
ls -la .moai/checkpoints/

# 최근 체크포인트 확인
cat .moai/checkpoints/checkpoint-*.json | jq . | head -20
```

---

## Hook 설정 (Configuration)

### `.claude/hooks.json` 설정 파일

```json
{
  "hooks": {
    "enabled": true,
    "timeout": 5,
    "events": {
      "SessionStart": {
        "enabled": true,
        "critical_only": false
      },
      "UserPromptSubmit": {
        "enabled": true,
        "max_files": 10,
        "timeout": 3
      },
      "PreToolUse": {
        "enabled": true,
        "checkpoint_on_risk": true,
        "risk_level_threshold": "MEDIUM"
      }
    }
  }
}
```

---

## 다음 단계

Hook 시스템을 이해했다면:

1. **Hook 커스터마이징**: 프로젝트에 맞게 Hook 수정
2. **JIT Context 확장**: 프로젝트 특화 키워드 추가
3. **Checkpoint 활용**: 위험한 작업 자동 보호
4. **모니터링**: `.moai/logs/` 확인으로 Hook 실행 기록 추적

---

## 참고 자료

- [TRUST 5 원칙](/ko/introduction/overview) - Hook으로 검증하는 품질 기준
- [TAG 시스템](/ko/concepts/tag-system) - Hook과 TAG의 통합
- [/alfred:0-project](/ko/cli/alfred-0-project) - Hook 설정이 자동으로 생성되는 방법
- [Claude Code Hooks 공식 문서](https://docs.claude.com/en/docs/claude-code/hooks) - Hook 표준 스키마
