# Final test Dockerfile for Issue #231 reproduction
FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Install Python and basic tools
RUN apt-get update && apt-get install -y \
    python3 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create test directory
WORKDIR /test

# Create Python test script
RUN cat > /test/issue_231_test.py << 'PYTHONEOF'
#!/usr/bin/env python3
"""
Final test script for GitHub Issue #231
Docker Environment stdin blocking verification
"""
import sys
import json
import time
import subprocess

def main():
    print("=" * 60)
    print("ğŸ³ Issue #231 Docker Environment Test")
    print("=" * 60)
    print(f"Python: {sys.version}")
    print()

    # Test 1: TTY Detection
    print("\nğŸ” Test 1: TTY Detection")
    tty_detected = sys.stdin.isatty()
    print(f"   TTY Detected: {tty_detected}")

    # Test 2: OLD Pattern (should be blocked in Docker)
    print("\nâŒ Test 2: OLD Pattern (Issue #231)")
    start_time = time.time()
    old_blocked = False

    try:
        # This is the problematic pattern that causes issues in Docker
        input_data = sys.stdin.read()  # This should block
        data = json.loads(input_data) if input_data.strip() else {}
        old_time = time.time() - start_time
        print(f"âŒ OLD pattern unexpectedly completed in {old_time:.2f}s")
    except KeyboardInterrupt:
        old_blocked = True
        print("âŒ OLD pattern confirmed blocked")
    except Exception as e:
        print(f"âŒ OLD pattern error: {e}")

    # Test 3: NEW Fixed Pattern (should work)
    print("\nâœ… Test 3: NEW Fixed Pattern")
    start_time = time.time()
    try:
        # This is the fixed pattern
        input_data = sys.stdin.read() if not sys.stdin.isatty() else "{}"
        data = json.loads(input_data) if input_data.strip() else {}
        new_time = time.time() - start_time
        print(f"âœ… NEW pattern: {data} (completed in {new_time:.3f}s)")
        new_works = True
    except Exception as e:
        print(f"âŒ NEW pattern error: {e}")
        new_works = False

    # Test 4: procps dependency
    print("\nğŸ³ Test 4: procps dependency")
    try:
        result = subprocess.run(['ps', '--version'],
                              capture_output=True,
                              text=True,
                              timeout=3)
        procps_available = True
        print(f"   ps command available: {result.stdout.strip()}")
    except (subprocess.CalledProcessError, FileNotFoundError, subprocess.TimeoutExpired):
        procps_available = False
        print("   âŒ ps command not available (procps dependency missing)")

    # Test 5: Complete compatibility
    print("\nğŸ“‹ Test Summary:")
    print(f"   TTY Detection: {'âœ…' if tty_detected else 'âŒ'}")
    print(f"   OLD Pattern Blocked: {'âœ…' if old_blocked else 'âŒ'}")
    print(f"   NEW Pattern Works: {'âœ…' if new_works else 'âŒ'}")
    print(f"   procps Available: {'âœ…' if procps_available else 'âŒ'}")

    # Overall Result
    all_good = not old_blocked and new_works
    issue_231_fixed = all_good and not procps_available  # procps issue remains

    print(f"\nğŸ¯ Issue #231 Status:")
    if issue_231_fixed:
        print("   âœ… ISSUE #231 RESOLVED!")
        print("   - stdin blocking completely fixed")
        print("   - Docker compatibility verified")
    else:
        print("   âŒ Issue #231 STILL PRESENT")
        if old_blocked:
            print("   - stdin blocking still occurs")
        if not new_works:
            print("   - new pattern failed")
        if not procps_available:
            print("   - procps dependency missing")

    return 0 if issue_231_fixed else 1

if __name__ == "__main__":
    sys.exit(main())
PYTHONEOF

# Make test executable
RUN chmod +x /test/issue_231_test.py

# Run the test
CMD ["/test/issue_231_test.py"]