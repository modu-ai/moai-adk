# SPEC例: 実世界のシナリオ

さまざまなドメインと複雑さレベルにわたるSPEC文書の包括的な例を探ります。
これらの例は、明確で、テスト可能で、完全な仕様を書くためのベストプラクティスを示しています。

## 例のカテゴリ

1. **認証とセキュリティ** - ユーザー認証、認可、セキュリティ機能
2. **API開発** - REST APIエンドポイント、データモデル、統合パターン
3. **ユーザー管理** - ユーザープロフィール、設定、アカウント管理
4. **データ処理** - バックグラウンドジョブ、データパイプライン、分析
5. **Eコマース** - ショッピングカート、決済、注文管理
6. **コミュニケーション** - 通知、メッセージング、メールシステム
7. **ファイル管理** - アップロード、ストレージ、ファイル処理
8. **レポートと分析** - ダッシュボード、レポート、データ可視化

---

## 例1: 認証システム (中程度の複雑さ)

**ドメイン**: AUTH-001  
**推定時間**: 12時間  
**優先度**: 高

```yaml
---
id: AUTH-001
version: 0.2.0
status: in_review
priority: high
created: 2025-01-15
updated: 2025-01-16
author: @security-team
domain: authentication
complexity: medium
estimated_hours: 12
dependencies: [USER-001, EMAIL-001, RATE-001]
tags: [security, jwt, oauth, mfa]
reviewers: [@tech-lead, @security-expert]
milestone: "Sprint 23 - Q1 2025"
---

# @SPEC:EX-AUTH-001: 包括的認証システム

## 概要
複数の認証方法、セッション管理、多要素認証やソーシャルログイン統合を含むセキュリティ機能を備えた、安全でスケーラブルなユーザー認証を提供します。

## EARS要件

### 遍在的要件
- システムはメールとパスワードによるユーザー認証を提供すること
- システムはJWTトークンベースのセッション管理をサポートすること
- システムは安全なユーザーセッション状態を維持すること
- システムはすべての認証試行をタイムスタンプ付きでログに記録すること
- システムは安全なパスワードポリシーを強制すること
- システムは一般的な認証攻撃から保護すること

### イベント駆動要件
- 有効な資格情報が提供された場合、システムはJWTアクセストークンとリフレッシュトークンを発行すること
- 無効な資格情報が提供された場合、システムは汎用メッセージとともに401エラーを返すこと
- 複数回のログイン失敗(15分以内に5回以上)が発生した場合、システムはレート制限を実装すること
- パスワードリセットがリクエストされた場合、システムは安全なリセットリンクをメールで送信すること
- 多要素認証が有効な場合、システムは追加検証を要求すること
- ソーシャルログインコールバックが受信された場合、システムはユーザーアカウントを作成またはリンクすること
- セッションが期限切れになった場合、システムは再認証を要求すること
- 疑わしいアクティビティが検出された場合、システムはセキュリティアラートをトリガーすること

### 状態駆動要件
- ユーザーが認証されている間、システムは保護されたリソースへのアクセスを許可すること
- ユーザーセッションがアクティブな間、システムは有効期限前にトークンを自動的に更新すること
- 多要素認証セットアップが保留中の間、システムは機密操作を制限すること
- セキュリティ上の懸念によりアカウントがロックされている間、システムはすべての認証試行を拒否すること
- レート制限がアクティブな間、システムは過剰な認証リクエストを拒否すること

### オプション要件
- ソーシャルログインプロバイダーが構成されている場合、システムはOAuth 2.0認証をサポートすること
- 生体認証が利用可能な場合、システムは指紋認証と顔認識をサポートすること
- ハードウェアセキュリティキーがサポートされている場合、システムはWebAuthnプロトコルを実装すること
- リスクベース認証が有効な場合、システムはコンテキストに基づいてセキュリティ要件を調整すること
- シングルサインオン(SSO)が構成されている場合、システムはIDプロバイダーと統合すること

### 望ましくない動作
- システムは平文またはreversible暗号化でパスワードを保存してはならない
- システムはロックアウトシナリオでメールアドレスが登録されているかどうかを明らかにしてはならない
- パスワードは8文字未満または一般的な辞書の単語を含んではならない
- システムは同じ資格情報での同時セッションを許可してはならない(設定可能)
- JWTトークンはペイロードに機密ユーザー情報を含んではならない
- システムは暗号化されていない接続で認証リクエストを受け入れてはならない
- ログイン試行はIPアドレスごとに1分間に10回を超えてはならない
- システムは過去5つのパスワード内でのパスワードの再利用を許可してはならない

## 技術要件

### セキュリティ要件
- パスワードは最低12ラウンドのbcryptを使用してハッシュ化すること
- JWTトークンは2048ビットキーでRS256署名アルゴリズムを使用すること
- すべての認証エンドポイントはHTTPSを排他的に使用すること
- 入力検証はSQLインジェクション、XSS、CSRF攻撃を防ぐこと
- セッショントークンは設定可能な有効期限(デフォルト: アクセス15分、リフレッシュ7日)を持つこと
- 失敗した認証試行はIP、ユーザーエージェント、タイムスタンプとともにログに記録すること
- アカウントロックアウトは10回の失敗試行後、30分間のロックアウト期間で発生すること

### パフォーマンス要件
- 認証応答時間は500ms未満であること(95パーセンタイル)
- トークン検証は100ms未満であること
- システムは10,000の同時認証リクエストをサポートすること
- データベースクエリは認証ルックアップ用に最適化されていること
- パスワード検証は定数時間比較を使用すること

### 統合要件
- パスワードリセットと検証用のメールサービス統合
- ブルートフォース保護用のレート制限サービス統合
- コンプライアンス要件用の監査ログ統合
- ソーシャルログインプロバイダー統合(Google、GitHub、Microsoft)
- 多要素認証サービス統合(SMS、認証アプリ)

### データ要件
- ユーザーは一意のメールアドレスを持つこと
- パスワードは複雑性要件(8文字以上、大文字小文字混在、数字、記号)を満たすこと
- ユーザーセッションはデバイスフィンガープリントで追跡されること
- 認証イベントは監査目的で90日間保持されること
- PIIは保存時および転送時に暗号化されること

## 受入基準

### 機能要件
- [ ] ユーザーはメールとパスワードで登録できる
- [ ] ユーザーは有効な資格情報で認証できる
- [ ] システムは適切な有効期限でJWTトークンを発行する
- [ ] ユーザーは有効期限前にトークンを更新できる
- [ ] パスワードリセット機能はエンドツーエンドで動作する
- [ ] 多要素認証を有効にして使用できる
- [ ] ソーシャルログイン統合は構成されたプロバイダーで動作する
- [ ] レート制限はブルートフォース攻撃を防ぐ
- [ ] アカウントロックアウトは繰り返しの失敗から保護する
- [ ] セッション管理は複数のデバイスで動作する

### セキュリティ要件
- [ ] パスワードは適切にハッシュ化およびソルト化されている
- [ ] JWTトークンは安全な署名アルゴリズムを使用する
- [ ] すべてのエンドポイントはHTTPSで保護されている
- [ ] 入力検証はインジェクション攻撃を防ぐ
- [ ] 機密データは保存時に暗号化されている
- [ ] 監査ログはすべての認証イベントをキャプチャする
- [ ] エラーメッセージは機密情報を明らかにしない
- [ ] レート制限は効果的かつ設定可能である
- [ ] セッションハイジャック保護が実装されている
- [ ] Webフォーム用のCSRF保護が有効である

### パフォーマンス要件
- [ ] 負荷時の認証応答時間 < 500ms
- [ ] システムは10,000の同時リクエストを処理する
- [ ] データベースクエリは最適化およびインデックス化されている
- [ ] トークン検証はキャッシュされ高速である
- [ ] メモリ使用量は負荷時に安定している

### 統合要件
- [ ] メールサービス統合は信頼性が高く動作する
- [ ] ソーシャルログインプロバイダーは正しく認証する
- [ ] MFAサービスはコードを生成および検証する
- [ ] 監査ログはすべての必要なイベントをキャプチャする
- [ ] レート制限サービスが適切に統合されている

## 依存関係

### 内部依存関係
- **USER-001**: ユーザー管理システム(認証に必要)
- **EMAIL-001**: メール通知サービス(パスワードリセットに必要)
- **RATE-001**: レート制限サービス(セキュリティに必要)
- **AUDIT-001**: 監査ログシステム(コンプライアンスに必要)

### 外部依存関係
- **OAuthプロバイダー**: Google、GitHub、Microsoft(オプションのソーシャルログイン)
- **MFAサービス**: Twilio(SMS)、認証アプリ(TOTP)
- **メールサービス**: SendGrid、AWS SES(トランザクションメール)
- **モニタリング**: Datadog、New Relic(パフォーマンス監視)

## リスク評価

### 高リスク
| リスク | 影響 | 確率 | 緩和策 |
|------|--------|-------------|------------|
| トークンセキュリティ侵害 | クリティカル | 中 | RS256使用、キーローテーション、トークンブラックリスト実装 |
| パスワードデータベース侵害 | クリティカル | 低 | 強力なハッシュ化、保存時暗号化、アクセス制限 |
| ソーシャルログインプロバイダー障害 | 高 | 中 | メール認証へのフォールバック、プロバイダー監視 |

### 中リスク
| リスク | 影響 | 確率 | 緩和策 |
|------|--------|-------------|------------|
| 高負荷下のパフォーマンス | 中 | 中 | 負荷テスト、キャッシング、水平スケーリング |
| MFA配信失敗 | 中 | 低 | 複数のMFAオプション、フォールバック方法 |
| ユーザー列挙攻撃 | 中 | 高 | 汎用エラーメッセージ、レート制限 |

### 低リスク
| リスク | 影響 | 確率 | 緩和策 |
|------|--------|-------------|------------|
| セッション管理のエッジケース | 低 | 中 | 包括的テスト、明確なセッションポリシー |
| パスワードポリシーによるユーザー摩擦 | 低 | 高 | ユーザーフレンドリーなパスワード要件、強度メーター |

## 実装ノート

### アーキテクチャ推奨事項
@EXPERT:BACKEND - 別の認証サービスを持つマイクロサービスアーキテクチャを使用  
@EXPERT:SECURITY - 最小権限の原則でゼロトラストアーキテクチャを実装  
@EXPERT:PERF - セッションストレージとキャッシング用にRedisを使用  
@EXPERT:DEVOPS - ゼロダウンタイムのためにブルーグリーンデプロイメントで展開

### セキュリティ考慮事項
- アカウント乗っ取り検出を実装
- 異常検出のためにデバイスフィンガープリントを使用
- リスクに基づいてプログレッシブ認証を実装
- 定期的なセキュリティ監査とペネトレーションテスト
- GDPR、CCPA、その他の規制へのコンプライアンス

### テスト戦略
- すべての認証ロジックの単体テスト(90%以上のカバレッジ)
- 外部サービス依存関係の統合テスト
- 一般的な攻撃ベクトルのセキュリティテスト
- さまざまな負荷条件下でのパフォーマンステスト
- 失敗シナリオのカオスエンジニアリング

### モニタリングとアラート
- 認証成功/失敗率
- 応答時間パーセンタイル(p50、p95、p99)
- セキュリティイベントアラートとダッシュボード
- エラー率とパターン
- リソース使用率(CPU、メモリ、データベース)

## 成功指標

### 技術指標
- 認証成功率 > 99.5%
- 平均応答時間 < 500ms
- システム可用性 > 99.9%
- セキュリティ侵害ゼロ
- テストカバレッジ > 90%

### ビジネス指標
- ユーザー登録完了率 > 80%
- ログイン成功率 > 95%
- 認証関連のサポートチケット < 5%
- ユーザー満足度スコア > 4.5/5
- MFA採用率 > 60%

## 履歴

### バージョン 0.2.0 (2025-01-16)
- ソーシャルログイン統合要件を追加
- ハードウェアセキュリティキーでMFAサポートを強化
- パフォーマンス要件を改善
- リスクベース認証オプションを追加

### バージョン 0.1.0 (2025-01-15)
- 初期仕様作成
- コア認証要件
- セキュリティとパフォーマンスのベースライン
```

---

## SPEC品質チェックリスト

各SPECについて、これらの品質基準を満たすことを確認してください:

### コンテンツ品質

- [ ] 要件は明確で曖昧でない
- [ ] すべてのユースケースがカバーされている
- [ ] エラー条件が指定されている
- [ ] 受入基準がテスト可能である
- [ ] 依存関係が特定されている

### フォーマット準拠

- [ ] YAMLフロントマターが完全で有効である
- [ ] EARSパターンが正しく使用されている
- [ ] 言語が全体を通して一貫している
- [ ] 構造が標準テンプレートに従っている
- [ ] TAG参照が正しい

### 技術的実現可能性

- [ ] 要件が技術的に達成可能である
- [ ] セキュリティ考慮事項が対処されている
- [ ] パフォーマンス要件が現実的である
- [ ] 統合ポイントが定義されている
- [ ] リスク評価が包括的である

### レビュープロセス

- [ ] 技術レビューが完了している
- [ ] ドメインエキスパート検証
- [ ] セキュリティレビュー(該当する場合)
- [ ] ステークホルダー承認取得
- [ ] バージョン管理が適切に管理されている

## 独自のSPECを作成する

独自のSPECを作成する際は、このプロセスに従ってください:

### 1. 要件収集

- ステークホルダーと話す
- すべてのユースケースを文書化
- 制約と依存関係を特定
- エッジケースとエラー条件を考慮

### 2. SPECをドラフト

- YAMLフロントマターから始める
- EARS要件を体系的に記述
- 技術要件を含める
- 受入基準を定義

### 3. レビューと改良

- 技術チームからフィードバックを得る
- ドメインエキスパートで検証
- 完全性と明確性をチェック
- すべての要件のテスト可能性を確保

### 4. 最終化と承認

- レビューフィードバックを組み込む
- ステークホルダーの承認を取得
- SPECをバージョン管理
- 実装チームと共有

良いSPECはプロジェクト成功への投資です。時間をかけて正しく行えば、実装フェーズがはるかにスムーズになります! 🎯
