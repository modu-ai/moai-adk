# EARS 構文: 高度なガイド

明確でテスト可能、曖昧さのない仕様を書くためのEARS (Easy Approach to Requirements Syntax) をマスターしましょう。この包括的なガイドでは、高度なパターン、ベストプラクティス、実世界の例を網羅します。

## EARS とは?

EARS (Easy Approach to Requirements Syntax) は、曖昧さを排除しテスト可能性を確保する構造化された要求記述手法です。要求工学の広範な研究を通じて開発されたEARSは、あらゆる種類のシステム動作をカバーする5つの明確なパターンを提供します。

### EARS が重要な理由

従来の要求記述はしばしば以下の問題に悩まされます:

- **曖昧さ**: 「システムは高速であるべき」→ どれくらい高速? どの条件下で?
- **不正確さ**: 「ユーザーはログインできるべき」→ どの方法で? エラー処理は?
- **不完全さ**: エッジケースやエラー条件の欠落
- **テスト不可能性**: 客観的に検証できない要求

EARSはこれらの問題を以下によって解決します:

- **構造化された言語**: すべての要求タイプに一貫したパターン
- **明確なトリガー**: 明示的な条件とイベント
- **完全なカバレッジ**: すべてのシステム動作を表現する方法
- **テスト可能性**: すべての要求がテストケースに変換可能

## 5つのEARSパターン

### パターン1: 常時要件 (Ubiquitous Requirements)

**目的**: 常に利用可能なシステム機能やコア機能を定義します。

**構文**: `システムは <機能> を提供しなければならない`

**使用するタイミング**:

- コアシステム機能
- 常時利用可能な機能
- 基本的な能力
- システム全体の動作

**構造**:

```
システムは [動詞] [対象] [条件/コンテキスト] しなければならない
```

#### 例

**基本機能**:

```markdown
- システムはメールアドレスとパスワードによるユーザー認証を提供しなければならない
- システムはユーザーセッション状態を安全に維持しなければならない
- システムは処理前にすべてのユーザー入力を検証しなければならない
- システムはタイムスタンプ付きですべてのシステムイベントをログに記録しなければならない
- システムは同時ユーザーセッションをサポートしなければならない
```

**データ管理**:

```markdown
- システムはユーザーデータを暗号化形式で保存しなければならない
- システムはデータ整合性制約を維持しなければならない
- システムはデータバックアップ機能を提供しなければならない
- システムはデータロールバック操作をサポートしなければならない
- システムは参照整合性を強制しなければならない
```

**セキュリティ**:

```markdown
- システムは安全なパスワードハッシュを実装しなければならない
- システムはすべての通信にHTTPSを使用しなければならない
- システムはSQLインジェクション攻撃から保護しなければならない
- システムはAPIエンドポイントのレート制限を実装しなければならない
- システムはセキュリティイベントの監査ログを提供しなければならない
```

**パフォーマンス**:

```markdown
- システムはユーザーリクエストに2秒以内に応答しなければならない
- システムは1000人の同時ユーザーをサポートしなければならない
- システムは99.9%の稼働率を維持しなければならない
- システムは頻繁にアクセスされるデータをキャッシュしなければならない
- システムはデータベースクエリを自動的に最適化しなければならない
```

#### 高度な常時要件パターン

**条件付き常時要件**:

```markdown
- システムは認証されたユーザーにAPIアクセスを提供しなければならない
- システムはユーザーティアに基づいてレート制限を強制しなければならない
- システムは負荷に基づいて水平スケールしなければならない
```

**限定常時要件**:

```markdown
- システムはPCI準拠の方法を使用して支払いを処理しなければならない
- システムはAES-256暗号化を使用して機密データを保存しなければならない
- システムはOWASPセキュリティガイドラインを使用して入力を検証しなければならない
```

### パターン2: イベント駆動要件 (Event-driven Requirements)

**目的**: 特定のイベント、トリガー、条件に対するシステムの応答を定義します。

**構文**: `<トリガー> が発生した場合、システムは <応答> しなければならない`

**使用するタイミング**:

- ユーザーアクションと相互作用
- システムイベントと通知
- 外部トリガー
- 時間ベースのイベント
- 状態変化

**構造**:

```
[トリガー条件] が発生した場合、システムは [応答/アクション] [追加詳細] しなければならない
```

#### 例

**ユーザーアクション**:

```markdown
- ユーザーがログイン認証情報を送信した場合、システムは検証と認証を行わなければならない
- ユーザーがプロフィールを更新した場合、システムは変更を保存し成功を確認しなければならない
- ユーザーがパスワードリセットを要求した場合、システムはリセットメールを送信しなければならない
- ユーザーがファイルをアップロードした場合、システムはファイルタイプとサイズを検証しなければならない
- ユーザーがログアウトした場合、システムはすべてのアクティブなセッションを無効化しなければならない
```

**システムイベント**:

```markdown
- システムメモリが80%使用を超えた場合、システムはクリーンアップ手順をトリガーしなければならない
- データベース接続が失敗した場合、システムは指数バックオフで再接続を試みなければならない
- 定期メンテナンスが開始された場合、システムはメンテナンスモードに入らなければならない
- セキュリティ侵害が検出された場合、システムは影響を受けたアカウントをロックしなければならない
- バックアッププロセスが完了した場合、システムはバックアップの整合性を検証しなければならない
```

**外部トリガー**:

```markdown
- 支払いプロバイダーからWebhookを受信した場合、システムはサブスクリプションステータスを更新しなければならない
- メールバウンスが発生した場合、システムはユーザーのメールステータスを更新しなければならない
- APIレート制限を超えた場合、システムは429ステータスコードを返さなければならない
- SSL証明書が期限切れになった場合、システムは管理者に警告しなければならない
- サードパーティサービスが利用不可の場合、システムはフォールバックモードを有効化しなければならない
```

**時間ベースのイベント**:

```markdown
- ユーザーセッションが期限切れになった場合、システムは再認証を要求しなければならない
- スケジュールされたレポートの期限が来た場合、システムはレポートを生成し配信しなければならない
- トライアル期間が終了した場合、システムはユーザーに通知しアクセスを制限しなければならない
- データ保持期間が期限切れになった場合、システムはデータをアーカイブまたは削除しなければならない
- メンテナンスウィンドウが開始された場合、システムはアクティブなユーザーに通知しなければならない
```

#### 高度なイベント駆動パターン

**複数トリガー**:

```markdown
- ユーザーログインが失敗した場合 または アカウントがロックされている場合、システムはセキュリティ警告を送信しなければならない
- ファイルアップロードが完了した場合 かつ ウイルススキャンに合格した場合、システムはファイルを処理しなければならない
- 高CPU使用が検出された場合 かつ メモリ使用が90%を超える場合、システムはリソースをスケールしなければならない
```

**連鎖イベント**:

```markdown
- ユーザー登録が完了した場合、システムはユーザープロフィールを作成し、ウェルカムメールを送信し、ユーザー設定を初期化しなければならない
- 支払いが処理された場合、システムはサブスクリプションを更新し、領収書を送信し、アクセスを延長しなければならない
- セキュリティインシデントが検出された場合、システムはイベントをログに記録し、管理者に通知し、インシデント対応をトリガーしなければならない
```

**複雑な条件**:

```markdown
- ユーザーが新しいデバイスからログインを試み かつ 通常と異なる場所からの場合、システムは追加検証を要求しなければならない
- APIリクエストがレート制限を超え かつ ユーザーがプレミアムでない場合、システムはリクエストをスロットルしなければならない
- システム負荷が80%を超え かつ 応答時間が5秒を超える場合、システムはキャッシングモードを有効化しなければならない
```

### パターン3: 状態駆動要件 (State-driven Requirements)

**目的**: 特定の条件や状態の維持に依存するシステム動作を定義します。

**構文**: `<条件> が存在する間、システムは <動作> しなければならない`

**使用するタイミング**:

- 継続的な動作
- 状態依存の機能
- コンテキスト対応の操作
- 継続的なシステム条件
- 永続モード

**構造**:

```
[状態/条件が存在する] 間、システムは [継続的な動作] [制約/詳細] しなければならない
```

#### 例

**認証状態**:

```markdown
- ユーザーが認証されている間、システムは保護されたリソースへのアクセスを許可しなければならない
- ユーザーセッションがアクティブな間、システムはユーザーコンテキストと設定を維持しなければならない
- 多要素認証が保留中の間、システムは機密操作を制限しなければならない
- パスワードリセットが進行中の間、システムは通常のログイン試行をブロックしなければならない
- アカウントが停止されている間、システムはすべてのアクセス試行を拒否しなければならない
```

**システムモード**:

```markdown
- メンテナンスモードがアクティブな間、システムは管理者アクセスのみを許可しなければならない
- 読み取り専用モードが有効な間、システムはすべての書き込み操作を拒否しなければならない
- デバッグモードがアクティブな間、システムは詳細な実行情報をログに記録しなければならない
- キャッシングモードが有効な間、システムは可能な場合キャッシュから応答を提供しなければならない
- バックアップが進行中の間、システムは書き込み操作をキューイングしなければならない
```

**ビジネス条件**:

```markdown
- サブスクリプションがアクティブな間、システムはプレミアム機能を提供しなければならない
- トライアル期間がアクティブな間、システムはトライアル通知を表示しなければならない
- クォータ制限が超過している間、システムはAPIリクエストをスロットルしなければならない
- プロモーション期間がアクティブな間、システムは割引コードを適用しなければならない
- コンプライアンス監査が進行中の間、システムは拡張ログを有効化しなければならない
```

**リソース状態**:

```markdown
- ディスク容量が10%未満の間、システムは管理者に警告しなければならない
- メモリ使用が90%を超えている間、システムは頻繁にガベージコレクションを実行しなければならない
- ネットワークレイテンシが高い間、システムは圧縮を有効化しなければならない
- データベース接続が枯渇している間、システムはリクエストをキューイングしなければならない
- CPU使用が80%を超えて持続する間、システムは水平スケールしなければならない
```

#### 高度な状態駆動パターン

**ネストされた状態**:

```markdown
- ユーザーが認証されており かつ サブスクリプションがアクティブな間、システムは完全な機能アクセスを提供しなければならない
- システムがメンテナンスモードであり かつ ユーザーが管理者の間、システムは読み取り専用アクセスを許可しなければならない
- レート制限がアクティブであり かつ ユーザーがプレミアムの間、システムは緩和された制限を適用しなければならない
```

**状態遷移**:

```markdown
- ユーザーステータスが「保留中」の間、システムは毎週検証リマインダーを送信しなければならない
- 注文ステータスが「処理中」の間、システムは5分ごとに進捗を更新しなければならない
- デプロイメントステータスが「ローリング」の間、システムは段階的にトラフィックをシフトしなければならない
```

**条件付き永続性**:

```markdown
- 機能フラグが有効な間、システムは新しい認証フローを使用しなければならない
- A/Bテストがアクティブな間、システムはユーザーセグメントに基づいてトラフィックをルーティングしなければならない
- 移行が進行中の間、システムは古い形式と新しい形式の両方のデータをサポートしなければならない
```

### パターン4: オプショナル要件 (Optional Requirements)

**目的**: 常に存在するとは限らないあると便利な機能や条件付き機能を定義します。

**構文**: `<条件が満たされている> 場合、システムは <オプショナルな動作> してもよい`

**使用するタイミング**:

- オプショナル機能
- 設定依存の機能
- 拡張機会
- 将来の能力
- 条件付き動作

**構造**:

```
[条件が存在する] 場合、システムは [オプショナルな動作] [実装詳細] してもよい
```

#### 例

**機能フラグ**:

```markdown
- 多要素認証が有効な場合、システムは追加検証を要求してもよい
- ソーシャルログインが設定されている場合、システムはOAuth認証をサポートしてもよい
- ベータ機能が有効な場合、システムは実験的な機能を提供してもよい
- 高度な分析が有効な場合、システムは詳細なユーザー行動を追跡してもよい
- AI推奨が利用可能な場合、システムはユーザーにコンテンツを提案してもよい
```

**設定オプション**:

```markdown
- メール通知が有効な場合、システムはリアルタイムアラートを送信してもよい
- キャッシングが設定されている場合、システムは頻繁にアクセスされるデータを保存してもよい
- バックアップ自動化が有効な場合、システムは毎日スナップショットを作成してもよい
- モニタリングがアクティブな場合、システムはパフォーマンスメトリクスを収集してもよい
- デバッグが有効な場合、システムは詳細な実行ログを記録してもよい
```

**統合機能**:

```markdown
- サードパーティカレンダーが接続されている場合、システムはイベントを同期してもよい
- 支払いゲートウェイが利用可能な場合、システムはトランザクションを処理してもよい
- SMSサービスが設定されている場合、システムはテキストメッセージを送信してもよい
- ストレージプロバイダーが設定されている場合、システムはクラウドストレージを使用してもよい
- CDNが利用可能な場合、システムはエッジロケーションから静的アセットを提供してもよい
```

**拡張機能**:

```markdown
- ユーザー設定が許可する場合、システムはコンテンツ推奨をパーソナライズしてもよい
- デバイス機能がサポートする場合、システムは高度な機能を有効化してもよい
- ブラウザがサポートする場合、システムは最新のWeb APIを使用してもよい
- ネットワーク条件が許可する場合、システムは高品質メディアを読み込んでもよい
- ユーザーの同意が提供された場合、システムは分析データを収集してもよい
```

#### 高度なオプショナルパターン

**複数条件**:

```markdown
- ユーザーがプレミアムであり かつ 高度な機能が有効な場合、システムは優先サポートを提供してもよい
- モバイルアプリがインストールされており かつ プッシュ通知が有効な場合、システムはモバイルアラートを送信してもよい
- AI処理が利用可能であり かつ ユーザーデータが十分な場合、システムはインサイトを生成してもよい
```

**階層的オプション**:

```markdown
- 基本検索が利用可能な場合、システムはテキスト検索を提供してもよい
- 高度な検索が有効な場合、システムはファセット検索を提供してもよい
- AI検索が設定されている場合、システムは自然言語クエリを提供してもよい
```

**段階的な拡張**:

```markdown
- JavaScriptが有効な場合、システムはインタラクティブなインターフェースを提供してもよい
- WebAssemblyがサポートされている場合、システムはクライアントサイド処理を使用してもよい
- Service Workerが利用可能な場合、システムはオフライン機能を有効化してもよい
```

### パターン5: 望ましくない動作 (制約)

**目的**: システムが行うべきでないことと制約・制限を定義します。

**構文**: `システムは <望ましくない動作> してはならない` または `<パラメータ> は <制約> してはならない`

**使用するタイミング**:

- セキュリティ制約
- ビジネスルール
- 技術的制限
- 品質要件
- 規制コンプライアンス

**構造**:

```
システムは [禁止された動作] してはならない
[パラメータ] は [制約/制限] してはならない
```

#### 例

**セキュリティ制約**:

```markdown
- システムはパスワードを平文で保存してはならない
- システムはエラーメッセージで機密情報を明らかにしてはならない
- システムはユーザー入力でSQLインジェクションを許可してはならない
- システムは暗号化されていない通信を受け入れてはならない
- システムはユーザーに内部システムの詳細を公開してはならない
```

**データ制約**:

```markdown
- ユーザーパスワードは8文字未満であってはならない
- メールアドレスは特殊文字を含んではならない
- ファイルアップロードはサイズが100MBを超えてはならない
- APIリクエストは1000レコードを超えてはならない
- セッショントークンは24時間を超えて有効であってはならない
```

**パフォーマンス制約**:

```markdown
- 応答時間はどのリクエストでも5秒を超えてはならない
- データベースクエリは2秒を超えてはならない
- ファイルアップロードは30秒を超えてはならない
- ログインプロセスは3秒を超えてはならない
- レポート生成は10分を超えてはならない
```

**ビジネスルール**:

```markdown
- システムは重複したメールアドレスを許可してはならない
- システムは同じ認証情報での同時セッションを許可してはならない
- システムは負のアカウント残高を許可してはならない
- システムは適切な承認なしで支払いを処理してはならない
- システムは確認なしでユーザーデータを削除してはならない
```

**技術的制限**:

```markdown
- システムはInternet Explorer 11をサポートしてはならない
- システムはIPごとに1分あたり1000リクエストを超えて処理してはならない
- システムはユーザーごとに1TBを超えてデータを保存してはならない
- システムは利用可能なメモリを超えるファイルアップロードをサポートしてはならない
- システムはデータベース接続なしで機能してはならない
```

#### 高度な制約パターン

**条件付き制約**:

```markdown
- ユーザーがプレミアムでない場合、システムはAPIアクセスレートを1時間あたり100を超えて許可してはならない
- システムがメンテナンス中の場合、システムはいかなる書き込み操作も許可してはならない
- コンプライアンスモードがアクティブな場合、システムは機密データをエクスポートしてはならない
```

**複雑な制約**:

```markdown
- システムは過去5つのパスワードの再利用を許可してはならない
- システムは同じユーザーからの同時アップロードが5ファイルを超えることを許可してはならない
- システムは2年を超えて古いAPIバージョンをサポートしてはならない
```

**規制制約**:

```markdown
- システムは明示的な同意なしで個人データを保存してはならない
- システムはPCIコンプライアンスなしで支払いを処理してはならない
- システムは適切な保護措置なしでデータを国境を越えて転送してはならない
- システムは法的に要求される期間を超えてデータを保持してはならない
```

## 高度なEARS技術

### パターンの組み合わせ

複雑な要件はしばしば複数のEARSパターンを組み合わせます:

```markdown
# 例: 複雑な認証システム

## コア認証 (常時要件)
- システムはメールアドレスとパスワードによるユーザー認証を提供しなければならない
- システムは安全なセッション管理を維持しなければならない
- システムはすべての認証試行をログに記録しなければならない

## ログイン動作 (イベント駆動要件)
- 有効な認証情報が提供された場合、システムはJWTトークンを発行しなければならない
- 無効な認証情報が提供された場合、システムは401エラーを返さなければならない
- 複数回の失敗した試行が発生した場合、システムはレート制限を実装しなければならない

## セッション管理 (状態駆動要件)
- ユーザーが認証されている間、システムは保護されたリソースへのアクセスを許可しなければならない
- セッションがアクティブな間、システムは自動的にトークンをリフレッシュしなければならない
- セキュリティ脅威が検出されている間、システムは再認証を要求しなければならない

## 拡張機能 (オプショナル要件)
- 多要素認証が有効な場合、システムは追加検証を要求しなければならない
- バイオメトリック認証が利用可能な場合、システムは指紋ログインをサポートしてもよい
- ソーシャルログインが設定されている場合、システムはOAuth認証を許可してもよい

## セキュリティ制約 (望ましくない動作)
- システムはパスワードを平文で保存してはならない
- パスワードは8文字未満であってはならない
- システムは未承認ユーザーにアカウントの存在を明らかにしてはならない
```

## よくあるEARSの間違いと修正方法

### 間違い1: パターンの混在

**❌ 不正確**:

```markdown
ユーザーがログインする場合、システムは弱いパスワードを許可してはならない
```

**✅ 正しい**:

```markdown
ユーザーが弱いパスワードでログインを試みる場合、システムは認証を拒否しなければならない
パスワードは8文字未満であってはならない
```

### 間違い2: 曖昧な言語

**❌ 不正確**:

```markdown
システムは高速でなければならない
```

**✅ 正しい**:

```markdown
システムはユーザーリクエストに2秒以内に応答しなければならない
```

### 間違い3: 1つの文に複数の要件

**❌ 不正確**:

```markdown
ユーザーが登録する場合、システムはアカウントを作成し、ウェルカムメールを送信し、デフォルト設定を設定しなければならない
```

**✅ 正しい**:

```markdown
ユーザー登録が完了した場合、システムはユーザーアカウントを作成しなければならない
ユーザーアカウントが作成された場合、システムはウェルカムメールを送信しなければならない
ウェルカムメールが送信された場合、システムはデフォルトのユーザー設定を設定しなければならない
```

### 間違い4: エラー条件の欠落

**❌ 不正確**:

```markdown
ユーザーが有効な認証情報を送信する場合、システムはユーザーを認証しなければならない
```

**✅ 正しい**:

```markdown
有効な認証情報が提供された場合、システムはユーザーを認証しなければならない
無効な認証情報が提供された場合、システムは401エラーを返さなければならない
認証サービスが利用不可の場合、システムは503エラーを返さなければならない
```

### 間違い5: 要件内の実装詳細

**❌ 不正確**:

```markdown
システムはPostgreSQLのusersテーブルで12ラウンドのbcryptを使用してパスワードをハッシュしなければならない
```

**✅ 正しい**:

```markdown
システムは最小12ラウンドの安全なアルゴリズムを使用してパスワードをハッシュしなければならない
システムはパスワードハッシュをデータベースに安全に保存しなければならない
```

## EARS検証と品質保証

### 自動検証

MoAI-ADKはEARS構文を検証するツールを提供します:

```bash
# SPEC構文を検証
moai-adk validate-ears .moai/specs/SPEC-AUTH-001/spec.md

# EARSパターンのコンプライアンスをチェック
moai-adk check-ears-patterns .moai/specs/

# EARS品質レポートを生成
moai-adk ears-quality-report
```

### 品質チェックリスト

各要件について、以下を検証してください:

**パターンのコンプライアンス**:

- [ ] 要件タイプに対して正しいEARSパターンを使用
- [ ] 指定された構文構造に従う
- [ ] 適切なトリガー/条件を含む
- [ ] 明確な応答/動作を指定

**明確性と正確性**:

- [ ] 言語が曖昧でない
- [ ] 技術用語が定義されている
- [ ] 測定が定量化されている
- [ ] スコープが明確に境界付けられている

**テスト可能性**:

- [ ] 成功基準が定義されている
- [ ] テストシナリオを作成できる
- [ ] 期待される結果が指定されている
- [ ] エッジケースが考慮されている

**完全性**:

- [ ] すべての機能的側面がカバーされている
- [ ] エラー条件が含まれている
- [ ] パフォーマンス要件が指定されている
- [ ] セキュリティ考慮事項が対処されている

### レビュープロセス

1. **自己レビュー**: 著者がEARSコンプライアンスをチェック
2. **ピアレビュー**: チームメンバーが構文と明確性を検証
3. **エキスパートレビュー**: ドメインエキスパートが完全性を確認
4. **自動チェック**: ツールが構文とパターンを検証
5. **最終承認**: ステークホルダーが要件を承認

## 実世界のEARS例

### Eコマースシステム

```markdown
# @SPEC:ECOM-001: ショッピングカート管理

## コア機能 (常時要件)
- システムはセッション間でショッピングカートの状態を維持しなければならない
- システムは税金と送料を含むカート合計を計算しなければならない
- システムはカートに追加する前に製品の在庫状況を検証しなければならない
- システムは複数の支払い方法をサポートしなければならない
- システムは注文確認と追跡を提供しなければならない

## カート操作 (イベント駆動要件)
- ユーザーがアイテムをカートに追加する場合、システムは在庫を更新し合計を再計算しなければならない
- ユーザーがアイテムをカートから削除する場合、システムは在庫を解放し合計を更新しなければならない
- ユーザーが割引コードを適用する場合、システムは検証し有効であれば割引を適用しなければならない
- ユーザーがチェックアウトに進む場合、システムはカートを検証し支払いにリダイレクトしなければならない
- 支払いが成功した場合、システムは注文を作成しカートをクリアしなければならない

## セッション管理 (状態駆動要件)
- カートにアイテムが含まれている間、システムは30日間カートデータを保持しなければならない
- ユーザーが認証されている間、システムはゲストカートをユーザーカートにマージしなければならない
- チェックアウトが進行中の間、システムはカートの内容をロックしなければならない
- 支払いが処理されている間、システムは支払いステータスを表示しなければならない

## 拡張機能 (オプショナル要件)
- ウィッシュリストが有効な場合、システムは後で保存するアイテムを許可しなければならない
- 推奨が利用可能な場合、システムは関連製品を提案してもよい
- ゲストチェックアウトが有効な場合、システムはアカウントなしで購入を許可してもよい
- ロイヤルティプログラムがアクティブな場合、システムはリワードポイントを適用しなければならない

## ビジネス制約 (望ましくない動作)
- システムは空のカートでチェックアウトを許可してはならない
- システムは期限切れの割引コードを適用してはならない
- システムは在庫切れアイテムを販売してはならない
- カートは100アイテムを超えてはならない
- システムはPCIコンプライアンスなしで支払い情報を保存してはならない
```

## まとめ

EARS構文をマスターすることで、成功するソフトウェア開発の基盤となる明確で曖昧さがなく、テスト可能な要件を書くことができます。これらのパターンを練習すれば、仕様記述において自然になります! 🎯
