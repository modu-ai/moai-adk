import { test, expect } from '@playwright/test';

test.describe('Security Vulnerability Analysis', () => {
  const baseURL = 'http://localhost:3000';

  test.beforeEach(async ({ page }) => {
    await page.goto(baseURL);
  });

  test('XSS Protection and Input Validation', async ({ page }) => {
    console.log('ğŸ›¡ï¸ XSS Protection and Input Validation...');

    // 1. XSS ê³µê²© íŒ¨í„´ í™•ì¸
    const xssPatterns = [
      '<script>alert("xss")</script>',
      'javascript:alert("xss")',
      '<img src=x onerror=alert("xss")>',
      '<svg onload=alert("xss")>',
      '"><script>alert("xss")</script>',
      "'><script>alert('xss')</script>",
      '<iframe src="javascript:alert(\'xss\')"></iframe>',
      '<body onload=alert("xss")>',
      '<input onfocus=alert("xss") autofocus>',
      '<select onfocus=alert("xss") autofocus>'
    ];

    const xssResults = [];

    for (const pattern of xssPatterns) {
      // URL íŒŒë¼ë¯¸í„°ë¥¼ í†µí•œ XSS í…ŒìŠ¤íŠ¸
      await page.goto(`${baseURL}?search=${encodeURIComponent(pattern)}`);

      // ì½˜ì†” ì—ëŸ¬/ê²½ê³  ìˆ˜ì§‘
      const consoleMessages: string[] = [];
      page.on('console', msg => {
        if (msg.type() === 'error' || msg.type() === 'warning') {
          consoleMessages.push(msg.text());
        }
      });

      // alert í˜¸ì¶œ ê°ì§€
      let alertTriggered = false;
      page.on('dialog', dialog => {
        alertTriggered = true;
        dialog.dismiss();
      });

      await page.waitForTimeout(1000);

      // í˜ì´ì§€ ë‚´ìš©ì—ì„œ íŒ¨í„´ í™•ì¸
      const pageContent = await page.content();
      const patternInContent = pageContent.includes(pattern);

      xssResults.push({
        pattern,
        alertTriggered,
        consoleErrors: consoleMessages.length,
        patternInContent
      });

      // ê¸°ë³¸ í˜ì´ì§€ë¡œ ë³µê·€
      await page.goto(baseURL);
    }

    console.log(`ğŸ›¡ï¸ XSS Protection Analysis:`);
    xssResults.forEach(result => {
      const status = !result.alertTriggered && !result.patternInContent ? 'âœ…' : 'âŒ';
      console.log(`   ${status} ${result.pattern.substring(0, 30)}... - Alert: ${result.alertTriggered}, Content: ${result.patternInContent}`);
    });

    // XSS ì·¨ì•½ì  ê²€ì¦
    const xssVulnerabilities = xssResults.filter(r => r.alertTriggered || r.patternInContent);
    expect(xssVulnerabilities.length).toBe(0);
  });

  test('Content Security Policy (CSP) Headers', async ({ page }) => {
    console.log('ğŸ”’ Content Security Policy Analysis...');

    // CSP í—¤ë” í™•ì¸
    const cspAnalysis = await page.evaluate(() => {
      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” CSP ì •ë³´
      const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
      const cspMetaContent = cspMeta?.getAttribute('content') || '';

      // script-src ë° style-src ì§€ì‹œì í™•ì¸
      const scripts = document.querySelectorAll('script[src]');
      const styles = document.querySelectorAll('link[rel="stylesheet"], style');

      const externalResources = {
        scripts: Array.from(scripts).map(s => s.getAttribute('src') || ''),
        styles: Array.from(styles).map(s =>
          s.getAttribute('href') || s.getAttribute('data-href') || ''
        )
      };

      // ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ë° ìŠ¤íƒ€ì¼ í™•ì¸
      const inlineScripts = document.querySelectorAll('script:not([src])');
      const inlineStyles = document.querySelectorAll('style:not([media])');

      return {
        hasCSPMeta: !!cspMeta,
        cspMetaContent,
        externalScripts: externalResources.scripts.length,
        externalStyles: externalResources.styles.length,
        inlineScripts: inlineScripts.length,
        inlineStyles: inlineStyles.length,
        usesExternalCDN: externalResources.scripts.some(src =>
          src.includes('cdn.') || src.includes('cdnjs') || src.includes('unpkg')
        )
      };
    });

    // ë³´ì•ˆ ê´€ë ¨ ë©”íƒ€ íƒœê·¸ í™•ì¸
    const securityMetaTags = await page.evaluate(() => {
      const metaTags: Record<string, string> = {};

      const securityMetas = [
        'charset',
        'viewport',
        'http-equiv="content-type"',
        'http-equiv="default-style"',
        'http-equiv="refresh"',
        'name="referrer"',
        'name="color-scheme"'
      ];

      securityMetas.forEach(selector => {
        const meta = document.querySelector(`meta[${selector}]`);
        if (meta) {
          metaTags[selector] = meta.getAttribute('content') || 'present';
        }
      });

      return metaTags;
    });

    console.log(`ğŸ”’ CSP Analysis:`);
    console.log(`   - CSP Meta Tag: ${cspAnalysis.hasCSPMeta ? 'âœ…' : 'âŒ'}`);
    console.log(`   - CSP Content: ${cspAnalysis.cspMetaContent || 'None'}`);
    console.log(`   - External Scripts: ${cspAnalysis.externalScripts}`);
    console.log(`   - External Styles: ${cspAnalysis.externalStyles}`);
    console.log(`   - Inline Scripts: ${cspAnalysis.inlineScripts}`);
    console.log(`   - Inline Styles: ${cspAnalysis.inlineStyles}`);
    console.log(`   - Uses CDN: ${cspAnalysis.usesExternalCDN ? 'âš ï¸' : 'âœ…'}`);

    console.log(`ğŸ›¡ï¸ Security Meta Tags:`);
    Object.entries(securityMetaTags).forEach(([tag, value]) => {
      console.log(`   - ${tag}: ${value}`);
    });

    // ë³´ì•ˆ ê¸°ì¤€ í™•ì¸
    expect(cspAnalysis.inlineScripts).toBeLessThan(5); // ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ ìµœì†Œí™”
  });

  test('Authentication and Authorization Security', async ({ page }) => {
    console.log('ğŸ” Authentication and Authorization Security...');

    // ì¸ì¦ ê´€ë ¨ ë³´ì•ˆ í™•ì¸
    const authSecurity = await page.evaluate(() => {
      const checks: any = {};

      // 1. ë¯¼ê° ì •ë³´ ë…¸ì¶œ í™•ì¸
      const bodyText = document.body.innerText;
      const sensitivePatterns = [
        /password/i,
        /token/i,
        /secret/i,
        /api[_-]?key/i,
        /private[_-]?key/i,
        /auth[_-]?token/i
      ];

      checks.sensitiveInfoExposed = sensitivePatterns.some(pattern => pattern.test(bodyText));

      // 2. ë¡œê·¸ì¸ í¼ ë³´ì•ˆ í™•ì¸
      const loginForms = document.querySelectorAll('form');
      const passwordInputs = document.querySelectorAll('input[type="password"]');
      const formsWithAutocompleteOff = Array.from(loginForms).filter(form =>
        form.getAttribute('autocomplete') === 'off'
      );

      // 3. CSRF í† í° í™•ì¸
      const csrfTokens = document.querySelectorAll('input[name*="csrf"], input[name*="token"]');

      // 4. HTTPS ì‚¬ìš© í™•ì¸ (í”„ë¡œë•ì…˜ì—ì„œ)
      const isHTTPS = window.location.protocol === 'https:';
      const secureCookies = document.cookie.includes('Secure');

      // 5. ì„¸ì…˜ ê´€ë¦¬ í™•ì¸
      const hasSessionManagement = !!document.querySelector('meta[name="csrf-token"]') ||
        !!document.querySelector('input[name="_token"]');

      checks.loginForms = loginForms.length;
      checks.passwordInputs = passwordInputs.length;
      checks.formsWithAutocompleteOff = formsWithAutocompleteOff.length;
      checks.csrfTokens = csrfTokens.length;
      checks.isHTTPS = isHTTPS;
      checks.secureCookies = secureCookies;
      checks.hasSessionManagement = hasSessionManagement;

      return checks;
    });

    // ì¿ í‚¤ ë³´ì•ˆ í™•ì¸
    const cookieAnalysis = await page.evaluate(() => {
      const cookies = document.cookie.split(';').filter(c => c.trim());
      const secureCookies = cookies.filter(c => c.toLowerCase().includes('secure'));
      const httpOnlyCookies = cookies.filter(c => c.toLowerCase().includes('httponly'));
      const sameSiteCookies = cookies.filter(c =>
        c.toLowerCase().includes('samesite=strict') ||
        c.toLowerCase().includes('samesite=lax')
      );

      return {
        totalCookies: cookies.length,
        secureCookies: secureCookies.length,
        httpOnlyCookies: httpOnlyCookies.length, // í´ë¼ì´ì–¸íŠ¸ì—ì„œëŠ” í™•ì¸ ë¶ˆê°€
        sameSiteCookies: sameSiteCookies.length
      };
    });

    console.log(`ğŸ” Authentication Security:`);
    console.log(`   - Sensitive Info Exposed: ${authSecurity.sensitiveInfoExposed ? 'âŒ' : 'âœ…'}`);
    console.log(`   - Login Forms: ${authSecurity.loginForms}`);
    console.log(`   - Password Inputs: ${authSecurity.passwordInputs}`);
    console.log(`   - Forms with Autocomplete Off: ${authSecurity.formsWithAutocompleteOff}`);
    console.log(`   - CSRF Tokens: ${authSecurity.csrfTokens}`);
    console.log(`   - HTTPS: ${authSecurity.isHTTPS ? 'âœ…' : 'âš ï¸ (Dev Mode)'}`);
    console.log(`   - Session Management: ${authSecurity.hasSessionManagement ? 'âœ…' : 'âŒ'}`);

    console.log(`ğŸª Cookie Security:`);
    console.log(`   - Total Cookies: ${cookieAnalysis.totalCookies}`);
    console.log(`   - Secure Cookies: ${cookieAnalysis.secureCookies}`);
    console.log(`   - SameSite Cookies: ${cookieAnalysis.sameSiteCookies}`);

    // ë³´ì•ˆ ê¸°ì¤€ ê²€ì¦
    expect(authSecurity.sensitiveInfoExposed).toBe(false);
  });

  test('Data Privacy and Compliance', async ({ page }) => {
    console.log('ğŸ”’ Data Privacy and Compliance...');

    // ê°œì¸ì •ë³´ë³´í˜¸ ê´€ë ¨ í™•ì¸
    const privacyCompliance = await page.evaluate(() => {
      const checks: any = {};

      // 1. ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ ë§í¬ í™•ì¸
      const privacyLinks = Array.from(document.querySelectorAll('a')).filter(link => {
        const text = link.textContent?.toLowerCase() || '';
        const href = link.getAttribute('href')?.toLowerCase() || '';
        return text.includes('privacy') || text.includes('ê°œì¸ì •ë³´') ||
               href.includes('privacy') || href.includes('policy');
      });

      // 2. ì¿ í‚¤ ë™ì˜ ë°°ë„ˆ í™•ì¸
      const cookieBanner = document.querySelector('.cookie-banner, .cookie-consent, .gdpr, [class*="cookie"]');
      const cookieSettings = document.querySelector('.cookie-settings, .privacy-settings');

      // 3. Google Analytics ë“± ì¶”ì  ìŠ¤í¬ë¦½íŠ¸ í™•ì¸
      const trackingScripts = [
        'google-analytics',
        'googletagmanager',
        'gtag',
        'facebook',
        'pixel',
        'hotjar',
        'mixpanel'
      ];

      const detectedTracking = [];
      for (const script of trackingScripts) {
        const elements = document.querySelectorAll(`script[src*="${script}"], [data-${script}]`);
        if (elements.length > 0) {
          detectedTracking.push(script);
        }
      }

      // 4. ë¡œì»¬ ì €ì¥ì†Œ ì‚¬ìš© í™•ì¸
      const localStorageUsage = Object.keys(localStorage).length;
      const sessionStorageUsage = Object.keys(sessionStorage).length;

      checks.privacyLinks = privacyLinks.length;
      checks.hasCookieBanner = !!cookieBanner;
      checks.hasCookieSettings = !!cookieSettings;
      checks.trackingScripts = detectedTracking;
      checks.localStorageUsage = localStorageUsage;
      checks.sessionStorageUsage = sessionStorageUsage;

      return checks;
    });

    // ì™¸ì¥ ì†ŒìŠ¤ ë¶„ì„
    const thirdPartyAnalysis = await page.evaluate(() => {
      const scripts = Array.from(document.querySelectorAll('script[src]'));
      const links = Array.from(document.querySelectorAll('link[href]'));
      const iframes = Array.from(document.querySelectorAll('iframe[src]'));

      const allExternal = [...scripts, ...links, ...iframes].map(el => {
        const src = el.getAttribute('src') || el.getAttribute('href') || '';
        return new URL(src, window.location.href);
      });

      const domains = [...new Set(allExternal.map(url => url.hostname))];
      const thirdPartyDomains = domains.filter(domain =>
        domain !== window.location.hostname &&
        !domain.includes('localhost') &&
        !domain.includes('127.0.0.1')
      );

      return {
        totalExternalResources: allExternal.length,
        uniqueDomains: domains.length,
        thirdPartyDomains: thirdPartyDomains.length,
        domains: thirdPartyDomains
      };
    });

    console.log(`ğŸ”’ Privacy Compliance:`);
    console.log(`   - Privacy Policy Links: ${privacyCompliance.privacyLinks}`);
    console.log(`   - Cookie Banner: ${privacyCompliance.hasCookieBanner ? 'âœ…' : 'âŒ'}`);
    console.log(`   - Cookie Settings: ${privacyCompliance.hasCookieSettings ? 'âœ…' : 'âŒ'}`);
    console.log(`   - Tracking Scripts: ${privacyCompliance.trackingScripts.join(', ')}`);
    console.log(`   - Local Storage Usage: ${privacyCompliance.localStorageUsage} items`);
    console.log(`   - Session Storage Usage: ${privacyCompliance.sessionStorageUsage} items`);

    console.log(`ğŸŒ Third-Party Analysis:`);
    console.log(`   - External Resources: ${thirdPartyAnalysis.totalExternalResources}`);
    console.log(`   - Unique Domains: ${thirdPartyAnalysis.uniqueDomains}`);
    console.log(`   - Third-Party Domains: ${thirdPartyAnalysis.thirdPartyDomains}`);
    console.log(`   - Domains: ${thirdPartyAnalysis.domains.join(', ')}`);

    // ê°œì¸ì •ë³´ë³´í˜¸ ê¸°ì¤€ í™•ì¸
    if (privacyCompliance.trackingScripts.length > 0) {
      expect(privacyCompliance.hasCookieBanner || privacyCompliance.privacyLinks.length > 0).toBe(true);
    }
  });

  test('HTTP Headers and Transport Security', async ({ page }) => {
    console.log(`ğŸŒ HTTP Headers and Transport Security...`);

    // ì‘ë‹µ í—¤ë” ë¶„ì„ (ê°€ëŠ¥í•œ ë¶€ë¶„ê¹Œì§€)
    const securityHeaders: Record<string, boolean> = {};

    const responses: any[] = [];
    page.on('response', response => {
      if (response.url().startsWith(baseURL)) {
        const headers = response.headers();
        responses.push({
          url: response.url(),
          headers: {
            'X-Content-Type-Options': !!headers['x-content-type-options'],
            'X-Frame-Options': !!headers['x-frame-options'],
            'X-XSS-Protection': !!headers['x-xss-protection'],
            'Strict-Transport-Security': !!headers['strict-transport-security'],
            'Content-Security-Policy': !!headers['content-security-policy'],
            'Referrer-Policy': !!headers['referrer-policy'],
            'Permissions-Policy': !!headers['permissions-policy'],
            'Cache-Control': !!headers['cache-control']
          }
        });
      }
    });

    await page.goto(baseURL);
    await page.waitForLoadState('networkidle');

    // ë³´ì•ˆ í—¤ë” ë¶„ì„
    if (responses.length > 0) {
      const mainResponse = responses[0];
      Object.assign(securityHeaders, mainResponse.headers);
    }

    console.log(`ğŸ”’ Security Headers:`);
    Object.entries(securityHeaders).forEach(([header, present]) => {
      console.log(`   - ${header}: ${present ? 'âœ…' : 'âŒ'}`);
    });

    // í”„ë¡œí† ì½œ ë° ì¸ì¦ì„œ ì •ë³´ í™•ì¸
    const protocolInfo = await page.evaluate(() => {
      return {
        protocol: window.location.protocol,
        hostname: window.location.hostname,
        port: window.location.port,
        isLocalhost: window.location.hostname === 'localhost' ||
                     window.location.hostname === '127.0.0.1',
        isHTTPS: window.location.protocol === 'https:'
      };
    });

    console.log(`ğŸŒ Protocol Information:`);
    console.log(`   - Protocol: ${protocolInfo.protocol}`);
    console.log(`   - Hostname: ${protocolInfo.hostname}`);
    console.log(`   - Port: ${protocolInfo.port}`);
    console.log(`   - Is Localhost: ${protocolInfo.isLocalhost ? 'âœ…' : 'âŒ'}`);
    console.log(`   - Is HTTPS: ${protocolInfo.isHTTPS ? 'âœ…' : 'âš ï¸ (HTTP)'}`);

    // ë³´ì•ˆ ê¸°ì¤€ ê²€ì¦
    if (!protocolInfo.isLocalhost) {
      expect(securityHeaders['X-Content-Type-Options']).toBe(true);
      expect(securityHeaders['X-Frame-Options']).toBe(true);
    }

    // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ì¼ë¶€ í—¤ë”ê°€ ì—†ì„ ìˆ˜ ìˆìŒ
    expect(protocolInfo.isLocalhost || securityHeaders['X-Content-Type-Options']).toBe(true);
  });
});