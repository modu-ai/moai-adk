# moai-adk-go Local Development Guide

> **Purpose**: Essential guide for local moai-adk-go development
> **Audience**: GOOS (local developer only)
> **Last Updated**: 2026-02-20

---

## 1. Quick Start

### Work Location
```bash
# Primary work location (template development)
/Users/goos/MoAI/moai-adk-go/internal/template/templates/

# Local project (testing & git)
/Users/goos/MoAI/moai-adk-go/
```

### Development Cycle
```
1. Work in internal/template/templates/
2. Run `make build` to regenerate embedded files
3. Test in local project
4. Git commit from local root
```

### [CRITICAL] moai CLI vs /moai Slash Command

**DO NOT CONFUSE** these two completely different things:

| | `moai` (Terminal CLI) | `/moai` (Slash Command) |
|---|---|---|
| **Where** | Terminal shell | Claude Code chat input |
| **What** | Go binary (`~/go/bin/moai`) | Claude Code skill invocation |
| **Purpose** | Project setup, template deployment | AI-assisted development workflows |
| **Example** | `moai init myproject` | `/moai plan "add auth"` |
| **Scope** | File system operations | AI agent orchestration |

**Terminal `moai` commands:**
```bash
moai init <project>     # Initialize new project with templates
moai update             # Sync templates to current project
moai build              # Build embedded templates
moai hook <event>       # Execute hook handler
moai glm                # GLM worker mode
moai version            # Show version
```

**Claude Code `/moai` commands:**
```
/moai plan "feature"    # Create SPEC document
/moai run SPEC-XXX      # Implement SPEC
/moai sync SPEC-XXX     # Generate docs & PR
/moai fix               # Auto-fix errors
/moai loop              # Iterative fix loop
/moai project           # Generate project docs
/moai feedback          # Create GitHub issue
```

**Common mistake to avoid:**
- WRONG: Running `/moai init` in Claude Code chat (not a valid slash command)
- CORRECT: Running `moai init` in terminal
- WRONG: Running `moai plan` in terminal (not a CLI command)
- CORRECT: Running `/moai plan` in Claude Code chat

---

## 2. File Synchronization

### Protected Directories (Never Modify During Template Sync)
```bash
# CRITICAL: These directories contain user data and must NEVER be deleted
.claude/        # Local Claude Code configuration
.moai/project/  # Project documentation (product.md, structure.md, tech.md)
.moai/specs/    # SPEC documents (active development files)
```

### Template Source (Single Source of Truth)
```bash
# All template changes MUST be made here
internal/template/templates/.claude/
internal/template/templates/.moai/
internal/template/templates/CLAUDE.md
```

### Local-Only Files (Never in Templates)
```
.claude/settings.local.json    # Personal settings
CLAUDE.local.md                # This file
.claude/hooks/moai/handle-*.sh  # Generated hook wrappers (not templates)
.moai/cache/                   # Cache
.moai/logs/                    # Logs
.moai/memory/                  # Memory storage
```

### Embedded Template System

moai-adk-go uses Go's `go:embed` directive to bundle templates:

**Source Location**:
- `internal/template/templates/` - Edit here

**Embedded Files** (Auto-generated, DO NOT EDIT):
- `internal/template/embedded.go` - Auto-generated by `go generate`

**Build Process**:
```bash
# After editing templates, regenerate embedded files
make build

# Or manually
go generate ./internal/template/...
```

---

## 3. Code Standards

### Language: English Only

**Source Code (Go):**
- All code, comments, godoc in English
- Package names: lowercase, single word
- Exported names: PascalCase
- Private names: camelCase
- Constants: PascalCase or UPPER_SNAKE_CASE
- Commit messages: English (Conventional Commits)

**Configuration Files (English ONLY):**
- Command files (.claude/commands/**/*.md): English only
- Agent definitions (.claude/agents/**/*.md): English only
- Skill definitions (.claude/skills/**/*.md): English only
- Hook scripts (.claude/hooks/**/*.sh): English only
- CLAUDE.md: English only

**Why**: Command/agent/skill files are code, not user-facing content. They are read by Claude Code (English-based) and must be in English for consistent behavior.

**User-facing vs Internal:**
- User-facing: README, CHANGELOG, documentation (can be localized)
- Internal: Commands, agents, skills, hooks (MUST be English)

### Go-Specific Standards

**File Naming:**
- Go files: `snake_case.go` (e.g., `template_deployer.go`)
- Test files: `snake_case_test.go` (e.g., `settings_test.go`)

**Package Structure:**
```go
// Package doc comment (required for godoc)
// Package template provides template deployment and rendering...
package template

// Exported types have godoc comments
// Deployer extracts and deploys templates from an embedded filesystem...
type Deployer interface { ... }
```

**Error Handling:**
```go
// Always wrap errors with context
if err != nil {
    return fmt.Errorf("deploy templates: %w", err)
}

// Use error wrapping, not string concatenation
return fmt.Errorf("read %q: %w", path, err)  // GOOD
return fmt.Errorf("read " + path + ": " + err.Error())  // BAD
```

### Forbidden
```go
// WRONG - Korean comments
// init 초기화 함수
func init() { ... }

// CORRECT - English comments
// init initializes the CLI commands
func init() { ... }
```

---

## 4. Git Workflow

### Before Commit
- [ ] Code in English
- [ ] Tests passing (`go test ./...`)
- [ ] Linting passing (`golangci-lint run`)
- [ ] Templates regenerated (`make build`)

### Before Push
- [ ] Branch rebased
- [ ] Commits organized
- [ ] Commit messages follow format (Conventional Commits)

### Commit Message Format
```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

**Types:** feat, fix, docs, style, refactor, perf, test, chore, revert

**Examples:**
```
feat(template): add SessionEnd hook to settings.json generator
fix(cli): prevent race condition in hook execution
test(settings): add TestEnsureGlobalSettingsEnv test cases
```

---

## 5. Version Management

### Single Source of Truth

- [HARD] `go.mod` module version + git tags are the authoritative sources
- [HARD] `pkg/version/version.go` reads from git tags at build time

**Version Reference:**
- Authoritative Source: Git tags (e.g., `v1.0.0`)
- Runtime Access: `pkg/version/version.go` via `git describe`
- Config Display: `.moai/config/sections/system.yaml` (updated by release process)

### Build Version Injection

Version is injected at build time using ldflags:

```bash
# Build with version injection
go build -ldflags="-X github.com/modu-ai/moai-adk/pkg/version.Version=v1.0.0"

# Makefile handles this automatically
make build VERSION=1.0.0
```

### Files Requiring Version Sync

When releasing new version, update:

**Documentation Files:**
- README.md (Version line)
- README.ko.md (Version line)
- CHANGELOG.md (New version entry)

**Configuration Files:**
- .moai/config/sections/system.yaml (moai.version)
- internal/template/templates/.moai/config/config.yaml (moai.version)

### Release Process

1. Update CHANGELOG.md with new version entry
2. Create git tag: `git tag v1.0.0`
3. Push tag: `git push origin v1.0.0`
4. Build release binaries: `make release VERSION=1.0.0`

---

## 6. Testing Guidelines

### ⚠️ IMPORTANT: Prevent Accidental File Modifications

When running tests, **always check if they modify project files**.

### Test Execution
```bash
# Run all tests
go test ./...

# Run with race detection
go test -race ./...

# Run with coverage
go test -cover ./...

# Run specific test
go test -run TestEnsureGlobalSettingsEnv ./internal/cli/
```

### Test Isolation

**[HARD] All test temp directories MUST be created under `/tmp` and cleaned up automatically.**

Use `t.TempDir()` for all temporary directories. It creates dirs under `os.TempDir()` and registers automatic cleanup.

```go
func TestSomething(t *testing.T) {
    tempDir := t.TempDir()  // Auto-cleanup after test - ALWAYS use this
    // Work in tempDir instead of project root
}
```

**Why this matters - `filepath.Join` vs absolute paths:**

On macOS, `t.TempDir()` returns paths starting with `/var/folders/...`.
Go's `filepath.Join(cwd, absPath)` does NOT strip the leading `/` from the second arg:
```
filepath.Join("/a/b", "/var/folders/x") = "/a/b/var/folders/x"  // WRONG!
filepath.Abs("/var/folders/x") = "/var/folders/x"                // CORRECT
```

Always use `filepath.Abs()` when resolving user-supplied paths in CLI commands.
Never use `filepath.Join(cwd, userPath)` when `userPath` can be absolute.

**Root cause of `internal/cli/var/` pollution (fixed 2026-02-22):**
- `init.go` used `filepath.Join(cwd, args[0])` where `args[0]` was an absolute path
- This created `internal/cli/var/folders/.../TestRunInit_NonInteractive*/` directories
- Fixed by replacing `filepath.Join(cwd, targetDir)` with `filepath.Abs(targetDir)`

### Coverage Targets

- Package-level: 85% minimum coverage
- Critical packages (cli, template, hook): 90%+ coverage

### Table-Driven Tests (Go Convention)

```go
func TestBuildRequiredPATH(t *testing.T) {
    tests := []struct {
        name    string
        goBin   string
        goPath  string
        want    string
    }{
        {"default", "", "", wantDefault},
        {"custom bin", "/custom/bin", "", wantCustom},
        {"custom path", "", "/custom/path", wantPath},
    }
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Test implementation
        })
    }
}
```

---

## 7. Hook Development Guidelines

### [HARD] Shell Script Hooks Only

moai-adk-go uses shell scripts for hooks, NOT Python:

**Hook Wrapper Pattern:**
```bash
#!/bin/bash
# .claude/hooks/moai/handle-session-start.sh

# Read stdin JSON from Claude Code
INPUT=$(cat)

# Call moai binary with hook subcommand
moai hook session-start <<< "$INPUT"
```

**Why Shell Scripts:**
- Faster execution (no Python startup overhead)
- Always available (no dependency on uv/python)
- Cross-platform (bash, /bin/sh)

### Hook Command Format

**settings.json hook configuration:**
```json
{
  "hooks": {
    "SessionStart": [{
      "hooks": [{
        "command": "\"$CLAUDE_PROJECT_DIR/.claude/hooks/moai/handle-session-start.sh\"",
        "timeout": 5
      }]
    }]
  }
}
```

**Key Rules:**
- [HARD] Always quote `$CLAUDE_PROJECT_DIR`: `"$CLAUDE_PROJECT_DIR"`
- [HARD] Use full path to hook wrapper script
- [HARD] Set appropriate timeout (default: 5 seconds)

### Platform Differences

**macOS/Linux:**
```json
"command": "\"$CLAUDE_PROJECT_DIR/.claude/hooks/moai/hook.sh\""
```

**Windows:**
```json
"command": "\"%CLAUDE_PROJECT_DIR%\\.claude\\hooks\\moai\\hook.sh\""
```

---

## 8. Template Variable Strategy

### Template vs Local Settings

moai-adk-go uses different path variable strategies:

**Template settings** (`internal/template/templates/.claude/settings.json`):
- Uses: `{{.GoBinPath}}` template variable (Go template syntax)
- Purpose: Runtime rendering during `moai init`
- Cross-platform: Resolved by `template.TemplateContext`

**Local settings** (`~/.claude/settings.json`):
- Uses: `"$CLAUDE_PROJECT_DIR"` environment variable
- Purpose: Runtime path resolution by Claude Code
- Cross-platform: Automatically resolved by Claude Code

### Template Variables

Available in Go templates (`*.tmpl` files):

```go
type TemplateContext struct {
    GoBinPath string  // Path to Go bin directory
    HomeDir   string  // User home directory
}
```

**Usage in templates:**
```go
// .moai/status_line.sh.tmpl
export PATH="{{.GoBinPath}}:$PATH"
```

**Rendering:**
```go
ctx := template.NewTemplateContext(
    template.WithGoBinPath(detectGoBinPath()),
    template.WithHomeDir(homeDir),
)
deployer.Deploy(ctx, projectRoot, mgr, ctx)
```

---

## 9. Configuration System

### Config File Format

moai-adk-go uses YAML for configuration:

**Project config** (`.moai/config/config.yaml`):
- Main configuration file
- Contains sections for different settings

**Section files** (`.moai/config/sections/*.yaml`):
- `config.yaml` - Main config
- `quality.yaml` - Quality gates, development mode
- `language.yaml` - Language preferences
- `user.yaml` - User information
- `workflow.yaml` - Workflow settings

### Configuration Priority

1. Environment Variables: `MOAI_USER_NAME`, `MOAI_CONVERSATION_LANG`
2. User Configuration: `.moai/config/sections/*.yaml`
3. Template Defaults: From `internal/template/templates/.moai/config/`

---

## 10. Build and Development Commands

### Common Commands

```bash
# Build the project
make build

# Run tests
make test

# Run with race detection
make test-race

# Run linter
make lint

# Format code
make fmt

# Install locally
make install

# Clean build artifacts
make clean

# Run go fix modernizers (twice for synergistic fixes - added in Go 1.26 upgrade)
make fix
```

### Development Workflow

```bash
# 1. Edit templates
vim internal/template/templates/.claude/skills/moai/SKILL.md

# 2. Regenerate embedded files
make build

# 3. Run tests
go test ./internal/template/...

# 4. Test locally
./moai init test-project

# 5. Commit
git add internal/template/templates/
git commit -m "feat(template): update SKILL.md"
```

### Go 1.26 Modernization Notes

go.mod now targets Go 1.26 (upgraded 2026-02-20, commit `062d1e06`).

**`make fix` — go fix modernizers:**
- Run `make fix` after pulling major upstream changes to apply new modernizers
- Runs `go fix ./...` twice (synergistic: some fixes enable others)
- Key transformations: `interface{}` → `any`, range-over-int, `slices.Contains`
- Safe: go fix only applies verified, backward-compatible transformations

**Green Tea GC (active by default in Go 1.26):**
- 10–40% reduction in GC overhead — no code changes required
- Particularly beneficial for CLI tools with bursty allocation patterns
- Automatically active in all built binaries

**Goroutine leak profiler (experimental):**
- Available via `GOEXPERIMENT=goroutineleakprofile`
- Profile name: `goroutineleak`
- Useful for diagnosing goroutine leaks in long-running processes

**`go tool doc` → `go doc` (cmd/doc removed):**
- `cmd/doc` and `go tool doc` are removed in Go 1.26
- Use `go doc` directly (unchanged)

---

## 11. Directory Structure

```
moai-adk-go/
├── cmd/                        # Main application entry points
│   └── moai/                   # CLI command
│       └── main.go             # Entry point
├── internal/                   # Private application code
│   ├── cli/                    # CLI commands
│   │   ├── init.go             # moai init command
│   │   ├── update.go           # moai update command
│   │   └── ...
│   ├── core/                   # Core business logic
│   │   └── project/            # Project management
│   ├── foundation/             # Foundation utilities
│   ├── hook/                   # Hook system
│   ├── manifest/               # Template manifest
│   ├── merge/                  # 3-way merge
│   ├── template/               # Template system
│   │   ├── templates/          # SOURCE: Edit templates here ⭐
│   │   │   ├── .claude/        # Claude Code config templates
│   │   │   │   ├── agents/     # Agent definitions
│   │   │   │   ├── commands/   # Slash commands
│   │   │   │   ├── hooks/      # Hook scripts
│   │   │   │   ├── output-styles/ # Output styles
│   │   │   │   ├── rules/      # Rules
│   │   │   │   └── skills/     # Skill definitions
│   │   │   ├── .moai/          # MoAI config templates
│   │   │   │   └── config/     # Config templates
│   │   │   ├── CLAUDE.md       # Main execution directives
│   │   │   └── *.tmpl          # Template files
│   │   ├── deployer.go         # Template deployment
│   │   ├── renderer.go         # Template rendering
│   │   ├── settings.go         # settings.json generation
│   │   └── embedded.go         # Generated: DO NOT EDIT
│   └── ...
├── pkg/                        # Public libraries
│   ├── models/                 # Data models
│   └── version/                # Version info
├── .claude/                    # Local Claude Code config (NOT in template)
├── .moai/                      # Local MoAI state (NOT in template)
├── CLAUDE.md                   # Synced from templates
├── CLAUDE.local.md             # This file (local only)
├── go.mod                      # Go module definition
├── go.sum                      # Go module checksums
├── Makefile                    # Build commands
└── README.md                   # Project documentation
```

---

## 12. Frequent Issues and Solutions

### Issue: Templates not updated after editing

**Solution:**
```bash
# Regenerate embedded files
make build

# Verify
ls -la internal/template/embedded.go
```

### Issue: Tests modify ~/.claude/settings.json

**Solution:** Tests should use `t.TempDir()` for isolation. Check if test creates files in project root.

### Issue: Hook timeout

**Solution:** Increase timeout in settings.json:
```json
{"timeout": 60}  # 60 seconds instead of default 5
```

---

## 13. Important Notes

- `/Users/goos/MoAI/moai-adk-go/.claude/` is for local development only
- Template changes require `make build` to regenerate embedded files
- `.moai/project/` and `.moai/specs/` are protected from deletion
- All code must be in English (comments, godoc, variables)
- Use `golangci-lint` for linting before commits
- Run `go test -race ./...` to detect race conditions

---

## 14. Reference

- CLAUDE.md: Alfred execution directives
- README.md: Project overview
- Skill("moai-foundation-core"): Execution rules
- Skill("moai-foundation-claude"): Plugin development, sandboxing
- Go Code Review Comments: https://github.com/golang/go/wiki/CodeReviewComments
- Effective Go: https://go.dev/doc/effective_go

---

## 15. Multi-Model Architecture (Claude Code 2.1.50+)

### [CRITICAL] Model Distribution vs Hybrid Mode

**절대 헷갈리지 말 것:** 세 가지 개념이 완전히 다릅니다.

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Model Policy (moai init --model-policy / update -c)         │
│  ├── Values: high, medium, low                                  │
│  ├── Action: CLI이 각 에이전트 정의를 개별적으로 수정             │
│  ├── high  → 에이전트별 opus/sonnet/haiku 배정 (상세 매핑 참조)   │
│  ├── medium → 에이전트별 opus/sonnet/haiku 배정                  │
│  └── low   → 에이전트별 sonnet/haiku 배정 (opus 없음)            │
├─────────────────────────────────────────────────────────────────┤
│  2. Model Field (Agent Definition)                              │
│  ├── Values: inherit, opus, sonnet, haiku                       │
│  ├── Purpose: Claude Code 모델 선택                             │
│  └── Set by: moai init/update -c 또는 수동 편집                 │
├─────────────────────────────────────────────────────────────────┤
│  3. CG Mode (CLI Command)                                       │
│  ├── Commands: moai cg, moai glm, moai cc                       │
│  ├── Mechanism: tmux pane-level environment isolation            │
│  └── Purpose: Claude Leader + GLM Teammates cost optimization   │
└─────────────────────────────────────────────────────────────────┘
```

### Model Policy (moai init --model-policy)

**소스 코드:** `internal/template/model_policy.go`

```bash
# Model policy 설정으로 각 에이전트 정의를 개별 수정
moai init --model-policy high      # 에이전트별 매핑에 따라 opus/sonnet/haiku 배정
moai init --model-policy medium    # 에이전트별 매핑에 따라 opus/sonnet/haiku 배정 (기본값)
moai init --model-policy low       # 에이전트별 매핑에 따라 sonnet/haiku 배정

# 기존 프로젝트 업데이트
moai update -c --model-policy high
```

**에이전트별 모델 배정 매핑 (model_policy.go):**

```go
// Key: agent name, Value: [high_model, medium_model, low_model]
var agentModelMap = map[string][3]string{
    // Manager Agents
    "manager-spec":     {"opus", "opus", "sonnet"},   // 중요: 항상 고품질
    "manager-ddd":      {"opus", "sonnet", "sonnet"},
    "manager-tdd":      {"opus", "sonnet", "sonnet"},
    "manager-docs":     {"sonnet", "haiku", "haiku"}, // 문서는 경량 모델로 충분
    "manager-quality":  {"haiku", "haiku", "haiku"},  // 품질 체크는 haiku로 충분
    "manager-project":  {"opus", "sonnet", "haiku"},
    "manager-strategy": {"opus", "opus", "sonnet"},   // 전략은 항상 고품질
    "manager-git":      {"haiku", "haiku", "haiku"},  // Git 작업은 haiku로 충분
    // Expert Agents
    "expert-backend":   {"opus", "sonnet", "sonnet"},
    "expert-frontend":  {"opus", "sonnet", "sonnet"},
    "expert-security":  {"opus", "opus", "sonnet"},   // 보안은 항상 고품질
    // ... (전체 목록은 model_policy.go 참조)
}
```

**핵심 포인트:**
- "모든 에이전트에 opus 배정"이 **아님**
- 각 에이전트는 역할에 따라 다른 모델 배정
- `manager-quality`, `manager-git`, `team-researcher`, `team-quality` → 모든 정책에서 haiku
- `manager-spec`, `manager-strategy`, `expert-security` → high/medium에서 opus 유지

### Model Field Values (Agent Definition)

| Value | Meaning | Set By |
|-------|---------|--------|
| `inherit` | 부모 세션 모델 상속 | 기본값 (수동 편집) |
| `opus` | Claude Opus 4.6 | `moai init --model-policy high` (일부 에이전트) |
| `sonnet` | Claude Sonnet 4.6 | `moai init --model-policy medium` (일부 에이전트) |
| `haiku` | Claude Haiku | `moai init --model-policy low` (일부 에이전트) |

**NEVER use these values in model field:**
- ❌ `glm` - GLM은 model field 값이 아님 (Hybrid mode로 접근)
- ❌ `high`, `medium`, `low` - 이것은 moai init 플래그이지 model 값이 아님

### GLM Configuration (Z.AI 공식 문서 기반)

**참조 문서:** https://docs.z.ai/devpack/tool/claude

GLM은 `~/.claude/settings.json`의 환경 변수 오버라이드로 설정됩니다:

```json
{
  "env": {
    "ANTHROPIC_DEFAULT_HAIKU_MODEL": "glm-4.7-air",
    "ANTHROPIC_DEFAULT_SONNET_MODEL": "glm-4.7",
    "ANTHROPIC_DEFAULT_OPUS_MODEL": "glm-5"
  }
}
```

### Mode Selection (moai CLI Commands)

| Command | Settings.json Env | Result |
|---------|-------------------|--------|
| `moai cc` | No GLM env vars | Claude-only (opus/sonnet/haiku) |
| `moai glm` | All GLM env vars | GLM-only (glm-4.7-air/glm-4.7/glm-5) |
| `moai cg` | tmux session env + GLM env for teammates | Claude Leader + GLM Teammates |

**CG Mode 작동 방식:**
1. `moai glm <api-key>` 실행 (API 키 저장, 최초 1회)
2. `moai cg` 실행
3. 리더 세션은 Claude 유지 (GLM env 자동 제거)
4. 팀원은 tmux 새 pane에서 GLM env 상속하여 실행

```bash
# Claude-only mode (default)
moai cc                    # settings.json에 GLM env 없음
/moai run SPEC-XXX         # 모든 작업 Claude로 실행

# GLM-only mode
moai glm                   # settings.json에 모든 GLM env 설정
/moai run SPEC-XXX         # 모든 작업 GLM으로 실행

# CG mode (Claude Leader + GLM Workers)
moai glm sk-xxx            # API 키 저장 (최초 1회)
moai cg                    # tmux env 격리 (자동 GLM 리셋 포함)
/moai run SPEC-XXX         # Leader: Claude, Workers: GLM
```

### Correct Agent Definition Pattern

```yaml
# .claude/agents/moai/team-backend-dev.md
---
name: team-backend-dev
description: Backend implementation specialist
model: inherit              # CORRECT: Uses user's default or GLM (if CG/GLM mode)
isolation: worktree         # Claude Code 2.1.50: worktree isolation
background: true            # Claude Code 2.1.50: parallel execution
permissionMode: acceptEdits
skills:
  - moai-domain-backend
  - moai-lang-go
---

# .claude/agents/moai/team-architect.md
---
name: team-architect
description: Technical architecture specialist
model: opus                 # CORRECT: Always opus for architecture (set by model_policy.go)
# model: inherit           # ALSO OK: Inherit from user's choice
isolation: none             # Read-only, no worktree needed
---
```

### Incorrect Patterns (DO NOT USE)

```yaml
# WRONG - GLM is NOT a model field value
model: glm                  # ❌ NEVER do this

# WRONG - Fixed to opus when user wants flexibility
model: opus                 # ❌ Use "high" or "inherit"

# WRONG - Fixed model prevents CG mode flexibility
model: sonnet               # ❌ Use "medium" or "inherit"
```

### Worktree Integration

Agent worktrees use Claude Code's native `claude -w`:

```
┌─────────────────────────────────────────────────────────────────┐
│  SPEC Worktree (Persistent)                                     │
│  ├── Path: .moai/worktrees/{ProjectName}/{SPEC-ID}/             │
│  ├── Purpose: Multi-session SPEC development                    │
│  └── CLI: moai worktree new SPEC-XXX                            │
├─────────────────────────────────────────────────────────────────┤
│  Agent Worktree (Ephemeral)                                     │
│  ├── Path: .claude/worktrees/<name>/                            │
│  ├── Purpose: Subagent isolation during execution               │
│  ├── Mechanism: claude -w (Claude Code native)                  │
│  └── Config: isolation: worktree in agent definition            │
└─────────────────────────────────────────────────────────────────┘
```

### Mode Selection Matrix

| Command | Leader Model | Worker Model | Use Case |
|---------|--------------|--------------|----------|
| `moai cc` | Claude (user choice) | Claude (per agent def) | Complex work, high quality |
| `moai glm` | GLM | GLM | Cost optimization, simple tasks |
| `moai cg` | Claude (user choice) | GLM (via worktree env) | Best balance: quality + cost |

### Configuration Schema

**workflow.yaml:**
```yaml
workflow:
  team:
    enabled: true
    models:
      # Default model for teammates (inherit = user's choice)
      default: "inherit"

      # Per-role model preference (high/medium/low only)
      # These are hints, actual model depends on user's base choice
      role_preferences:
        architect: "high"      # Prefers opus for complex design
        analyst: "high"        # Prefers opus for deep analysis
        backend-dev: "medium"  # Prefers sonnet for implementation
        frontend-dev: "medium" # Prefers sonnet for implementation
        tester: "low"          # Prefers haiku for simple tests
        researcher: "low"      # Prefers haiku for exploration
```

**llm.yaml:**
```yaml
llm:
  # Mode selection via CLI: moai cc, moai glm, moai cg
  mode: ""  # Set by CLI command, not config file

  # Model tier mapping
  tiers:
    high: "opus"
    medium: "sonnet"
    low: "haiku"
```

### Key Rules Summary

1. **Model field**: Use `inherit`, `high`, `medium`, `low` only
2. **GLM access**: Via `moai glm` or `moai cg` CLI, NOT model field
3. **CG mode**: Claude Leader + GLM Teammates (tmux pane-level env isolation)
4. **Worktree isolation**: `isolation: worktree` in agent definition (Claude Code native)
5. **tmux**: Required for CG mode (pane-level env isolation for API separation)

---

## 16. Claude Code 2.1.50 Worktree Integration

### Two Distinct Worktree Systems

MoAI-ADK uses two complementary worktree systems:

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Claude Code Native Worktree                                  │
│  ├── Path: .claude/worktrees/<name>/                            │
│  ├── User CLI: claude --worktree / claude -w                    │
│  ├── Agent: isolation: worktree in frontmatter                  │
│  ├── Lifetime: Ephemeral (auto-cleanup on session end)          │
│  └── Hooks: WorktreeCreate / WorktreeRemove events              │
├─────────────────────────────────────────────────────────────────┤
│  2. MoAI Worktree                                               │
│  ├── Path: .moai/worktrees/{Project}/{SPEC}/                    │
│  ├── CLI: moai worktree new/list/remove                         │
│  ├── Lifetime: Persistent (SPEC-scoped)                         │
│  └── Purpose: Multi-session SPEC development, PRs               │
└─────────────────────────────────────────────────────────────────┘
```

### `claude --worktree` and `--tmux` Flags

```bash
# Start isolated session
claude --worktree            # Creates .claude/worktrees/<auto-name>/
claude -w                    # Short form

# With tmux for split-pane (requires tmux or iTerm2)
claude --worktree --tmux

# NOT supported in: VS Code integrated terminal, Windows Terminal, Ghostty
```

**Who uses it**: USERS (not agents/subagents internally)

### `isolation: worktree` in Agent Frontmatter (v2.1.49+)

**Who uses it**: AGENTS (implementation teammates)

```yaml
# Implementation agents get isolation + background
name: team-backend-dev
isolation: worktree   # Own isolated worktree per agent
background: true      # Non-blocking parallel execution

# Research/analysis agents do NOT need isolation
name: team-researcher
# No isolation needed (permissionMode: plan already prevents writes)
permissionMode: plan
```

**Current agent status**:

| Agent | isolation | background | Reason |
|-------|-----------|------------|--------|
| team-backend-dev | worktree | true | Writes server-side files |
| team-frontend-dev | worktree | true | Writes client-side files |
| team-tester | worktree | true | Writes test files |
| team-designer | worktree | true | Writes design files |
| team-researcher | none | false | Read-only (plan mode) |
| team-analyst | none | false | Read-only (plan mode) |
| team-architect | none | false | Read-only (plan mode) |
| team-quality | none | false | Read-only (plan mode) |

### WorktreeCreate/Remove Go Handlers

Implemented in `internal/hook/`:
- `worktree_create.go` → `moai hook worktree-create`
- `worktree_remove.go` → `moai hook worktree-remove`

Registered in `internal/cli/deps.go` and `internal/cli/hook.go`.

Shell wrappers in `.claude/hooks/moai/`:
- `handle-worktree-create.sh` → Calls `moai hook worktree-create`
- `handle-worktree-remove.sh` → Calls `moai hook worktree-remove`

### Development Checklist for Worktree Features

When adding isolation to new agents:
- [ ] Add `isolation: worktree` to agent frontmatter in templates
- [ ] Add `background: true` if parallel execution is needed
- [ ] Verify agent's tasks don't have sequential dependencies
- [ ] Check file ownership patterns don't overlap with other agents

---

**Status**: Active (Local Development)
**Version**: 1.3.0 (Worktree Integration section added)
**Last Updated**: 2026-02-21
