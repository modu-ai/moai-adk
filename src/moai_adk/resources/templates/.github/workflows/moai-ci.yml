name: MoAI-ADK CI/CD Pipeline

# MoAI Constitution 5ì›ì¹™ì„ ìë™ìœ¼ë¡œ ê²€ì¦í•˜ëŠ” CI/CD íŒŒì´í”„ë¼ì¸
# Simplicity, Architecture, Testing, Observability, Versioning ì¤€ìˆ˜

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

env:
  # MoAI Constitution í™˜ê²½ ë³€ìˆ˜
  MOAI_CONSTITUTION_CHECK: true
  MOAI_MIN_COVERAGE: 80
  MOAI_MAX_PROJECTS: 3

jobs:
  # Constitution Check: Simplicity ì›ì¹™ ê²€ì¦
  constitution-check:
    name: ğŸ›ï¸ Constitution 5ì›ì¹™ ê²€ì¦
    runs-on: ubuntu-latest
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: MoAI ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        run: |
          if [ -f ".moai/scripts/check_constitution.py" ]; then
            python .moai/scripts/check_constitution.py
          else
            echo "âš ï¸ Constitution ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: claude-code-manager ì—ì´ì „íŠ¸ ê²€ì¦
        run: |
          if [ -f ".claude/agents/moai/claude-code-manager.md" ]; then
            echo "âœ… claude-code-manager ì—ì´ì „íŠ¸ í™•ì¸ë¨"
          else
            echo "âŒ claude-code-manager ì—ì´ì „íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

  # Tag System: 16-Core TAG ë¬´ê²°ì„± ê²€ì¦
  tag-validation:
    name: ğŸ·ï¸ 16-Core TAG ì‹œìŠ¤í…œ ê²€ì¦
    runs-on: ubuntu-latest
    needs: constitution-check
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: TAG ë¬´ê²°ì„± ê²€ì‚¬
        run: |
          if [ -f ".moai/scripts/validate_tags.py" ]; then
            python .moai/scripts/validate_tags.py
          else
            echo "âš ï¸ TAG ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: MCP ì„œë²„ ì„¤ì • ê²€ì¦
        run: |
          if [ -f ".moai/config.json" ]; then
            # MCP ì„œë²„ ì„¤ì • ì¡´ì¬ í™•ì¸
            if grep -q "mcp_servers" .moai/config.json; then
              echo "âœ… MCP ì„œë²„ ì„¤ì • í™•ì¸ë¨"
            else
              echo "âš ï¸ MCP ì„œë²„ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤"
            fi
            # í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸
            if grep -q "environment_variables" .moai/config.json; then
              echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸ë¨"
            else
              echo "âš ï¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤"
            fi
          else
            echo "âŒ MoAI config.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

  # Language-specific jobs (ë™ì ìœ¼ë¡œ ê°ì§€)
  detect-project-type:
    name: ğŸ“‹ í”„ë¡œì íŠ¸ íƒ€ì… ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      has_python: ${{ steps.detect.outputs.has_python }}
      has_node: ${{ steps.detect.outputs.has_node }}
      has_rust: ${{ steps.detect.outputs.has_rust }}
      has_go: ${{ steps.detect.outputs.has_go }}
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
      
      - name: í”„ë¡œì íŠ¸ íƒ€ì… ê°ì§€
        id: detect
        run: |
          echo "has_python=$([[ -f 'pyproject.toml' || -f 'requirements.txt' || -f 'setup.py' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_node=$([[ -f 'package.json' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_rust=$([[ -f 'Cargo.toml' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "has_go=$([[ -f 'go.mod' ]] && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

  # Python í”„ë¡œì íŠ¸ í…ŒìŠ¤íŠ¸
  python-tests:
    name: ğŸ Python í…ŒìŠ¤íŠ¸ (TDD ì›ì¹™)
    runs-on: ubuntu-latest
    needs: [detect-project-type, tag-validation]
    if: needs.detect-project-type.outputs.has_python == 'true'
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Python ${{ matrix.python-version }} ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          if [ -f "pyproject.toml" ]; then
            pip install -e .[dev]
          fi
          # í…ŒìŠ¤íŠ¸ ë„êµ¬ ì„¤ì¹˜
          pip install pytest pytest-cov black ruff mypy

      - name: ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)
        run: |
          if command -v black &> /dev/null; then
            black --check .
          fi

      - name: ë¦°í„° ê²€ì‚¬ (Ruff)
        run: |
          if command -v ruff &> /dev/null; then
            ruff check .
          fi

      - name: íƒ€ì… ì²´í‚¹ (MyPy)
        run: |
          if command -v mypy &> /dev/null && [ -f "pyproject.toml" ]; then
            mypy .
          fi

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ (Constitution: 80% ì´ìƒ)
        run: |
          if command -v pytest &> /dev/null; then
            pytest --cov=. --cov-report=xml --cov-fail-under=${{ env.MOAI_MIN_COVERAGE }}
          else
            echo "âš ï¸ pytestë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
            python -m unittest discover
          fi

      - name: ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        if: matrix.python-version == '3.9'
        with:
          file: ./coverage.xml

  # Node.js í”„ë¡œì íŠ¸ í…ŒìŠ¤íŠ¸
  node-tests:
    name: ğŸ“¦ Node.js í…ŒìŠ¤íŠ¸ (TDD ì›ì¹™)
    runs-on: ubuntu-latest
    needs: [detect-project-type, tag-validation]
    if: needs.detect-project-type.outputs.has_node == 'true'
    strategy:
      matrix:
        node-version: ['18', '20', 'latest']
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ${{ matrix.node-version }} ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¦°í„° ê²€ì‚¬ (ESLint)
        run: |
          if npm list eslint --depth=0 &> /dev/null; then
            npm run lint
          fi

      - name: íƒ€ì… ì²´í‚¹ (TypeScript)
        run: |
          if npm list typescript --depth=0 &> /dev/null; then
            npm run type-check || npx tsc --noEmit
          fi

      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€
        run: |
          npm test
          if npm list jest --depth=0 &> /dev/null; then
            npm run test:coverage
          fi

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    name: ğŸ”’ ë³´ì•ˆ ìŠ¤ìº” (Constitution: Observability)
    runs-on: ubuntu-latest
    needs: tag-validation
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ì‹œí¬ë¦¿ ìŠ¤ìº”
        run: |
          if [ -f ".moai/scripts/check-secrets.py" ]; then
            python .moai/scripts/check-secrets.py
          else
            echo "âš ï¸ ì‹œí¬ë¦¿ ìŠ¤ìº” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ë¼ì´ì„ ìŠ¤ ê²€ì‚¬
        run: |
          if [ -f ".moai/scripts/check-licenses.py" ]; then
            python .moai/scripts/check-licenses.py
          else
            echo "âš ï¸ ë¼ì´ì„ ìŠ¤ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ì·¨ì•½ì  ìŠ¤ìº” (Node.js)
        if: needs.detect-project-type.outputs.has_node == 'true'
        run: |
          if [ -f "package.json" ]; then
            npm audit --audit-level moderate
          fi

      - name: ì·¨ì•½ì  ìŠ¤ìº” (Python)
        if: needs.detect-project-type.outputs.has_python == 'true'
        run: |
          pip install safety
          safety check

  # ë¹Œë“œ ë° ë°°í¬ ì¤€ë¹„
  build-and-package:
    name: ğŸš€ ë¹Œë“œ ë° íŒ¨í‚¤ì§•
    runs-on: ubuntu-latest
    needs: [python-tests, node-tests, security-scan]
    if: always() && (needs.python-tests.result == 'success' || needs.python-tests.result == 'skipped') && (needs.node-tests.result == 'success' || needs.node-tests.result == 'skipped') && needs.security-scan.result == 'success'
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: í”„ë¡œì íŠ¸ ë¹Œë“œ
        run: |
          if [ -f "pyproject.toml" ]; then
            pip install build
            python -m build
          elif [ -f "package.json" ]; then
            npm ci
            npm run build
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: |
            dist/
            build/
            *.tgz
            *.whl

  # í†µí•© ë¦¬í¬íŠ¸
  integration-report:
    name: ğŸ“Š MoAI í†µí•© ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [constitution-check, tag-validation, python-tests, node-tests, security-scan, build-and-package]
    if: always()
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: MoAI í†µí•© ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "# ğŸ›ï¸ MoAI Constitution ê²€ì¦ ë¦¬í¬íŠ¸" > moai-report.md
          echo "" >> moai-report.md
          echo "## ğŸ“‹ ê²€ì¦ ê²°ê³¼" >> moai-report.md
          echo "- Constitution Check: ${{ needs.constitution-check.result }}" >> moai-report.md
          echo "- TAG ì‹œìŠ¤í…œ: ${{ needs.tag-validation.result }}" >> moai-report.md
          echo "- Python í…ŒìŠ¤íŠ¸: ${{ needs.python-tests.result }}" >> moai-report.md
          echo "- Node.js í…ŒìŠ¤íŠ¸: ${{ needs.node-tests.result }}" >> moai-report.md
          echo "- ë³´ì•ˆ ìŠ¤ìº”: ${{ needs.security-scan.result }}" >> moai-report.md
          echo "- ë¹Œë“œ: ${{ needs.build-and-package.result }}" >> moai-report.md
          echo "" >> moai-report.md
          echo "## ğŸ¯ Constitution 5ì›ì¹™ ì¤€ìˆ˜ í˜„í™©" >> moai-report.md
          echo "1. âœ… Simplicity: í”„ë¡œì íŠ¸ ë³µì¡ë„ ì œí•œ" >> moai-report.md
          echo "2. âœ… Architecture: í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìš°ì„  ì‚¬ìš©" >> moai-report.md
          echo "3. âœ… Testing: TDD ë° ${{ env.MOAI_MIN_COVERAGE }}% ì»¤ë²„ë¦¬ì§€" >> moai-report.md
          echo "4. âœ… Observability: êµ¬ì¡°í™”ëœ ë¡œê¹… ë° ë©”íŠ¸ë¦­" >> moai-report.md
          echo "5. âœ… Versioning: MAJOR.MINOR.PATCH ì‹œë§¨í‹± ë²„ì „" >> moai-report.md

      - name: ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: moai-report
          path: moai-report.md

# ì•Œë¦¼ ì„¤ì • (ì‹¤íŒ¨ì‹œ ìŠ¬ë™/ì´ë©”ì¼ ì•Œë¦¼)
  notification:
    name: ğŸ“¢ ì•Œë¦¼ ë°œì†¡
    runs-on: ubuntu-latest
    needs: [integration-report]
    if: failure()
    steps:
      - name: ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "ğŸš¨ MoAI-ADK CI/CD íŒŒì´í”„ë¼ì¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo "Constitution 5ì›ì¹™ ì¤‘ í•˜ë‚˜ ì´ìƒì´ ìœ„ë°˜ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤."
          # ì—¬ê¸°ì— ìŠ¬ë™ì´ë‚˜ ì´ë©”ì¼ ì•Œë¦¼ ë¡œì§ ì¶”ê°€