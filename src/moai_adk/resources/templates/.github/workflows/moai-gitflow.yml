name: MoAI-ADK GitFlow CI/CD Pipeline

# MoAI-ADK 0.2.1 GitFlow í†µí•© íŒŒì´í”„ë¼ì¸
# Feature ë¸Œëœì¹˜, develop, main ë¸Œëœì¹˜ì—ì„œ ìë™ ì‹¤í–‰

on:
  push:
    branches:
      - main
      - develop
      - 'feature/SPEC-*'
      - 'release/*'
      - 'hotfix/*'
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened, ready_for_review]

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # =============================================================================
  # í’ˆì§ˆ ê²€ì¦ Job (ëª¨ë“  ë¸Œëœì¹˜)
  # =============================================================================
  quality-check:
    name: ğŸ“‹ í’ˆì§ˆ ê²€ì¦
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.ref != 'refs/heads/main'

    outputs:
      spec-id: ${{ steps.extract-spec.outputs.spec-id }}
      is-spec-branch: ${{ steps.extract-spec.outputs.is-spec-branch }}
      is-build-stage: ${{ steps.check-stage.outputs.is-build-stage }}

    steps:
      - name: ğŸ” ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ SPEC ID ì¶”ì¶œ
        id: extract-spec
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch: $BRANCH_NAME"

          if [[ $BRANCH_NAME =~ ^feature/SPEC-([0-9]+) ]]; then
            SPEC_ID="SPEC-${BASH_REMATCH[1]}"
            echo "spec-id=$SPEC_ID" >> $GITHUB_OUTPUT
            echo "is-spec-branch=true" >> $GITHUB_OUTPUT
            echo "ğŸ¯ SPEC ID ê°ì§€: $SPEC_ID"
          else
            echo "is-spec-branch=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ ì¼ë°˜ ë¸Œëœì¹˜: $BRANCH_NAME"
          fi

      - name: ğŸ” ì‘ì—… ë‹¨ê³„ í™•ì¸
        id: check-stage
        run: |
          # ìµœê·¼ ì»¤ë°‹ ë©”ì‹œì§€ë¡œ ë‹¨ê³„ íŒë‹¨
          RECENT_COMMIT=$(git log -1 --pretty=format:"%s")
          echo "Recent commit: $RECENT_COMMIT"

          if [[ $RECENT_COMMIT =~ ^(test\(|feat\(.*\):.*(GREEN|RED|REFACTOR)) ]]; then
            echo "is-build-stage=true" >> $GITHUB_OUTPUT
            echo "ğŸ”¨ BUILD ë‹¨ê³„ ê°ì§€"
          else
            echo "is-build-stage=false" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ SPEC ë‹¨ê³„ ë˜ëŠ” ê¸°íƒ€"
          fi

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Ruff)
        run: |
          echo "ğŸ§¹ Ruff ë¦°íŒ… ì‹¤í–‰..."
          ruff check . --output-format=github
          echo "âœ¨ Ruff í¬ë§·íŒ… ê²€ì‚¬..."
          ruff format --check .

      - name: ğŸ” íƒ€ì… ê²€ì‚¬ (MyPy)
        run: |
          echo "ğŸ¯ MyPy íƒ€ì… ê²€ì‚¬ ì‹¤í–‰..."
          mypy src/ --ignore-missing-imports || true

      - name: ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)
        run: |
          echo "ğŸ›¡ï¸ Bandit ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰..."
          bandit -r src/ -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            echo "ğŸ“Š ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼:"
            cat bandit-report.json | jq '.results | length' || echo "0"
          fi

      - name: ğŸ“‹ SPEC ë¬¸ì„œ ê²€ì¦ (SPEC ë¸Œëœì¹˜ë§Œ)
        if: steps.extract-spec.outputs.is-spec-branch == 'true'
        run: |
          SPEC_ID="${{ steps.extract-spec.outputs.spec-id }}"
          SPEC_DIR=".moai/specs/$SPEC_ID"

          echo "ğŸ¯ SPEC ë¬¸ì„œ ê²€ì¦: $SPEC_ID"

          # í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸
          MISSING_FILES=()
          for file in "spec.md" "user-stories.md" "acceptance.md"; do
            if [ ! -f "$SPEC_DIR/$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "âŒ ëˆ„ë½ëœ SPEC íŒŒì¼: ${MISSING_FILES[*]}"
            exit 1
          fi

          # EARS í‚¤ì›Œë“œ ê²€ì¦
          EARS_COUNT=$(grep -c -E "(WHEN|IF|WHILE|WHERE|UBIQUITOUS)" "$SPEC_DIR/spec.md" || echo "0")
          if [ $EARS_COUNT -lt 3 ]; then
            echo "âš ï¸ EARS í‚¤ì›Œë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤ (ìµœì†Œ 3ê°œ í•„ìš”, í˜„ì¬ $EARS_COUNTê°œ)"
          fi

          # User Stories ê°œìˆ˜ í™•ì¸
          US_COUNT=$(grep -c "^US-" "$SPEC_DIR/user-stories.md" || echo "0")
          if [ $US_COUNT -lt 1 ]; then
            echo "âŒ User Storiesê°€ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi

          echo "âœ… SPEC ê²€ì¦ ì™„ë£Œ: EARS($EARS_COUNT), US($US_COUNT)"

  # =============================================================================
  # í…ŒìŠ¤íŠ¸ Job (BUILD ë‹¨ê³„)
  # =============================================================================
  test-suite:
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
    runs-on: ubuntu-latest
    needs: quality-check
    if: needs.quality-check.outputs.is-build-stage == 'true'

    steps:
      - name: ğŸ” ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ë° ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ğŸ“¦ í…ŒìŠ¤íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-mock coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f pyproject.toml ]; then pip install -e .; fi

      - name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ”¬ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term-missing

      - name: ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        if: always()
        run: |
          echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          pytest tests/integration/ -v --tb=short || true

      - name: ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ê²€ì¦
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; print(round(float(ET.parse('coverage.xml').getroot().get('line-rate')) * 100, 2))" || echo "0")
          echo "ğŸ“Š í˜„ì¬ ì»¤ë²„ë¦¬ì§€: $COVERAGE%"

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ ì»¤ë²„ë¦¬ì§€ê°€ 80% ë¯¸ë§Œì…ë‹ˆë‹¤ (í˜„ì¬: $COVERAGE%)"
            echo "::warning::í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ëª©í‘œì¹˜(80%)ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤"
          else
            echo "âœ… ì»¤ë²„ë¦¬ì§€ ëª©í‘œ ë‹¬ì„±: $COVERAGE%"
          fi

  # =============================================================================
  # Constitution ê²€ì¦ Job
  # =============================================================================
  constitution-check:
    name: ğŸ›ï¸ Constitution ê²€ì¦
    runs-on: ubuntu-latest
    needs: quality-check
    if: needs.quality-check.outputs.is-spec-branch == 'true'

    steps:
      - name: ğŸ” ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ›ï¸ Constitution 5ì›ì¹™ ê²€ì¦
        run: |
          SPEC_ID="${{ needs.quality-check.outputs.spec-id }}"
          echo "ğŸ¯ Constitution ê²€ì¦: $SPEC_ID"

          # 1. Simplicity - íŒŒì¼ ê°œìˆ˜ ì œí•œ (ì˜ˆ: 10ê°œ ì´í•˜)
          FILE_COUNT=$(find .moai/specs/$SPEC_ID -name "*.md" | wc -l)
          if [ $FILE_COUNT -gt 10 ]; then
            echo "âŒ Simplicity ìœ„ë°˜: íŒŒì¼ ê°œìˆ˜ ì´ˆê³¼ ($FILE_COUNT/10)"
            exit 1
          fi
          echo "âœ… Simplicity: íŒŒì¼ ê°œìˆ˜ ì ì ˆ ($FILE_COUNT/10)"

          # 2. Architecture - ëª¨ë“ˆí˜• êµ¬ì¡° í™•ì¸
          if [ -f ".moai/specs/$SPEC_ID/spec.md" ]; then
            MODULE_COUNT=$(grep -c -i "module\|component\|service" ".moai/specs/$SPEC_ID/spec.md" || echo "0")
            if [ $MODULE_COUNT -gt 0 ]; then
              echo "âœ… Architecture: ëª¨ë“ˆí˜• ì„¤ê³„ í™•ì¸ ($MODULE_COUNTê°œ)"
            else
              echo "âš ï¸ Architecture: ëª¨ë“ˆí˜• ì„¤ê³„ ê¶Œì¥"
            fi
          fi

          # 3. Testing - í…ŒìŠ¤íŠ¸ ê´€ë ¨ ì–¸ê¸‰ í™•ì¸
          TEST_MENTIONS=$(grep -c -i "test\|spec\|scenario" ".moai/specs/$SPEC_ID/" -r || echo "0")
          if [ $TEST_MENTIONS -lt 5 ]; then
            echo "âš ï¸ Testing: í…ŒìŠ¤íŠ¸ ê´€ë ¨ ë‚´ìš© ë¶€ì¡± ($TEST_MENTIONSê°œ)"
          else
            echo "âœ… Testing: í…ŒìŠ¤íŠ¸ ê³„íš ì ì ˆ ($TEST_MENTIONSê°œ)"
          fi

          # 4. Observability - ë¡œê¹…/ëª¨ë‹ˆí„°ë§ ì–¸ê¸‰
          OBS_COUNT=$(grep -c -i "log\|monitor\|metric\|trace" ".moai/specs/$SPEC_ID/" -r || echo "0")
          echo "âœ… Observability: ê´€ì°°ê°€ëŠ¥ì„± ê³ ë ¤ ($OBS_COUNTê°œ)"

          # 5. Versioning - ë²„ì „ ê´€ë¦¬ ì²´ê³„
          echo "âœ… Versioning: GitFlow ìë™ ì ìš©ë¨"

          echo "ğŸ›ï¸ Constitution 5ì›ì¹™ ê²€ì¦ ì™„ë£Œ!"

  # =============================================================================
  # ë°°í¬ ì¤€ë¹„ Job (main ë¸Œëœì¹˜)
  # =============================================================================
  deploy-prepare:
    name: ğŸš€ ë°°í¬ ì¤€ë¹„
    runs-on: ubuntu-latest
    needs: [quality-check, constitution-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ” ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Release Notes ìƒì„±
        run: |
          echo "ğŸ“ ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„± ì¤‘..."

          # ë§ˆì§€ë§‰ íƒœê·¸ ì´í›„ ë³€ê²½ì‚¬í•­ ì¡°íšŒ
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"

          # SPEC ë³€ê²½ì‚¬í•­ ì¶”ì¶œ
          SPEC_CHANGES=$(git log $LAST_TAG..HEAD --oneline --grep="feat(SPEC-" || echo "")
          BUILD_CHANGES=$(git log $LAST_TAG..HEAD --oneline --grep="feat\|test\|refactor" || echo "")

          # Release notes íŒŒì¼ ìƒì„±
          cat > RELEASE_NOTES.md << EOF
          # Release Notes

          ## ğŸ“‹ SPEC ë³€ê²½ì‚¬í•­
          $SPEC_CHANGES

          ## ğŸ”¨ êµ¬í˜„ ë³€ê²½ì‚¬í•­
          $BUILD_CHANGES

          ## ğŸ¯ ìë™ ìƒì„±ë¨
          Generated by MoAI-ADK GitFlow v0.2.1
          EOF

          echo "âœ… Release Notes ìƒì„± ì™„ë£Œ"
          cat RELEASE_NOTES.md

      - name: ğŸ·ï¸ ë²„ì „ íƒœê·¸ ìƒì„±
        if: success()
        run: |
          # ë²„ì „ ìë™ ì¦ê°€ ë¡œì§ (ì˜ˆì‹œ)
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/v//' || echo "0.2.0")
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"

          # íŒ¨ì¹˜ ë²„ì „ ì¦ê°€
          PATCH=$((VERSION_PARTS[2] + 1))
          NEW_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.$PATCH"

          echo "ğŸ·ï¸ ìƒˆ ë²„ì „: v$NEW_VERSION"
          git config user.name "MoAI-ADK Bot"
          git config user.email "moai-adk@noreply.com"
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION - Auto-generated by MoAI-ADK GitFlow"
          git push origin "v$NEW_VERSION"

  # =============================================================================
  # ì•Œë¦¼ ë° ë¦¬í¬íŒ… Job
  # =============================================================================
  notification:
    name: ğŸ“¢ ê²°ê³¼ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [quality-check, constitution-check, test-suite]
    if: always()

    steps:
      - name: ğŸ“Š íŒŒì´í”„ë¼ì¸ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ğŸ¯ MoAI-ADK GitFlow Pipeline ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality-check.result }}" == "success" ]; then
            echo "âœ… **í’ˆì§ˆ ê²€ì¦**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **í’ˆì§ˆ ê²€ì¦**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.constitution-check.result }}" == "success" ]; then
            echo "âœ… **Constitution ê²€ì¦**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.constitution-check.result }}" == "skipped" ]; then
            echo "â­ï¸ **Constitution ê²€ì¦**: ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Constitution ê²€ì¦**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test-suite.result }}" == "success" ]; then
            echo "âœ… **í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-suite.result }}" == "skipped" ]; then
            echo "â­ï¸ **í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸**: ê±´ë„ˆëœ€" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë¸Œëœì¹˜**: \`${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}\`" >> $GITHUB_STEP_SUMMARY
          echo "**ì»¤ë°‹**: \`${GITHUB_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality-check.outputs.spec-id }}" != "" ]; then
            echo "**SPEC ID**: \`${{ needs.quality-check.outputs.spec-id }}\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ¤– MoAI-ADK v0.2.1 GitFlow Pipeline" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ PR ëŒ“ê¸€ ì—…ë°ì´íŠ¸
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const summary = `## ğŸ¯ MoAI-ADK Pipeline ê²°ê³¼

            | ë‹¨ê³„ | ìƒíƒœ | ê²°ê³¼ |
            |------|------|------|
            | í’ˆì§ˆ ê²€ì¦ | ${{ needs.quality-check.result }} | ${{ needs.quality-check.result == 'success' && 'âœ…' || 'âŒ' }} |
            | Constitution | ${{ needs.constitution-check.result }} | ${{ needs.constitution-check.result == 'success' && 'âœ…' || needs.constitution-check.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |
            | í…ŒìŠ¤íŠ¸ | ${{ needs.test-suite.result }} | ${{ needs.test-suite.result == 'success' && 'âœ…' || needs.test-suite.result == 'skipped' && 'â­ï¸' || 'âŒ' }} |

            **ë‹¤ìŒ ë‹¨ê³„**: ${
              '${{ needs.quality-check.outputs.is-spec-branch }}' === 'true'
                ? '/moai:2-build ${{ needs.quality-check.outputs.spec-id }}'
                : 'ë¬¸ì„œ ì—…ë°ì´íŠ¸ ë° ë°°í¬ ì¤€ë¹„'
            }

            ---
            ğŸ¤– MoAI-ADK v0.2.1 GitFlow CI/CD | ì»¤ë°‹: \`${context.sha.substring(0, 7)}\``;

            // ê¸°ì¡´ ëŒ“ê¸€ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(
              comment => comment.body.includes('ğŸ¯ MoAI-ADK Pipeline ê²°ê³¼')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }