name: PR Auto-Update for GitFlow

# MoAI-ADK GitFlow PR ìë™ ì—…ë°ì´íŠ¸
# ì»¤ë°‹ í‘¸ì‹œ ì‹œ ê´€ë ¨ PRì„ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸

on:
  push:
    branches:
      - 'feature/SPEC-*'

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  update-pr:
    name: ğŸ“ PR ìë™ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'

    steps:
      - name: ğŸ” ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“ SPEC ID ë° ë‹¨ê³„ ë¶„ì„
        id: analyze
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch: $BRANCH_NAME"

          # SPEC ID ì¶”ì¶œ
          if [[ $BRANCH_NAME =~ ^feature/SPEC-([0-9]+) ]]; then
            SPEC_ID="SPEC-${BASH_REMATCH[1]}"
            echo "spec-id=$SPEC_ID" >> $GITHUB_OUTPUT
            echo "ğŸ¯ SPEC ID: $SPEC_ID"
          else
            echo "âŒ SPEC ë¸Œëœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤: $BRANCH_NAME"
            exit 1
          fi

          # ìµœê·¼ ì»¤ë°‹ìœ¼ë¡œ ë‹¨ê³„ íŒë‹¨
          COMMIT_MSG="$(git log -1 --pretty=format:'%s')"
          echo "Recent commit: $COMMIT_MSG"

          STAGE="unknown"
          if [[ $COMMIT_MSG =~ feat\($SPEC_ID\):.*initial.*requirements ]]; then
            STAGE="SPEC ì´ˆì•ˆ"
          elif [[ $COMMIT_MSG =~ feat\($SPEC_ID\):.*user.*stories ]]; then
            STAGE="User Stories"
          elif [[ $COMMIT_MSG =~ feat\($SPEC_ID\):.*acceptance.*criteria ]]; then
            STAGE="ìˆ˜ë½ ê¸°ì¤€"
          elif [[ $COMMIT_MSG =~ feat\($SPEC_ID\):.*Complete ]]; then
            STAGE="SPEC ì™„ë£Œ"
          elif [[ $COMMIT_MSG =~ feat\($SPEC_ID\):.*Constitution ]]; then
            STAGE="Constitution ê²€ì¦"
          elif [[ $COMMIT_MSG =~ test\($SPEC_ID\):.*failing.*RED ]]; then
            STAGE="TDD RED"
          elif [[ $COMMIT_MSG =~ feat\($SPEC_ID\):.*GREEN ]]; then
            STAGE="TDD GREEN"
          elif [[ $COMMIT_MSG =~ refactor\($SPEC_ID\):.*REFACTOR ]]; then
            STAGE="TDD REFACTOR"
          elif [[ $COMMIT_MSG =~ docs\($SPEC_ID\): ]]; then
            STAGE="ë¬¸ì„œ ë™ê¸°í™”"
          fi

          echo "stage=$STAGE" >> $GITHUB_OUTPUT
          echo "ğŸ”„ í˜„ì¬ ë‹¨ê³„: $STAGE"

      - name: ğŸ“Š ì§„í–‰ë¥  ê³„ì‚°
        id: progress
        run: |
          SPEC_ID="${{ steps.analyze.outputs.spec-id }}"
          STAGE="${{ steps.analyze.outputs.stage }}"

          # ë‹¨ê³„ë³„ ì§„í–‰ë¥  ë§¤í•‘
          case "$STAGE" in
            "SPEC ì´ˆì•ˆ") PROGRESS=10 ;;
            "User Stories") PROGRESS=20 ;;
            "ìˆ˜ë½ ê¸°ì¤€") PROGRESS=25 ;;
            "SPEC ì™„ë£Œ") PROGRESS=25 ;;
            "Constitution ê²€ì¦") PROGRESS=35 ;;
            "TDD RED") PROGRESS=50 ;;
            "TDD GREEN") PROGRESS=70 ;;
            "TDD REFACTOR") PROGRESS=85 ;;
            "ë¬¸ì„œ ë™ê¸°í™”") PROGRESS=95 ;;
            *) PROGRESS=5 ;;
          esac

          echo "progress=$PROGRESS" >> $GITHUB_OUTPUT
          echo "ğŸ“ˆ ì§„í–‰ë¥ : $PROGRESS%"

      - name: ğŸ¨ PR ì§„í–‰ ìƒíƒœ ë°” ìƒì„±
        id: progress-bar
        run: |
          PROGRESS="${{ steps.progress.outputs.progress }}"

          # ASCII ì§„í–‰ ìƒíƒœ ë°” ìƒì„± (20ê¸€ì)
          FILLED=$((PROGRESS / 5))
          EMPTY=$((20 - FILLED))

          PROGRESS_BAR=""
          for i in $(seq 1 $FILLED); do
            PROGRESS_BAR+="â–ˆ"
          done
          for i in $(seq 1 $EMPTY); do
            PROGRESS_BAR+="â–‘"
          done

          echo "progress-bar=$PROGRESS_BAR" >> $GITHUB_OUTPUT
          echo "Progress bar: $PROGRESS_BAR"

      - name: ğŸ’¬ PR ëŒ“ê¸€ ì—…ë°ì´íŠ¸
        uses: actions/github-script@v6
        with:
          script: |
            const specId = '${{ steps.analyze.outputs.spec-id }}';
            const stage = '${{ steps.analyze.outputs.stage }}';
            const progress = '${{ steps.progress.outputs.progress }}';
            const progressBar = '${{ steps.progress-bar.outputs.progress-bar }}';
            const commitSha = context.sha.substring(0, 7);

            // PR ëª©ë¡ ì¡°íšŒ
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              state: 'open'
            });

            if (prs.data.length === 0) {
              console.log('âŒ ì—°ê´€ëœ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }

            const pr = prs.data[0];
            console.log(`ğŸ“ PR ë°œê²¬: #${pr.number} - ${pr.title}`);

            // ì—…ë°ì´íŠ¸ ëŒ“ê¸€ ë‚´ìš© ìƒì„±
            const updateComment = `## ğŸ”„ ${stage} ë‹¨ê³„ ì™„ë£Œ

            **ì§„í–‰ë¥ **: ${progress}% \`${progressBar}\`

            ### ğŸ“‹ ìµœê·¼ ë³€ê²½ì‚¬í•­
            - **ì»¤ë°‹**: \`${commitSha}\`
            - **ë‹¨ê³„**: ${stage}
            - **ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

            ### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„
            ${
              progress < 25 ? '- SPEC ë¬¸ì„œ ì‘ì„± ê³„ì†' :
              progress < 85 ? '- TDD êµ¬í˜„ ì§„í–‰' :
              '- ë¬¸ì„œ ë™ê¸°í™” ë° PR ì¤€ë¹„'
            }

            ---
            ğŸ¤– MoAI-ADK v0.2.1 ìë™ ì—…ë°ì´íŠ¸ | Branch: \`${context.ref.replace('refs/heads/', '')}\``;

            // ê¸°ì¡´ ìë™ ì—…ë°ì´íŠ¸ ëŒ“ê¸€ ì°¾ê¸°
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });

            const existingComment = comments.data.find(
              comment => comment.body.includes('ğŸ¤– MoAI-ADK v0.2.1 ìë™ ì—…ë°ì´íŠ¸')
            );

            if (existingComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: updateComment
              });
              console.log('âœ… ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } else {
              // ìƒˆ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: updateComment
              });
              console.log('âœ… ìƒˆ ëŒ“ê¸€ ìƒì„± ì™„ë£Œ');
            }

      - name: ğŸ·ï¸ PR ë¼ë²¨ ì—…ë°ì´íŠ¸
        uses: actions/github-script@v6
        with:
          script: |
            const stage = '${{ steps.analyze.outputs.stage }}';
            const progress = parseInt('${{ steps.progress.outputs.progress }}');

            // PR ì¡°íšŒ
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              state: 'open'
            });

            if (prs.data.length === 0) {
              return;
            }

            const pr = prs.data[0];

            // í˜„ì¬ ë¼ë²¨ ì œê±° (progress ê´€ë ¨ë§Œ)
            const currentLabels = pr.labels.map(label => label.name);
            const labelsToRemove = currentLabels.filter(label =>
              label.startsWith('progress:') ||
              label.startsWith('stage:') ||
              label === 'draft' ||
              label === 'ready-for-review'
            );

            // ìƒˆ ë¼ë²¨ ê²°ì •
            const newLabels = [];

            // ì§„í–‰ë¥  ë¼ë²¨
            if (progress < 25) {
              newLabels.push('stage:spec');
              newLabels.push('progress:0-25');
            } else if (progress < 50) {
              newLabels.push('stage:constitution');
              newLabels.push('progress:25-50');
            } else if (progress < 85) {
              newLabels.push('stage:build');
              newLabels.push('progress:50-85');
            } else {
              newLabels.push('stage:sync');
              newLabels.push('progress:85-100');
            }

            // Draft/Ready ìƒíƒœ
            if (progress >= 95) {
              newLabels.push('ready-for-review');
            } else {
              newLabels.push('draft');
            }

            // ë¼ë²¨ ì—…ë°ì´íŠ¸
            const finalLabels = currentLabels
              .filter(label => !labelsToRemove.includes(label))
              .concat(newLabels);

            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: finalLabels
            });

            console.log(`ğŸ·ï¸ ë¼ë²¨ ì—…ë°ì´íŠ¸: ${newLabels.join(', ')}`);

      - name: ğŸ¯ PR Ready ìƒíƒœ ë³€ê²½ (95% ì´ìƒ)
        if: steps.progress.outputs.progress >= 95
        uses: actions/github-script@v6
        with:
          script: |
            // PR ì¡°íšŒ
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              state: 'open'
            });

            if (prs.data.length === 0) {
              return;
            }

            const pr = prs.data[0];

            if (pr.draft) {
              // Draftì—ì„œ Readyë¡œ ë³€ê²½
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                draft: false
              });

              console.log('âœ… PRì´ Ready for Review ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }