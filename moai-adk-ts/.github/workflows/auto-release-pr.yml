name: ğŸš€ Auto Release PR (develop â†’ main)

# develop ë¸Œëœì¹˜ì— release: ì»¤ë°‹ì´ í‘¸ì‹œë˜ë©´ ìë™ìœ¼ë¡œ main PR ìƒì„±
on:
  push:
    branches:
      - develop

jobs:
  create-release-pr:
    # release: ì»¤ë°‹ë§Œ ì²˜ë¦¬
    if: startsWith(github.event.head_commit.message, 'release:')
    runs-on: ubuntu-latest

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë²„ì „ ì •ë³´ ì¶”ì¶œ
        id: version
        working-directory: moai-adk-ts
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ ì œëª© ì¶”ì¶œ
          TITLE=$(git log -1 --pretty=%s)
          echo "title=$TITLE" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ ë¦´ë¦¬ì¦ˆ ë²„ì „: v$VERSION"
          echo "ğŸ“ ì»¤ë°‹: $TITLE"

      - name: PR ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # develop â†’ main PRì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          PR_COUNT=$(gh pr list --base main --head develop --json number --jq 'length')

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ develop â†’ main PRì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ¨ ìƒˆë¡œìš´ PRì„ ìƒì„±í•©ë‹ˆë‹¤"
          fi

      - name: Release PR ìƒì„±
        if: steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: moai-adk-ts
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # CHANGELOGì—ì„œ í•´ë‹¹ ë²„ì „ ì„¹ì…˜ ì¶”ì¶œ
          CHANGELOG_SECTION=$(awk '/^## \['$VERSION'\]/,/^## \[/' CHANGELOG.md | head -n -1)

          # PR ìƒì„±
          gh pr create \
            --base main \
            --head develop \
            --title "ğŸš€ Release v$VERSION" \
            --body "## ğŸ“¦ Release v$VERSION

ì´ PRì€ develop ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì„ mainìœ¼ë¡œ ë¨¸ì§€í•˜ê³  ìë™ ë¦´ë¦¬ì¦ˆë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

### ğŸ“ ë³€ê²½ì‚¬í•­

$CHANGELOG_SECTION

### ğŸ”„ ë¦´ë¦¬ì¦ˆ í”„ë¡œì„¸ìŠ¤

1. âœ… **í’ˆì§ˆ ê²€ì¦ ì™„ë£Œ** (develop ë¸Œëœì¹˜)
   - í…ŒìŠ¤íŠ¸: í†µê³¼
   - ë¦°íŠ¸: í†µê³¼
   - ë¹Œë“œ: ì„±ê³µ

2. ğŸ” **ë¦¬ë·° ìš”ì²­**
   - ì´ PRì„ ë¦¬ë·°í•˜ê³  ìŠ¹ì¸í•´ì£¼ì„¸ìš”
   - ë³€ê²½ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”

3. ğŸš€ **ìë™ ë¦´ë¦¬ì¦ˆ** (ë¨¸ì§€ í›„)
   - npm ìë™ ë°°í¬: \`moai-adk@$VERSION\`
   - GitHub Release ìë™ ìƒì„±
   - íƒœê·¸ ìë™ ìƒì„±: \`v$VERSION\`

### âš ï¸ ì£¼ì˜ì‚¬í•­

- ì´ PRì„ ë¨¸ì§€í•˜ë©´ **ìë™ìœ¼ë¡œ npmì— ë°°í¬**ë©ë‹ˆë‹¤
- npm ë°°í¬ëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (24ì‹œê°„ ë‚´ë§Œ unpublish ê°€ëŠ¥)
- ì‹ ì¤‘í•˜ê²Œ ë¦¬ë·°í•´ì£¼ì„¸ìš”

### ğŸ”— ê´€ë ¨ ë§í¬

- [CHANGELOG.md](https://github.com/modu-ai/moai-adk/blob/develop/moai-adk-ts/CHANGELOG.md#$(echo $VERSION | tr '.' ''))

---

ğŸ¤– ì´ PRì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (GitHub Actions)" \
            --label "release"

          echo "âœ… Release PR ìƒì„± ì™„ë£Œ: develop â†’ main (v$VERSION)"

      - name: ê¸°ì¡´ PR ì—…ë°ì´íŠ¸
        if: steps.check_pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â„¹ï¸ ê¸°ì¡´ PRì´ ì´ë¯¸ ì¡´ì¬í•˜ë¯€ë¡œ ìƒëµí•©ë‹ˆë‹¤"
          echo "ğŸ‘‰ ê¸°ì¡´ PR: https://github.com/modu-ai/moai-adk/pulls?q=is%3Apr+is%3Aopen+base%3Amain+head%3Adevelop"
