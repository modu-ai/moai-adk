name: ğŸ“¦ Release to npm

# develop â†’ main PRì´ ë¨¸ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ
on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  release:
    # PRì´ ë¨¸ì§€ë˜ê³ , develop ë¸Œëœì¹˜ì—ì„œ ì™”ì„ ë•Œë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'develop'
    runs-on: ubuntu-latest

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (íƒœê·¸ í¬í•¨)

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        working-directory: moai-adk-ts
        run: npm ci

      - name: í’ˆì§ˆ ê²€ì¦
        working-directory: moai-adk-ts
        run: |
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npm run test

          echo "ğŸ” ë¦°íŠ¸ ê²€ì‚¬..."
          npm run lint || npx biome check .

          echo "ğŸ—ï¸ ë¹Œë“œ..."
          npm run build

          echo "ğŸ”¤ íƒ€ì… ì²´í¬..."
          npm run type-check

      - name: ë²„ì „ ì •ë³´ ì¶”ì¶œ
        id: version
        working-directory: moai-adk-ts
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ë¦´ë¦¬ì¦ˆ ë²„ì „: v$VERSION"

      - name: íƒœê·¸ ìƒì„± (ì•„ì§ ì—†ìœ¼ë©´)
        working-directory: moai-adk-ts
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! git rev-parse "v$VERSION" >/dev/null 2>&1; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # CHANGELOGì—ì„œ í•´ë‹¹ ë²„ì „ ì„¹ì…˜ ì¶”ì¶œ
            CHANGELOG_SECTION=$(awk '/^## \['$VERSION'\]/,/^## \[/' CHANGELOG.md | head -n -1)

            git tag -a "v$VERSION" -m "v$VERSION

$CHANGELOG_SECTION

Released: $(date -u +%Y-%m-%d)
Commit: $(git rev-parse --short HEAD)"

            git push origin "v$VERSION"
            echo "âœ… íƒœê·¸ v$VERSION ìƒì„± ë° í‘¸ì‹œ ì™„ë£Œ"
          else
            echo "â„¹ï¸ íƒœê·¸ v$VERSION ì´ë¯¸ ì¡´ì¬"
          fi

      - name: npm ë°°í¬
        working-directory: moai-adk-ts
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸ“¦ npmì— ë°°í¬ ì¤‘..."
          npm publish --access public
          echo "âœ… npm ë°°í¬ ì™„ë£Œ: moai-adk@${{ steps.version.outputs.version }}"

      - name: GitHub Release ìƒì„±
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: moai-adk-ts
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # CHANGELOGì—ì„œ í•´ë‹¹ ë²„ì „ ì„¹ì…˜ ì¶”ì¶œ
          CHANGELOG_SECTION=$(awk '/^## \['$VERSION'\]/,/^## \[/' CHANGELOG.md | head -n -1)

          # GitHub Release ìƒì„±
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes "$CHANGELOG_SECTION

## ğŸ“¦ Installation

\`\`\`bash
npm install -g moai-adk@$VERSION
\`\`\`

## ğŸ”— Links
- npm: https://www.npmjs.com/package/moai-adk/v/$VERSION
- Full Changelog: https://github.com/modu-ai/moai-adk/blob/main/moai-adk-ts/CHANGELOG.md

ğŸ¤– Automatically released via GitHub Actions" \
            --latest

          echo "âœ… GitHub Release ìƒì„± ì™„ë£Œ"

      - name: ì•Œë¦¼
        if: success()
        run: |
          echo "ğŸ‰ ë¦´ë¦¬ì¦ˆ v${{ steps.version.outputs.version }} ì™„ë£Œ!"
          echo "ğŸ“¦ npm: https://www.npmjs.com/package/moai-adk/v/${{ steps.version.outputs.version }}"
          echo "ğŸ™ GitHub: https://github.com/modu-ai/moai-adk/releases/tag/v${{ steps.version.outputs.version }}"
