---
name: git:rollback
description: μ²΄ν¬ν¬μΈνΈ κΈ°λ° μ•μ „ν• λ΅¤λ°± - μ΄μ „ μƒνƒλ΅ λλλ¦¬κΈ°
argument-hint: [checkpoint-id|--list|--last|--time]
allowed-tools: Bash(git:*), Read, Write, Glob, Grep
---

# Git λ΅¤λ°± μ‹μ¤ν…

μ²΄ν¬ν¬μΈνΈ κΈ°λ°μΌλ΅ μ•μ „ν•κ² μ΄μ „ μƒνƒλ΅ λλλ¦¬λ” μ‹μ¤ν…μ…λ‹λ‹¤.

## π― ν•µμ‹¬ κΈ°λ¥

### λ‹¤μ–‘ν• λ΅¤λ°± λ°©μ‹
- **μ²΄ν¬ν¬μΈνΈ ID**: νΉμ • μ²΄ν¬ν¬μΈνΈλ΅ μ •ν™•ν• λ³µκµ¬
- **μ‹κ°„ κΈ°λ°**: "10λ¶„ μ „", "1μ‹κ°„ μ „" λ“± μμ—°μ–΄ μ§€μ›
- **μƒλ€μ  μ„μΉ**: λ§μ§€λ§‰, μ΄μ „, Nλ²μ§Έ μ²΄ν¬ν¬μΈνΈ
- **νƒκ·Έ κΈ°λ°**: μ¤‘μ”ν• μ§€μ  (spec μ™„λ£, ν…μ¤νΈ ν†µκ³Ό λ“±)

### μ‚¬μ©λ²•

```bash
# μ²΄ν¬ν¬μΈνΈ λ©λ΅ λ³΄κΈ°
/git:rollback --list

# λ§μ§€λ§‰ μ²΄ν¬ν¬μΈνΈλ΅ λ΅¤λ°±
/git:rollback --last

# νΉμ • μ²΄ν¬ν¬μΈνΈλ΅ λ΅¤λ°±
/git:rollback checkpoint_20250120_153000

# μ‹κ°„ κΈ°λ° λ΅¤λ°±
/git:rollback --time "10λ¶„ μ „"
/git:rollback --time "1μ‹κ°„ μ „"
/git:rollback --time "μ¤λ μ¤μ „"

# νƒκ·Έ κΈ°λ° λ΅¤λ°±
/git:rollback --tag spec-001-complete
/git:rollback --tag test-passing
```

## π“‹ μ‹¤ν–‰ κ³Όμ •

### 1. μ²΄ν¬ν¬μΈνΈ λ©λ΅ μ΅°ν (--list)
```bash
# λ©”νƒ€λ°μ΄ν„° μ½κΈ°
METADATA_FILE=".moai/checkpoints/metadata.json"

# μ²΄ν¬ν¬μΈνΈ λ©λ΅ ν‘μ‹
echo "π“‹ μ‚¬μ© κ°€λ¥ν• μ²΄ν¬ν¬μΈνΈ:"
echo "ID                           μ‹κ°„              λ©”μ‹μ§€                   νμΌμ"
echo "checkpoint_20250120_153000   15:30 (30λ¶„ μ „)   JWT μΈμ¦ λ΅μ§ μ‘μ—… μ¤‘      5"
echo "checkpoint_20250120_150000   15:00 (1μ‹κ°„ μ „)  SPEC-001 λ…μ„Έ μ™„λ£        3"
echo "checkpoint_20250120_140000   14:00 (2μ‹κ°„ μ „)  μ΄κΈ° ν”„λ΅μ νΈ μ„¤μ •        12"
```

### 2. μ•μ „μ„± ν™•μΈ
```bash
# ν„μ¬ μ‘μ—… μƒνƒ ν™•μΈ
if git status --porcelain | grep -q .; then
    echo "β οΈ μ»¤λ°‹λμ§€ μ•μ€ λ³€κ²½μ‚¬ν•­μ΄ μμµλ‹λ‹¤."
    echo "λ‹¤μ μ¤‘ μ„ νƒν•μ„Έμ”:"
    echo "1. ν„μ¬ μƒνƒλ¥Ό μ²΄ν¬ν¬μΈνΈλ΅ μ €μ¥ ν›„ λ΅¤λ°±"
    echo "2. λ³€κ²½μ‚¬ν•­μ„ λ²„λ¦¬κ³  λ΅¤λ°±"
    echo "3. λ΅¤λ°± μ·¨μ†"
fi
```

### 3. λ΅¤λ°± μ‹¤ν–‰
```bash
# μ²΄ν¬ν¬μΈνΈ μ •λ³΄ ν™•μΈ
CHECKPOINT_COMMIT=$(git rev-parse "refs/heads/${CHECKPOINT_ID}")
CHECKPOINT_BRANCH=$(get_checkpoint_branch "${CHECKPOINT_ID}")

# ν„μ¬ μƒνƒ λ°±μ—… (μ„ νƒμ‚¬ν•­)
if [[ "$BACKUP_CURRENT" == "yes" ]]; then
    /git:checkpoint "λ΅¤λ°± μ „ λ°±μ—…: $(date)"
fi

# λ΅¤λ°± μν–‰
git reset --hard "${CHECKPOINT_COMMIT}"

# μ‘μ—… λ””λ ‰ν† λ¦¬ μ •λ¦¬
git clean -fd
```

## π”§ κ³ κΈ‰ λ΅¤λ°± κΈ°λ¥

### μ‹κ°„ κΈ°λ° λ΅¤λ°±
```bash
# μ‹κ°„ νμ‹± ν•¨μ
parse_time_expression() {
    local time_expr="$1"
    case "$time_expr" in
        *"λ¶„ μ „")
            minutes=$(echo "$time_expr" | grep -o '[0-9]\+')
            target_time=$(date -d "-${minutes} minutes" +%s)
            ;;
        *"μ‹κ°„ μ „")
            hours=$(echo "$time_expr" | grep -o '[0-9]\+')
            target_time=$(date -d "-${hours} hours" +%s)
            ;;
        "μ¤λ μ¤μ „")
            target_time=$(date -d "today 09:00" +%s)
            ;;
    esac
}
```

### μ¤λ§νΈ λ§¤μΉ­
```bash
# κ°€μ¥ κ°€κΉμ΄ μ²΄ν¬ν¬μΈνΈ μ°ΎκΈ°
find_closest_checkpoint() {
    local target_time="$1"
    local closest_id=""
    local min_diff=999999999

    while IFS= read -r checkpoint; do
        local cp_time=$(echo "$checkpoint" | jq -r '.timestamp')
        local cp_timestamp=$(date -d "$cp_time" +%s)
        local diff=$((target_time - cp_timestamp))

        if [[ $diff -ge 0 && $diff -lt $min_diff ]]; then
            min_diff=$diff
            closest_id=$(echo "$checkpoint" | jq -r '.id')
        fi
    done < <(jq -c '.checkpoints[]' "$METADATA_FILE")

    echo "$closest_id"
}
```

## π“ λ΅¤λ°± μΆ…λ¥λ³„ νΉμ§•

### 1. μ†ν”„νΈ λ΅¤λ°± (κΈ°λ³Έκ°’)
- **λ³€κ²½μ‚¬ν•­ λ³΄μ΅΄**: μ‘μ—… λ””λ ‰ν† λ¦¬ νμΌ μ μ§€
- **μ¤ν…μ΄μ§• μ΄κΈ°ν™”**: git addλ λ‚΄μ© ν•΄μ 
- **μ•μ „ν• λ³µκµ¬**: μ‹¤μ μ‹ μ‰½κ² λλλ¦¬κΈ° κ°€λ¥

### 2. ν•λ“ λ΅¤λ°± (--hard)
- **μ™„μ „ μ΄κΈ°ν™”**: λ¨λ“  λ³€κ²½μ‚¬ν•­ μ‚­μ 
- **μ •ν™•ν• λ³µκµ¬**: μ²΄ν¬ν¬μΈνΈ μ‹μ κ³Ό λ™μΌν• μƒνƒ
- **μ„ν—μ„± κ²½κ³ **: μ‚­μ λ λ‚΄μ© λ³µκµ¬ λ¶κ°€

### 3. νΌν•© λ΅¤λ°± (--mixed)
- **μ„ νƒμ  λ³µκµ¬**: νΉμ • νμΌλ§ λ΅¤λ°±
- **λ¶€λ¶„ μ μ©**: μΌλ¶€ λ³€κ²½μ‚¬ν•­λ§ λλλ¦¬κΈ°
- **μ„Έλ°€ν• μ μ–΄**: κ³ κΈ‰ μ‚¬μ©μμ©

## π― λ¨λ“λ³„ λ΅¤λ°± μ „λµ

### κ°μΈ λ¨λ“ (Personal Mode)
```bash
# μμ λ΅μ΄ μ‹¤ν— μ§€μ›
- λΉλ²ν• μ²΄ν¬ν¬μΈνΈ ν™μ©
- μ‹¤ν— μ‹¤ν¨ μ‹ μ¦‰μ‹ λ΅¤λ°±
- μ†μ‹¤ μ—†λ” μ•μ „ν• κ°λ°

# λ΅¤λ°± ν›„ μλ™ μ •λ¦¬
- λ¶ν•„μ”ν• μ²΄ν¬ν¬μΈνΈ μ •λ¦¬
- λΈλμΉ νμ¤ν† λ¦¬ μµμ ν™”
```

### ν€ λ¨λ“ (Team Mode)
```bash
# μ‹ μ¤‘ν• λ΅¤λ°± μ²λ¦¬
- ν€μ›μ—κ² λ΅¤λ°± μ‚¬μ‹¤ μ•λ¦Ό
- PR μƒνƒ ν™•μΈ ν›„ λ΅¤λ°±
- μ›κ²© λΈλμΉ λ™κΈ°ν™” κ³ λ ¤

# λ΅¤λ°± μ΄λ ¥ κ΄€λ¦¬
- λ΅¤λ°± μ‚¬μ  λ¬Έμ„ν™”
- ν€ κ³µμ μ© λ΅¤λ°± λ³΄κ³ μ„
```

## π¨ μ•μ „μ¥μΉ λ° κ²€μ¦

### λ΅¤λ°± μ „ κ²€μ¦
```bash
# λΈλμΉ μƒνƒ ν™•μΈ
check_branch_safety() {
    # μ›κ²© λΈλμΉμ™€ λ™κΈ°ν™” μƒνƒ ν™•μΈ
    # μ§„ν–‰ μ¤‘μΈ merge/rebase κ°μ§€
    # λ³΄νΈλ λΈλμΉ μ—¬λ¶€ ν™•μΈ
}

# μ²΄ν¬ν¬μΈνΈ μ ν¨μ„± κ²€μ¦
validate_checkpoint() {
    # μ²΄ν¬ν¬μΈνΈ μ΅΄μ¬ μ—¬λ¶€
    # μ»¤λ°‹ ν•΄μ‹ μ ν¨μ„±
    # λΈλμΉ μ ‘κ·Ό κ°€λ¥μ„±
}
```

### λ΅¤λ°± ν›„ κ²€μ¦
```bash
# λ΅¤λ°± μ„±κ³µ ν™•μΈ
verify_rollback() {
    # νƒ€κ² μ»¤λ°‹μΌλ΅ μ΄λ™ ν™•μΈ
    # μ‘μ—… λ””λ ‰ν† λ¦¬ μƒνƒ κ²€μ¦
    # μ†μ‹¤λ λ°μ΄ν„° μ—†μ ν™•μΈ
}
```

## π“ ν†µκ³„ λ° λ¨λ‹ν„°λ§

### λ΅¤λ°± νμ¤ν† λ¦¬
```json
{
  "rollback_history": [
    {
      "timestamp": "2025-01-20T16:00:00Z",
      "from": "a1b2c3d",
      "to": "checkpoint_20250120_153000",
      "reason": "μ‹¤ν— μ½”λ“ λ΅¤λ°±",
      "mode": "personal",
      "files_affected": 5
    }
  ]
}
```

### λ΅¤λ°± ν¨ν„΄ λ¶„μ„
- μμ£Ό λ΅¤λ°±λλ” νμΌ/μμ—­ μ‹λ³„
- μ‹¤ν— μ„±κ³µλ¥  ν†µκ³„
- κ°λ° ν¨ν„΄ κ°μ„  μ μ•

## π’΅ μ‚¬μ© ν¨ν„΄ λ° ν

### μΌλ°μ μΈ λ΅¤λ°± μ‹λ‚λ¦¬μ¤
```bash
# μ‹¤ν— μ‹¤ν¨ ν›„ λ΅¤λ°±
/git:rollback --last
# β†’ λ§μ§€λ§‰ μ•μ „ν• μƒνƒλ΅ μ¦‰μ‹ λ³µκµ¬

# μλ»λ λ¦¬ν©ν† λ§ λ΅¤λ°±
/git:rollback --tag "refactor-start"
# β†’ λ¦¬ν©ν† λ§ μ‹μ‘ μ „μΌλ΅ λλλ¦¬κΈ°

# νΉμ • μ‹μ μΌλ΅ λ΅¤λ°±
/git:rollback --time "μ μ‹¬ λ¨ΉκΈ° μ „"
# β†’ μμ—°μ–΄λ΅ μ‹μ  μ§€μ •

# μ‹ μ¤‘ν• λ΅¤λ°± (κ²€ν†  ν›„)
/git:rollback --list
/git:rollback checkpoint_20250120_120000
# β†’ λ©λ΅ ν™•μΈ ν›„ μ •ν™•ν• μ²΄ν¬ν¬μΈνΈ μ„ νƒ
```

### Constitution 5μ›μΉ™ μ¤€μ
1. **Simplicity**: ν• λ…λ Ήμ–΄λ΅ λ¨λ“  λ΅¤λ°± μ²λ¦¬
2. **Architecture**: git-managerμ™€ μ²΄κ³„μ  μ—°λ™
3. **Testing**: μ•μ „ν• μ‹¤ν— ν™κ²½ μ κ³µ
4. **Observability**: λ¨λ“  λ΅¤λ°± μ¶”μ  λ° λ΅κΉ…
5. **Versioning**: μ²΄ν¬ν¬μΈνΈ κΈ°λ° λ²„μ „ κ΄€λ¦¬

λ¨λ“  λ΅¤λ°± μ‘μ—…μ€ git-manager μ—μ΄μ „νΈκ°€ μ•μ „ν•κ² μ²λ¦¬ν•©λ‹λ‹¤.