# `/moai:10-ai` - AI Model Agent Orchestration

## Purpose

Alfred가 사용자의 복잡한 추론, 브레인스토밍, 코드 생성 요청을 **OpenAI Codex** 또는 **Google Gemini** CLI로 위임하는 명령어입니다.

Config에서 설정된 AI 모델 에이전트를 자동으로 선택하여 실행합니다.

## Usage

```bash
/moai:10-ai "프롬프트"
/moai:10-ai "복잡한 알고리즘 구현"
/moai:10-ai "React Dashboard 컴포넌트"
```

## How It Works

### 1️⃣ **Model Selection (자동)**

Alfred는 다음 우선순위로 모델을 선택합니다:

1. **Config에서 `preferred_model` 확인**
   - `"native"` → Claude Code 사용 (AI 에이전트 스킵)
   - `"codex"` → OpenAI Codex 사용
   - `"gemini"` → Google Gemini 사용
   - `"auto"` → 작업 유형 기반 자동 선택

2. **Availability Check**
   ```
   ✅ CLI 설치됨? → enabled=true
   ✅ 로그인됨?   → logged_in=true
   ✅ 활성화됨?   → enabled=true
   ```

3. **Fallback Strategy**
   - Level 1: 선택된 모델 시도
   - Level 2: 대체 모델 시도
   - Level 3: Native Claude Code로 복귀

### 2️⃣ **Auto-Selection (preferred_model="auto" 일 때)**

Alfred가 프롬프트를 분석하여 자동으로 선택:

| 키워드/유형 | 선택 모델 | 이유 |
|-----------|---------|------|
| backend, API, algorithm, database | Codex | 복잡한 로직 처리 |
| frontend, React, Vue, UI, design | Gemini | 시각적 생성 최적화 |
| architecture, system design | Codex | 논리적 구조 |
| default | Native | 안전한 기본값 |

### 3️⃣ **Execution & Output**

**선택된 모델 실행**:

```bash
# Codex 실행 (Backend task)
Task(
  subagent_type="ai-codex",
  prompt="user_prompt",
  context={"task_type": "backend"}
)

# Gemini 실행 (Frontend task)
Task(
  subagent_type="ai-gemini",
  prompt="user_prompt",
  context={"task_type": "frontend"}
)
```

**출력 처리**:
- ✅ 생성된 코드/컴포넌트
- ✅ 설명 및 사용법
- ✅ 에러 처리 및 Fallback

---

## Configuration

### Setup (5분)

**1. CLI 설치**:

```bash
# OpenAI Codex
npm i -g @openai/codex
# 또는
brew install codex

# Google Gemini
npm install -g @google/gemini-cli@latest
```

**2. 인증**:

```bash
# Codex (ChatGPT 브라우저 로그인)
codex

# Gemini (Google OAuth)
gemini
```

**3. Config 업데이트** (`.moai/config/config.json`):

```json
{
  "ai_models": {
    "preferred_model": "auto",
    "codex": {
      "enabled": true,
      "installed": true,
      "logged_in": true
    },
    "gemini": {
      "enabled": true,
      "installed": true,
      "logged_in": true
    }
  }
}
```

**또는 개별 설정**:

```json
{
  "ai_models": {
    "preferred_model": "codex"  // Only Codex
  }
}
```

---

## Examples

### Example 1: Backend API 생성 (Codex)

```bash
User: "Create a FastAPI REST API with JWT authentication"

Alfred's Action:
1. preferred_model="auto" 확인
2. "FastAPI, JWT, API" 키워드 → Codex 선택
3. Task(subagent_type="ai-codex", prompt="...")
4. Codex CLI 실행
5. 생성된 코드 + 설명 반환
```

### Example 2: React Dashboard (Gemini)

```bash
User: "/moai:10-ai React Dashboard with Recharts"

Alfred's Action:
1. "React, Dashboard, Recharts" → Gemini 선택
2. Task(subagent_type="ai-gemini", prompt="...")
3. Gemini CLI 실행
4. React 컴포넌트 + Tailwind CSS 반환
```

### Example 3: Architecture Design (Codex)

```bash
User: "Design a microservices architecture for e-commerce"

Alfred's Action:
1. "architecture, microservices" → Codex 선택
2. Codex로 아키텍처 설계 생성
3. 다이어그램 + 설명 제공
```

---

## Error Handling

### Scenario 1: CLI Not Installed

```
❌ Error: Codex CLI not found

Alfred's Action:
1. "installed"=false 감지
2. 사용자에게 설치 가이드 제시
   npm i -g @openai/codex
3. Fallback: Native Claude Code 사용
```

### Scenario 2: Not Authenticated

```
❌ Error: Codex authentication failed

Alfred's Action:
1. "logged_in"=false 감지
2. 로그인 명령어 제시
   codex
3. Fallback: Native Claude Code 사용
```

### Scenario 3: API Rate Limit Exceeded

```
⚠️ Warning: API rate limit exceeded

Alfred's Action:
1. Rate limit 감지
2. 대기 시간 계산 및 표시
3. Native Claude Code로 자동 전환
```

---

## Integration with /moai Workflow

### `/moai:2-run SPEC-ID` (TDD GREEN Phase)

```
RED Phase: Native Claude Code (정확한 테스트)
  ↓
GREEN Phase: AI 모델 에이전트 (빠른 구현)
  ├─ preferred_model="codex" → Backend 코드 생성
  ├─ preferred_model="gemini" → Frontend 코드 생성
  └─ preferred_model="auto" → 작업 유형 기반 자동 선택
  ↓
REFACTOR Phase: Native Claude Code (안전한 리팩토링)
```

### `/moai:1-plan "복잡한 설계"`

Alfred가 필요시 AI 모델에게 상담:
- 아키텍처 설계 → Codex
- UI/UX 설계 → Gemini
- 의사 결정 → 대화형 상담

---

## Advanced Features

### Custom Prompts

**프롬프트 파일 사용**:

```bash
# prompt.txt
Implement user authentication with:
- OAuth 2.0
- JWT tokens
- Refresh token rotation
- Rate limiting

/moai:10-ai @prompt.txt
```

### Model-Specific Prompts

**Codex 특화**:
```bash
/moai:10-ai --model codex "Optimize database query performance"
```

**Gemini 특화**:
```bash
/moai:10-ai --model gemini "Design accessibility-first UI"
```

---

## Cost Estimation

| 모델 | 월간 비용 (50 req/일) | 토큰 가격 |
|------|----------------------|---------|
| Native (Claude Code) | ✅ $0 | 포함됨 |
| Codex | $45 | 0.04¢/1K tokens |
| Gemini | $3.75 | API key free tier |
| Auto (Both) | $48.75 | 최고 성능 |

---

## Quick Reference

| 명령어 | 효과 |
|------|------|
| `/moai:10-ai "prompt"` | auto 모델 선택 |
| `/moai:10-ai --model codex "prompt"` | Codex 강제 사용 |
| `/moai:10-ai --model gemini "prompt"` | Gemini 강제 사용 |
| `/moai:10-ai --help` | 도움말 표시 |
| `/moai:10-ai --status` | 모델 상태 확인 |

---

## See Also

- `moai-ai-codex` - OpenAI Codex CLI Skill
- `moai-ai-gemini` - Google Gemini CLI Skill  
- `.moai/config/config-ai-models.json` - AI Models Configuration
- `/moai:2-run` - TDD Implementation with AI support
- CLAUDE.md - Alfred Execution Rules (Rule X: AI Model Agent Integration)

