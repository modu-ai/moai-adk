---
name: moai-alfred-session-analytics
description: Claude Code session log meta-analysis system for continuous improvement
category: alfred-analytics
freedom_level: 3
---

<!-- @DOC:CLAUDE-PHILOSOPHY-001 -->

# Session Log Meta-Analysis System

MoAI-ADK automatically analyzes Claude Code session logs to continuously improve settings and rules based on data-driven insights.

## Overview

This Skill documents the **Session Log Meta-Analysis System** that:
- Automatically collects session logs from `~/.claude/projects/*/session-*.json`
- Analyzes tool usage, errors, hook failures, and permission requests
- Generates weekly reports in `.moai/reports/weekly-YYYY-MM-DD.md`
- Provides actionable recommendations for improving `.claude/settings.json`, `CLAUDE.md`, and hooks

## Automatic Collection and Analysis

### Session Log Storage Location
- `~/.claude/projects/*/session-*.json` (automatically generated by Claude Code)

### Weekly Analysis (SessionStart Hook)
- **Automatic Trigger**: Checks elapsed days since last analysis on every session start
- **Condition**: If 7+ days have passed, notifies the user
- **Execution**: User manually triggers (only possible on local machine)
- **Output**: Analysis results automatically saved to `.moai/reports/weekly-YYYY-MM-DD.md`

### Why SessionStart Hook?
- GitHub Actions runs on servers and cannot access `~/.claude/projects/` (local files)
- SessionStart hook runs on local machine with access to actual session logs
- User explicitly triggers analysis, optimized for local development environment

## Analysis Categories

### 1. ðŸ“ˆ Tool Usage Patterns
- **TOP 10 Tools**: Most frequently used tools
- **Tool Frequency**: Usage count by tool type
- **Underutilized Tools**: Discovering unexpectedly less-used tools

**Example Insights**:
- "Bash is used 500+ times/week â†’ Consider optimizing Bash permissions"
- "Grep rarely used â†’ Check if search patterns need improvement"

### 2. âš ï¸ Error Patterns
- **Recurring Tool Failures**: Repeated tool execution failures
- **Common Error Messages**: Most frequent error types
- **Error Occurrence Patterns**: When and how errors occur

**Example Insights**:
- "Git permission errors occur 30+ times/week â†’ Update `.claude/settings.json` permissions"
- "File not found errors â†’ Add validation checks in CLAUDE.md"

### 3. ðŸª Hook Failure Analysis
- **SessionStart, PreToolUse, PostToolUse Hook Failures**
- **Failure Frequency and Type**
- **Hook Debugging Needs**

**Example Insights**:
- "PreToolUse hook times out 5+ times/week â†’ Increase timeout or optimize script"
- "PostToolUse fails on large outputs â†’ Add output size limits"

### 4. ðŸ” Permission Request Analysis
- **Most Requested Permissions**: Frequently requested permission types
- **Request Frequency by Permission Type**
- **Need for Permission Setting Review**

**Example Insights**:
- "git push requested 20+ times/week â†’ Move from ask to allow (or keep ask for safety)"
- "rm -rf never requested â†’ Keep in deny (correct setting)"

## Improvement Feedback Loop

### Automatic Recommendations Based on Analysis

```
1ï¸âƒ£ High Permission Request Frequency Detected
   â†“
2ï¸âƒ£ Adjust permissions in .claude/settings.json
   - Change allow â†’ ask
   - Or add new Bash rules
   â†“
3ï¸âƒ£ Error Pattern Detected
   â†“
4ï¸âƒ£ Add avoidance strategies to CLAUDE.md
   - "When X error occurs, try Y"
   - Recommend new Skills or tools
   â†“
5ï¸âƒ£ Hook Failure Detected
   â†“
6ï¸âƒ£ Debug and improve .claude/hooks/
```

### Implementation Flow

**Step 1: Detect Pattern**
```python
# Example: Analyze session logs
analysis = SessionAnalyzer(days=7)
if analysis.permission_requests["git push"] > 20:
    recommendation = "Consider moving 'git push' to allow list"
```

**Step 2: Generate Recommendation**
```markdown
## ðŸ’¡ Recommended Actions

- [ ] Permission: Move "Bash(git push:*)" from ask to allow
- [ ] Error: Add retry logic for "connection timeout" in CLAUDE.md
- [ ] Hook: Increase PreToolUse timeout from 5s to 10s
```

**Step 3: Apply Changes**
```bash
# User reviews recommendations and applies manually
# Or: Use automated PR for settings updates
```

## Manual Analysis Methods

You can also run analysis manually:

```bash
# Analyze last 7 days
python3 .moai/scripts/session_analyzer.py --days 7

# Analyze last 30 days
python3 .moai/scripts/session_analyzer.py --days 30 --verbose

# Save to specific file
python3 .moai/scripts/session_analyzer.py \
  --days 7 \
  --output .moai/reports/custom-analysis.md \
  --verbose
```

### Command Options

- `--days N`: Analyze sessions from last N days (default: 7)
- `--verbose`: Show detailed analysis in console
- `--output PATH`: Save report to custom path (default: `.moai/reports/weekly-YYYY-MM-DD.md`)

## Reading Analysis Reports

Weekly generated reports have the following structure:

```markdown
# MoAI-ADK Session Meta-Analysis Report

## ðŸ“Š Overall Metrics
- Total Sessions: 42
- Success/Failure Ratio: 95% / 5%
- Total Events: 1,247

## ðŸ”§ Tool Usage Patterns
- TOP 10 Tools:
  1. Bash (523 uses)
  2. Read (312 uses)
  3. Write (189 uses)
  ...

## âš ï¸ Tool Error Patterns
- Recurring Errors:
  1. Permission denied (git push) - 15 times
  2. File not found - 8 times
  ...

## ðŸª Hook Failure Analysis
- Failed Hooks:
  1. PreToolUse timeout - 3 times
  2. PostToolUse error - 1 time

## ðŸ’¡ Improvement Recommendations
- **Permission**: Move "git status" to allow list (requested 50+ times, always approved)
- **Error**: Add validation for file existence before Read/Write
- **Hook**: Increase PreToolUse timeout to 10s
```

### Key Sections Explained

1. **Overall Metrics**: High-level session statistics
2. **Tool Usage Patterns**: Which tools are used most/least
3. **Tool Error Patterns**: Repeated failures to address
4. **Hook Failure Analysis**: Hook debugging priorities
5. **Improvement Recommendations**: Specific action items

## Weekly Review Checklist

**Items to Review Every Week**:

- [ ] **New Permission Requests?** â†’ Update `.claude/settings.json`
- [ ] **Recurring Errors?** â†’ Add avoidance strategies to CLAUDE.md
- [ ] **Hook Failures?** â†’ Debug `.claude/hooks/`
- [ ] **Tool Usage Pattern Changes?** â†’ Update tool descriptions
- [ ] **Success Rate Changes?** â†’ Reassess overall rules

### Review Process

**Step 1: Read Weekly Report**
```bash
cat .moai/reports/weekly-2025-11-04.md
```

**Step 2: Prioritize Recommendations**
- High Priority: Errors affecting >10% of sessions
- Medium Priority: Permission requests >20/week
- Low Priority: Tool usage optimization

**Step 3: Apply Changes**
```bash
# Update settings
vim .claude/settings.json

# Update CLAUDE.md
vim CLAUDE.md

# Commit changes
git add .claude/settings.json CLAUDE.md
git commit -m "improve: Apply session analysis recommendations"
```

**Step 4: Verify Next Week**
- Check if applied changes reduced errors
- Confirm permission requests decreased
- Validate success rate improved

## Integration with Alfred Workflow

### When to Invoke This Skill

Alfred should invoke `Skill("moai-alfred-session-analytics")` when:

1. **User requests analysis**: "Analyze my recent sessions", "Show me session stats"
2. **Weekly review**: SessionStart hook notifies after 7 days
3. **Troubleshooting**: Investigating recurring errors or permission issues
4. **Settings optimization**: Deciding what to allow/ask/deny

### Example Invocation

```markdown
User: "I keep getting permission errors. Can you analyze my sessions?"

Alfred: Let me analyze your recent session logs.
â†’ Skill("moai-alfred-session-analytics")
â†’ Runs session analyzer for last 7 days
â†’ Identifies: "git push" requested 25 times, "git commit" requested 18 times
â†’ Recommendation: "Move frequent Git commands to allow list"
```

## Related Skills

- `Skill("moai-alfred-config-advanced")`: Claude Code settings configuration
- `Skill("moai-alfred-autofixes")`: Automatic error fixing protocols
- `Skill("moai-alfred-reporting")`: Reporting style guidelines

## References

- **Session Log Format**: `~/.claude/projects/*/session-*.json`
- **Report Location**: `.moai/reports/weekly-YYYY-MM-DD.md`
- **Analyzer Script**: `.moai/scripts/session_analyzer.py`
- **Hook Implementation**: `.claude/hooks/session-start.py`

---

**Note**: This system continuously improves MoAI-ADK's effectiveness by learning from actual usage patterns.
