# CodeRabbit Configuration File
# https://docs.coderabbit.ai/guides/configure-coderabbit

coderabbit:
  language: python
  framework: general

  # Enable reviews on all branches including develop
  rules:
    - name: "Enable reviews on all branches"
      type: "config"
      enabled: true

  # Review settings
  reviews:
    review_status: true
    review_on_draft: true
    review_comment_lgtm: true

  # Auto-approval settings (Pro feature)
  auto_approve:
    enabled: true
    min_score: 0.75  # Approve if 75%+ quality (optimized for rate limit)

  # Python-specific rules - Optimized for rate limit
  python:
    - check_type_hints: true
    - check_docstrings: true
    - check_pep8: true
    - check_test_coverage: false  # Disable to reduce load

  # SPEC document review rules
  spec_review:
    enabled: true
    files: ".moai/specs/**/spec.md"
    instructions: |
      SPEC Document Review Checklist:

      ## Metadata Validation (YAML Frontmatter)
      - âœ… All 7 required fields present: id, version, status, created, updated, author, priority
      - âœ… ID format correct: DOMAIN-### (e.g., AUTH-001)
      - âœ… Version format: v0.0.1 (initial) or higher
      - âœ… Status valid: draft, in-review, in-progress, completed, stable
      - âœ… Author includes @ prefix (e.g., @username)
      - âœ… Priority valid: critical, high, medium, low

      ## Document Structure
      - âœ… HISTORY section exists immediately after frontmatter
      - âœ… HISTORY entries in reverse chronological order (latest first)
      - âœ… Version history properly documented

      ## EARS Requirements
      - âœ… Ubiquitous requirements defined
      - âœ… Event-driven (WHEN) requirements specified
      - âœ… State-driven (WHILE) requirements included
      - âœ… Constraints (IF) properly defined
      - âœ… Optional features (WHERE) noted if applicable

      ## Acceptance Criteria
      - âœ… At least 2-3 test scenarios (Given-When-Then format)
      - âœ… Clear test preconditions (Given)
      - âœ… Specific actions (When)
      - âœ… Expected outcomes (Then)

      ## Traceability (Quality Tracking)
      - âœ… Related test coverage documented
      - âœ… Related code implementation documented
      - âœ… Related documentation synchronized

      ## Best Practices
      - âœ… Clear and unambiguous language
      - âœ… No spelling or grammar errors
      - âœ… Proper Markdown formatting
      - âœ… Links to related SPECs/issues
      - âœ… Dependencies clearly documented

  # Ignore patterns - Optimize for rate limit
  ignore:
    - "*.md"
    - "*.txt"
    - "docs/"
    - "build/"
    - "dist/"
    - ".git/"
    - "__pycache__/"
    - "*.pyc"
    # Additional ignore patterns to reduce review load
    - ".moai/tmp/"
    - ".moai/reports/"
    - "ANALYSIS_SUMMARY.md"
    - "COMMAND_DOCUMENTATION_STANDARDS.md"
    - "COMMAND_EXAMPLES.md"
    - "DOCUMENTATION_INDEX.md"
      - "package-lock.json"
    - "uv.lock"

  # Review instructions
  instructions: |
    Review this pull request focusing on:

    ## Code Quality
    - Type hints presence and correctness
    - Docstring completeness
    - PEP-8 compliance
    - Code readability and maintainability
    - Design patterns and SOLID principles

    ## Security
    - Vulnerability detection
    - Sensitive data handling
    - Input validation
    - Error handling

    ## Testing
    - Test coverage
    - Edge case handling
    - Test quality and assertions

    ## Performance
    - Algorithm efficiency
    - Resource usage
    - Potential bottlenecks

    ## Documentation
    - Comment clarity
    - README updates
    - Changelog entries

  # Languages to review
  languages:
    - python
    - yaml
    - json
    - markdown

  # Disable review_skip_pattern to enable reviews on all branches
  skip_review_on_forbidden_base_branch: false

  # Changelog generation rules (Automated Release Pipeline)
  changelog:
    enabled: true
    auto_generate_on_release: true
    bilingual_support: true
    languages:
      - ko  # Korean
      - en  # English
    commit_analysis:
      enabled: true
      conventional_commits: true
      scope_mapping:
        feat: "âœ¨ Features"
        fix: "ðŸ› Bug Fixes"
        docs: "ðŸ“š Documentation"
        refactor: "â™»ï¸ Refactoring"
        perf: "âš¡ Performance"
        test: "ðŸ§ª Testing"
        chore: "ðŸ”§ Chore"
        ci: "ðŸ‘· CI/CD"
    template: |
      ## {VERSION} - {RELEASE_DATE}

      ### ðŸ‡°ðŸ‡· í•œêµ­ì–´
      {COMMITS_KO}

      ### ðŸ‡ºðŸ‡¸ English
      {COMMITS_EN}

  # Auto-merge rules for automated version/changelog updates
  auto_merge:
    enabled: true
    conditions:
      - "title_contains: 'chore: Auto-update version'"
      - "title_contains: 'docs: Auto-generated Changelog'"
      - "coderabbit_score >= 0.75"
      - "ci_passing: true"
    delete_branch_on_merge: true
    merge_method: squash  # Squash commits for cleaner history
